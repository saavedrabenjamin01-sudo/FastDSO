{% extends 'base.html' %}
{% block content %}

<div class="dashv1">

  <div class="nomovement-header">
    <div class="nomovement-title-group">
      <a href="{{ url_for('dashboard_category', category=category, window=window_days, store=store_name) }}" class="btn btn-sm btn-outline-secondary me-3">
        <i class="bi bi-arrow-left me-1"></i>Volver
      </a>
      <div>
        <h1 class="nomovement-title"><i class="bi bi-pause-circle me-2"></i>SKUs sin movimiento</h1>
        <p class="nomovement-subtitle">Productos con stock pero sin ventas en la ventana seleccionada</p>
      </div>
    </div>
  </div>

  <div class="nomovement-filters-bar">
    <div class="nomovement-chip"><i class="bi bi-tag me-1"></i>{{ category }}</div>
    <div class="nomovement-chip"><i class="bi bi-calendar me-1"></i>{{ window_days }} días</div>
    {% if store_name %}
    <div class="nomovement-chip"><i class="bi bi-shop me-1"></i>{{ store_name }}</div>
    {% endif %}
  </div>

  <div class="nomovement-kpi-row">
    <div class="nomovement-kpi">
      <div class="nomovement-kpi-icon"><i class="bi bi-exclamation-triangle"></i></div>
      <div class="nomovement-kpi-body">
        <div class="nomovement-kpi-value">{{ total_count }}</div>
        <div class="nomovement-kpi-label">SKUs sin movimiento</div>
      </div>
    </div>
    <div class="nomovement-actions">
      <a href="{{ url_for('category_no_movement_export', category=category, window_days=window_days, store=store_name) }}" class="btn btn-success btn-sm">
        <i class="bi bi-file-earmark-excel me-1"></i>Exportar Excel
      </a>
      <a href="{{ url_for('slow_stock', flagged=1, category=category) }}" class="btn btn-outline-warning btn-sm ms-2">
        <i class="bi bi-eye me-1"></i>Ver en Stock Lento
      </a>
      <button type="button" class="btn btn-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#sendAllModal">
        <i class="bi bi-flag-fill me-1"></i>Enviar TODO a Stock Lento
      </button>
    </div>
  </div>

  {% if items|length > 0 %}
  <div class="nomovement-bulk-actions mb-3">
    <form id="bulk-flag-form" method="POST" action="{{ url_for('flag_slow_stock_bulk') }}" class="d-inline">
      <input type="hidden" name="product_ids" id="bulk-product-ids" value="">
      <input type="hidden" name="return_url" value="{{ url_for('category_no_movement', category=category, window_days=window_days, store=store_name, page=page) }}">
      <button type="submit" class="btn btn-warning btn-sm" id="bulk-flag-btn" disabled>
        <i class="bi bi-flag me-1"></i>Enviar seleccionados
      </button>
    </form>
    <form id="bulk-export-form" method="POST" action="{{ url_for('category_no_movement_export_selected') }}" class="d-inline ms-2">
      <input type="hidden" name="product_ids" id="export-product-ids" value="">
      <input type="hidden" name="category" value="{{ category }}">
      <button type="submit" class="btn btn-outline-success btn-sm" id="bulk-export-btn" disabled>
        <i class="bi bi-download me-1"></i>Exportar seleccionados
      </button>
    </form>
    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="clear-selection-btn" disabled>
      <i class="bi bi-x-circle me-1"></i>Limpiar selección
    </button>
    <span class="nomovement-selection-info ms-2">(<span id="selected-count">0</span> seleccionados)</span>
  </div>
  
  <div class="nomovement-card">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0 nomovement-table">
        <thead>
          <tr>
            <th class="text-center" style="width: 40px;">
              <input type="checkbox" id="select-all" class="form-check-input">
            </th>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Stock CD</th>
            <th class="text-end">Stock Tiendas</th>
            <th class="text-end">Stock Total</th>
            <th>Última venta</th>
            <th>Sugerencia</th>
            <th class="text-center">Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr class="{% if item.flagged %}table-warning{% endif %}">
            <td class="text-center">
              {% if not item.flagged %}
              <input type="checkbox" data-product-id="{{ item.id }}" class="form-check-input row-checkbox">
              {% endif %}
            </td>
            <td class="nomovement-mono">{{ item.sku }}</td>
            <td>{{ item.name or '-' }}</td>
            <td class="text-end">{{ "{:,}".format(item.stock_cd) }}</td>
            <td class="text-end">{{ "{:,}".format(item.stock_stores) }}</td>
            <td class="text-end fw-semibold">{{ "{:,}".format(item.total_stock) }}</td>
            <td class="text-muted">{{ item.last_sale or 'Sin registro' }}</td>
            <td>
              {% if item.stock_cd > item.stock_stores %}
              <span class="suggestion-pill suggestion-redistrib" data-bs-toggle="tooltip" title="Alto stock en CD, bajo en tiendas. Considerar redistribución o evitar compras.">
                <i class="bi bi-arrow-left-right me-1"></i>Redistribuir
              </span>
              {% elif item.stock_stores > 0 %}
              <span class="suggestion-pill suggestion-liquidate" data-bs-toggle="tooltip" title="Stock en tiendas sin ventas. Candidato para liquidación o stock lento.">
                <i class="bi bi-percent me-1"></i>Liquidar
              </span>
              {% else %}
              <span class="suggestion-pill suggestion-flag" data-bs-toggle="tooltip" title="Marcar para gestión de stock lento.">
                <i class="bi bi-flag me-1"></i>Marcar
              </span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if item.flagged %}
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-flag-fill me-1"></i>Marcado
                </span>
                {% if item.risk_score is not none %}
                  {% if item.risk_band == 'HIGH' %}
                  <span class="badge bg-danger ms-1">{{ item.risk_score }}</span>
                  {% elif item.risk_band == 'MEDIUM' %}
                  <span class="badge bg-warning text-dark ms-1">{{ item.risk_score }}</span>
                  {% else %}
                  <span class="badge bg-success ms-1">{{ item.risk_score }}</span>
                  {% endif %}
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                {% if item.flagged %}
                <button type="button" class="btn btn-outline-success action-btn" 
                        data-action="unflag" data-product-id="{{ item.id }}" 
                        title="Rehabilitar">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                {% else %}
                <button type="button" class="btn btn-warning action-btn" 
                        data-action="flag" data-product-id="{{ item.id }}" 
                        title="Enviar a Stock Lento">
                  <i class="bi bi-flag"></i>
                </button>
                {% endif %}
                <a href="{{ url_for('stock_query') }}?sku={{ item.sku }}" class="btn btn-outline-secondary" title="Ver en Stock Query">
                  <i class="bi bi-search"></i>
                </a>
                <a href="{{ url_for('alerts_page') }}?sku={{ item.sku }}" class="btn btn-outline-primary" title="Ver Alertas">
                  <i class="bi bi-bell"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if total_pages > 1 %}
    <div class="nomovement-pagination">
      <nav>
        <ul class="pagination pagination-sm mb-0">
          {% if page > 1 %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('category_no_movement', category=category, window_days=window_days, store=store_name, page=page-1) }}">&laquo;</a>
          </li>
          {% endif %}
          
          {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('category_no_movement', category=category, window_days=window_days, store=store_name, page=p) }}">{{ p }}</a>
            </li>
            {% elif p == page - 3 or p == page + 3 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endfor %}
          
          {% if page < total_pages %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('category_no_movement', category=category, window_days=window_days, store=store_name, page=page+1) }}">&raquo;</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      <span class="nomovement-page-info">Página {{ page }} de {{ total_pages }} ({{ total_count }} SKUs)</span>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="nomovement-empty">
    <div class="nomovement-empty-icon"><i class="bi bi-check-circle"></i></div>
    <div class="nomovement-empty-title">Sin SKUs inmovilizados</div>
    <div class="nomovement-empty-hint">Todos los productos con stock tienen ventas en el período seleccionado</div>
  </div>
  {% endif %}

</div>

<form id="action-form" method="POST" style="display:none;">
  <input type="hidden" name="product_id" id="action-product-id" value="">
</form>

{# Send All Modal #}
<div class="modal fade" id="sendAllModal" tabindex="-1" aria-labelledby="sendAllModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="sendAllModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar acción masiva
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Esta acción marcará <strong>{{ total_count }} SKUs</strong> como stock lento.</p>
        <p class="text-muted small mb-0">Esto evitará que estos productos se incluyan en sugerencias de compra y distribución automática.</p>
        <div class="alert alert-warning mt-3 mb-0">
          <i class="bi bi-info-circle me-1"></i>Filtros activos: <strong>{{ category }}</strong> / {{ window_days }} días{% if store_name %} / {{ store_name }}{% endif %}
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form method="POST" action="{{ url_for('flag_slow_stock_all_no_movement') }}" class="d-inline">
          <input type="hidden" name="category" value="{{ category }}">
          <input type="hidden" name="window_days" value="{{ window_days }}">
          <input type="hidden" name="store" value="{{ store_name }}">
          <input type="hidden" name="return_url" value="{{ url_for('category_no_movement', category=category, window_days=window_days, store=store_name) }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-flag-fill me-1"></i>Confirmar y enviar todos
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.nomovement-header {
  margin-bottom: 20px;
}
.nomovement-title-group {
  display: flex;
  align-items: center;
}
.nomovement-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  display: flex;
  align-items: center;
}
.nomovement-title i { color: #f59e0b; }
.nomovement-subtitle {
  font-size: 0.85rem;
  color: #64748b;
  margin: 4px 0 0 0;
}

.nomovement-filters-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}
.nomovement-chip {
  background: #f1f5f9;
  color: #475569;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 500;
}
.nomovement-chip i { color: #94a3b8; }

.nomovement-kpi-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.nomovement-kpi {
  display: flex;
  align-items: center;
  gap: 14px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px 20px;
}
.nomovement-kpi-icon {
  width: 48px;
  height: 48px;
  background: #fef3c7;
  color: #d97706;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}
.nomovement-kpi-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: #1e293b;
  line-height: 1;
}
.nomovement-kpi-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  color: #64748b;
  font-weight: 600;
}

.nomovement-bulk-actions {
  display: flex;
  align-items: center;
}
.nomovement-selection-info {
  font-size: 0.8rem;
  color: #64748b;
}

.nomovement-card {
  background: #fff;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  overflow: hidden;
}
.nomovement-table thead th {
  background: #f8fafc;
  font-size: 0.7rem;
  text-transform: uppercase;
  color: #64748b;
  font-weight: 600;
  padding: 10px 12px;
  border-bottom: 1px solid #e2e8f0;
}
.nomovement-table tbody td {
  padding: 10px 12px;
  font-size: 0.85rem;
  vertical-align: middle;
}
.nomovement-mono {
  font-family: 'SF Mono', 'Consolas', monospace;
  font-size: 0.8rem;
}

.nomovement-pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-top: 1px solid #e2e8f0;
  background: #f8fafc;
}
.nomovement-page-info {
  font-size: 0.75rem;
  color: #64748b;
}

.nomovement-empty {
  background: #fff;
  border-radius: 12px;
  padding: 60px 20px;
  text-align: center;
  border: 1px dashed #e2e8f0;
}
.nomovement-empty-icon {
  font-size: 3rem;
  color: #10b981;
  margin-bottom: 16px;
}
.nomovement-empty-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
}
.nomovement-empty-hint {
  font-size: 0.875rem;
  color: #94a3b8;
}

.table-warning {
  background-color: #fefce8 !important;
}

/* Suggestion pills */
.suggestion-pill {
  display: inline-flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 500;
  white-space: nowrap;
  cursor: help;
}
.suggestion-redistrib {
  background: #dbeafe;
  color: #1d4ed8;
}
.suggestion-liquidate {
  background: #fce7f3;
  color: #be185d;
}
.suggestion-flag {
  background: #fef3c7;
  color: #b45309;
}

/* Action buttons group */
.nomovement-table .btn-group-sm .btn {
  padding: 0.2rem 0.4rem;
  font-size: 0.75rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
  
  const selectAll = document.getElementById('select-all');
  const rowCheckboxes = document.querySelectorAll('.row-checkbox');
  const bulkBtn = document.getElementById('bulk-flag-btn');
  const bulkExportBtn = document.getElementById('bulk-export-btn');
  const clearSelectionBtn = document.getElementById('clear-selection-btn');
  const selectedCount = document.getElementById('selected-count');
  const bulkProductIds = document.getElementById('bulk-product-ids');
  const exportProductIds = document.getElementById('export-product-ids');
  const actionForm = document.getElementById('action-form');
  const actionProductId = document.getElementById('action-product-id');
  
  function updateSelection() {
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    const count = checkedBoxes.length;
    selectedCount.textContent = count;
    
    const hasSelection = count > 0;
    bulkBtn.disabled = !hasSelection;
    bulkExportBtn.disabled = !hasSelection;
    clearSelectionBtn.disabled = !hasSelection;
    
    const ids = Array.from(checkedBoxes).map(cb => cb.dataset.productId);
    const idsStr = ids.join(',');
    bulkProductIds.value = idsStr;
    exportProductIds.value = idsStr;
  }
  
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      rowCheckboxes.forEach(cb => cb.checked = this.checked);
      updateSelection();
    });
  }
  
  rowCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateSelection);
  });
  
  if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', function() {
      rowCheckboxes.forEach(cb => cb.checked = false);
      if (selectAll) selectAll.checked = false;
      updateSelection();
    });
  }
  
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const action = this.dataset.action;
      const productId = this.dataset.productId;
      
      actionProductId.value = productId;
      
      if (action === 'flag') {
        actionForm.action = "{{ url_for('flag_slow_stock') }}";
      } else {
        actionForm.action = "{{ url_for('unflag_slow_stock') }}";
      }
      
      actionForm.submit();
    });
  });
});
</script>
{% endblock %}
