{% extends "base.html" %}

{% block title %}Índice de Salud de Tiendas{% endblock %}
{% block page_title %}Índice de Salud de Tiendas{% endblock %}

{% macro pagination_controls(pag, page_param) %}
<div class="health-pagination">
  <small class="text-muted">{{ pag.total }} tiendas</small>
  {% if pag.pages > 1 %}
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if not pag.has_prev %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.prev_num or 1 }})">Ant</a>
        </li>
        {% for p in pag.iter_pages() %}
          {% if p %}
            <li class="page-item {% if p == pag.page %}active{% endif %}">
              <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ p }})">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pag.has_next %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.next_num or pag.pages }})">Sig</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endmacro %}

{% macro status_badge(status) %}
{% if status == 'HEALTHY' %}
<span class="health-badge health-badge-green">Saludable</span>
{% elif status == 'WARNING' %}
<span class="health-badge health-badge-yellow">Atención</span>
{% else %}
<span class="health-badge health-badge-red">Crítico</span>
{% endif %}
{% endmacro %}

{% macro score_bar(score) %}
<div class="health-score-bar">
  <div class="health-score-fill {% if score >= 70 %}fill-green{% elif score >= 45 %}fill-yellow{% else %}fill-red{% endif %}" style="width: {{ score }}%"></div>
  <span class="health-score-value">{{ score }}</span>
</div>
{% endmacro %}

{% macro mini_bar(value, max_val, color_class) %}
<div class="mini-bar-wrap">
  <div class="mini-bar {% if color_class %}{{ color_class }}{% else %}mini-bar-blue{% endif %}" style="width: {% if max_val > 0 %}{{ (value / max_val * 100)|round(1) }}%{% else %}0{% endif %}"></div>
  <span class="mini-bar-val">{{ value }}%</span>
</div>
{% endmacro %}

{% macro suggestion_pill(suggestion) %}
<a href="{{ suggestion.action_url }}" class="suggestion-pill suggestion-{{ suggestion.type|lower }}" title="{{ suggestion.description }}">
  {% if suggestion.type == 'REPLENISH' %}<i class="bi bi-box-arrow-in-down me-1"></i>
  {% elif suggestion.type == 'REDISTRIBUTE' %}<i class="bi bi-arrow-left-right me-1"></i>
  {% else %}<i class="bi bi-clock-history me-1"></i>{% endif %}
  {{ suggestion.title }}
</a>
{% endmacro %}

{% block content %}
<div class="health-wrap">
  <div class="health-header">
    <h1 class="health-title">Índice de Salud de Tiendas</h1>
    <p class="health-subtitle">Diagnóstico integral por tienda para priorizar acciones de gestión</p>
  </div>

  <div class="health-filter-bar">
    <div class="health-filter-group">
      <label class="health-filter-label"><i class="bi bi-tag me-1"></i>Categoría</label>
      <select class="form-select form-select-sm health-filter-select" id="categoryFilter" onchange="updateParam('category', this.value)">
        <option value="">Todas las categorías</option>
        {% for cat in categories %}
        <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="health-filter-group">
      <label class="health-filter-label"><i class="bi bi-calendar3 me-1"></i>Ventana</label>
      <select class="form-select form-select-sm health-filter-select" id="windowFilter" onchange="updateParam('window', this.value)">
        <option value="4" {% if time_window == 4 %}selected{% endif %}>4 semanas</option>
        <option value="8" {% if time_window == 8 %}selected{% endif %}>8 semanas</option>
        <option value="12" {% if time_window == 12 %}selected{% endif %}>12 semanas</option>
        <option value="26" {% if time_window == 26 %}selected{% endif %}>26 semanas</option>
      </select>
    </div>
    <div class="health-filter-group">
      <label class="health-filter-label"><i class="bi bi-shop me-1"></i>Tienda</label>
      <select class="form-select form-select-sm health-filter-select" id="storeFilter" onchange="updateParam('store', this.value)">
        <option value="">Todas las tiendas</option>
        {% for st in all_stores %}
        <option value="{{ st.name }}" {% if store_filter == st.name %}selected{% endif %}>{{ st.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% if category_filter or store_filter %}
    <a href="{{ url_for('store_health') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-circle me-1"></i>Limpiar filtros</a>
    {% endif %}
  </div>

  {% if results and results.summary %}
  {% if not results.summary.has_sales_data %}
  <div class="health-alert health-alert-warning">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Sin datos de ventas:</strong> No hay registros de ventas recientes. El puntaje de salud se calcula sin la métrica de velocidad de ventas. Carga datos de ventas para obtener un diagnóstico completo.
  </div>
  {% endif %}
  <div class="health-kpi-row">
    <div class="health-kpi-card health-kpi-blue">
      <div class="health-kpi-badge">
        <i class="bi bi-shop-window"></i>
      </div>
      <div class="health-kpi-content">
        <div class="health-kpi-value">{{ results.summary.total_stores }}</div>
        <div class="health-kpi-label">Total Tiendas</div>
      </div>
    </div>
    <div class="health-kpi-card health-kpi-green">
      <div class="health-kpi-badge">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="health-kpi-content">
        <div class="health-kpi-value">{{ results.summary.healthy_count }}</div>
        <div class="health-kpi-label">Saludables (≥70)</div>
        <div class="health-kpi-pct">{{ results.summary.healthy_pct }}%</div>
      </div>
    </div>
    <div class="health-kpi-card health-kpi-yellow">
      <div class="health-kpi-badge">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <div class="health-kpi-content">
        <div class="health-kpi-value">{{ results.summary.warning_count }}</div>
        <div class="health-kpi-label">Atención (45-69)</div>
        <div class="health-kpi-pct">{{ results.summary.warning_pct }}%</div>
      </div>
    </div>
    <div class="health-kpi-card health-kpi-red">
      <div class="health-kpi-badge">
        <i class="bi bi-x-octagon"></i>
      </div>
      <div class="health-kpi-content">
        <div class="health-kpi-value">{{ results.summary.critical_count }}</div>
        <div class="health-kpi-label">Críticos (&lt;45)</div>
        <div class="health-kpi-pct">{{ results.summary.critical_pct }}%</div>
      </div>
    </div>
    <div class="health-kpi-card health-kpi-purple">
      <div class="health-kpi-badge">
        <i class="bi bi-speedometer2"></i>
      </div>
      <div class="health-kpi-content">
        <div class="health-kpi-value">{{ results.summary.avg_score }}</div>
        <div class="health-kpi-label">Puntaje Promedio</div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="health-scope-card">
    <div class="health-scope-header">
      <div class="health-scope-title">
        <i class="bi bi-funnel me-2"></i>Alcance de SKUs
        <span class="health-scope-info" title="La salud de tiendas se mide contra el surtido activo, no el catálogo completo. Esto evita penalizar tiendas por SKUs que no deberían tener.">
          <i class="bi bi-info-circle"></i>
        </span>
      </div>
      <div class="health-scope-selector">
        <button type="button" class="health-scope-btn {% if sku_scope == 'core' %}active{% endif %}" onclick="updateParam('scope', 'core')">
          <i class="bi bi-star me-1"></i>Surtido Activo
        </button>
        <button type="button" class="health-scope-btn {% if sku_scope == 'runs' %}active{% endif %}" onclick="updateParam('scope', 'runs')">
          <i class="bi bi-box-arrow-in-right me-1"></i>SKUs en Corridas
        </button>
        <button type="button" class="health-scope-btn {% if sku_scope == 'full' %}active{% endif %}" onclick="updateParam('scope', 'full')">
          <i class="bi bi-collection me-1"></i>Catálogo Completo
        </button>
      </div>
    </div>
    {% if results and results.scope_info %}
    <div class="health-scope-stats">
      <div class="health-scope-stat health-scope-stat-primary">
        <div class="health-scope-stat-value">{{ results.scope_info.skus_in_scope }}</div>
        <div class="health-scope-stat-label">SKUs en alcance</div>
      </div>
      <div class="health-scope-stat health-scope-stat-muted">
        <div class="health-scope-stat-value">{{ results.scope_info.skus_excluded }}</div>
        <div class="health-scope-stat-label">SKUs excluidos</div>
      </div>
      <div class="health-scope-stat health-scope-stat-info">
        <div class="health-scope-stat-value">{{ results.scope_info.total_catalog }}</div>
        <div class="health-scope-stat-label">Total catálogo</div>
      </div>
      {% if results.scope_info.skus_excluded > 0 %}
      <div class="health-scope-reasons">
        <span class="health-scope-reason"><i class="bi bi-box me-1"></i>{{ results.scope_info.excluded_cd_only }} solo en CD</span>
        <span class="health-scope-reason"><i class="bi bi-x-circle me-1"></i>{{ results.scope_info.excluded_no_store_stock }} sin stock tiendas</span>
        <span class="health-scope-reason"><i class="bi bi-calendar-x me-1"></i>{{ results.scope_info.excluded_no_runs }} sin corridas recientes</span>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="health-card health-weights-card">
    <div class="health-card-header">
      <i class="bi bi-sliders me-2"></i>Ponderación de Métricas
    </div>
    <div class="health-card-body">
      <form method="GET" action="{{ url_for('store_health') }}" id="weightsForm">
        <input type="hidden" name="scope" value="{{ sku_scope }}" />
        <div class="health-weights-grid">
          <div class="health-weight-field">
            <label class="health-label">Fill Rate</label>
            <div class="input-group input-group-sm">
              <input type="number" name="w_fill" class="form-control" min="0" max="100" step="5" value="{{ (weights.FILL_RATE * 100)|int }}">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="health-weight-field">
            <label class="health-label">Quiebres</label>
            <div class="input-group input-group-sm">
              <input type="number" name="w_stockout" class="form-control" min="0" max="100" step="5" value="{{ (weights.STOCKOUT_RATE * 100)|int }}">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="health-weight-field">
            <label class="health-label">Sobrestock</label>
            <div class="input-group input-group-sm">
              <input type="number" name="w_overstock" class="form-control" min="0" max="100" step="5" value="{{ (weights.OVERSTOCK_RATE * 100)|int }}">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="health-weight-field">
            <label class="health-label">Velocidad Venta</label>
            <div class="input-group input-group-sm">
              <input type="number" name="w_velocity" class="form-control" min="0" max="100" step="5" value="{{ (weights.SALES_VELOCITY * 100)|int }}">
              <span class="input-group-text">%</span>
            </div>
          </div>
        </div>
        <div class="health-weights-actions">
          <button type="submit" class="btn btn-sm health-btn-primary">
            <i class="bi bi-arrow-clockwise me-1"></i>Recalcular
          </button>
          <a href="{{ url_for('store_health') }}" class="btn btn-sm health-btn-secondary">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Restablecer
          </a>
          <a href="{{ url_for('export_store_health', scope=sku_scope) }}" class="btn btn-sm health-btn-export">
            <i class="bi bi-download me-1"></i>Exportar Excel
          </a>
        </div>
      </form>
    </div>
    <div class="health-weights-hint">
      <i class="bi bi-info-circle me-1"></i>La suma de ponderaciones debe ser 100%. Ajusta según prioridades de negocio.
    </div>
  </div>

  {% if results and results.stores %}
  <div class="health-card health-table-card">
    <div class="health-table-header">
      <div class="health-table-title">
        <i class="bi bi-bar-chart-line me-2"></i>Ranking de Tiendas
        {% if category_filter %}<span class="badge bg-info ms-2">{{ category_filter }}</span>{% endif %}
      </div>
      <div class="health-sort-controls">
        <label class="health-sort-label">Ordenar por:</label>
        <select class="form-select form-select-sm" id="sortSelect" onchange="applySort()">
          <option value="score" {% if sort_by == 'score' %}selected{% endif %}>Puntaje</option>
          <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nombre</option>
          <option value="fill" {% if sort_by == 'fill' %}selected{% endif %}>Fill Rate</option>
          <option value="break" {% if sort_by == 'break' %}selected{% endif %}>Quiebres</option>
        </select>
        <button type="button" class="btn btn-sm health-btn-sort" onclick="toggleOrder()">
          <i class="bi bi-sort-{% if sort_order == 'desc' %}down{% else %}up{% endif %}"></i>
        </button>
      </div>
    </div>
    <div class="health-table-wrap">
      <table class="health-table">
        <thead>
          <tr>
            <th></th>
            <th>Tienda</th>
            <th class="text-center">Puntaje</th>
            <th class="text-center">Estado</th>
            <th class="text-center">Fill Rate</th>
            <th class="text-center">Quiebres</th>
            <th class="text-center">Sobrestock</th>
            <th class="text-center">Sin Mov.</th>
            <th>Acciones Sugeridas</th>
          </tr>
        </thead>
        <tbody>
          {% if pag and pag.items %}
          {% for store in pag.items %}
          <tr class="health-row {% if store.status == 'CRITICAL' %}row-critical{% elif store.status == 'WARNING' %}row-warning{% endif %}" data-store="{{ store.store_id }}">
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-link p-0 health-expand-btn" onclick="toggleDrilldown('{{ store.store_id }}')">
                <i class="bi bi-chevron-down" id="expand-icon-{{ store.store_id }}"></i>
              </button>
            </td>
            <td class="fw-medium">{{ store.store_name }}</td>
            <td class="text-center">{{ score_bar(store.health_score) }}</td>
            <td class="text-center">{{ status_badge(store.status) }}</td>
            <td class="text-center">{{ mini_bar(store.fill_rate, 100, 'mini-bar-green' if store.fill_rate >= 80 else 'mini-bar-yellow' if store.fill_rate >= 60 else 'mini-bar-red') }}</td>
            <td class="text-center">{{ mini_bar(store.break_rate, 50, 'mini-bar-red' if store.break_rate > 15 else 'mini-bar-yellow' if store.break_rate > 5 else 'mini-bar-green') }}</td>
            <td class="text-center">{{ mini_bar(store.overstock_rate, 50, 'mini-bar-yellow' if store.overstock_rate > 15 else 'mini-bar-green') }}</td>
            <td class="text-center">{{ mini_bar(store.no_movement_rate, 50, 'mini-bar-gray' if store.no_movement_rate > 20 else 'mini-bar-green') }}</td>
            <td>
              {% if store.suggestions %}
              <div class="suggestion-pills">
                {% for sug in store.suggestions %}{{ suggestion_pill(sug) }}{% endfor %}
              </div>
              {% else %}
              <span class="text-muted small">Sin acciones urgentes</span>
              {% endif %}
            </td>
          </tr>
          <tr class="health-drilldown" id="drilldown-{{ store.store_id }}" style="display: none;">
            <td colspan="9">
              <div class="drilldown-panel">
                <div class="drilldown-grid">
                  {% if store.break_skus %}
                  <div class="drilldown-section drilldown-section-danger">
                    <div class="drilldown-section-title"><i class="bi bi-exclamation-triangle me-1"></i>SKUs con Quiebre ({{ store.break_count }})</div>
                    <table class="drilldown-table">
                      <thead><tr><th>SKU</th><th>Producto</th><th>Demanda/Sem</th></tr></thead>
                      <tbody>
                        {% for sku in store.break_skus[:5] %}
                        <tr><td><code>{{ sku.sku }}</code></td><td class="text-truncate-cell" title="{{ sku.name }}">{{ sku.name }}</td><td class="text-end">{{ sku.demand_weekly }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% if store.break_count > 5 %}<div class="drilldown-more"><a href="{{ url_for('alerts') }}?store={{ store.store_id }}&type=BREAKAGE">Ver todos</a></div>{% endif %}
                  </div>
                  {% endif %}
                  {% if store.overstock_skus %}
                  <div class="drilldown-section drilldown-section-warning">
                    <div class="drilldown-section-title"><i class="bi bi-box-seam me-1"></i>SKUs con Sobrestock ({{ store.overstock_count }})</div>
                    <table class="drilldown-table">
                      <thead><tr><th>SKU</th><th>Stock</th><th>WoC</th></tr></thead>
                      <tbody>
                        {% for sku in store.overstock_skus[:5] %}
                        <tr><td><code>{{ sku.sku }}</code></td><td class="text-end">{{ sku.stock }}</td><td class="text-end">{{ sku.woc }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% if store.overstock_count > 5 %}<div class="drilldown-more"><a href="{{ url_for('rebalancing') }}?from_store={{ store.store_id }}">Ver todos</a></div>{% endif %}
                  </div>
                  {% endif %}
                  {% if store.no_movement_skus %}
                  <div class="drilldown-section drilldown-section-muted">
                    <div class="drilldown-section-title"><i class="bi bi-clock-history me-1"></i>SKUs Sin Movimiento ({{ store.no_movement_count }})</div>
                    <table class="drilldown-table">
                      <thead><tr><th>SKU</th><th>Producto</th><th>Stock</th></tr></thead>
                      <tbody>
                        {% for sku in store.no_movement_skus[:5] %}
                        <tr><td><code>{{ sku.sku }}</code></td><td class="text-truncate-cell" title="{{ sku.name }}">{{ sku.name }}</td><td class="text-end">{{ sku.stock }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% if store.no_movement_count > 5 %}<div class="drilldown-more"><a href="{{ url_for('slow_stock') }}?store={{ store.store_id }}">Ver todos</a></div>{% endif %}
                  </div>
                  {% endif %}
                </div>
                <div class="drilldown-stats">
                  <span class="drilldown-stat"><strong>Demanda semanal:</strong> {{ store.total_demand }} u.</span>
                  <span class="drilldown-stat"><strong>Velocidad:</strong> {{ store.velocity_score }}% vs cadena</span>
                  <span class="drilldown-stat"><strong>Redistrib.:</strong> {{ store.redist_dependency }} SKUs</span>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="9">
              <div class="health-empty-table">
                <i class="bi bi-shop"></i>
                <div>Sin datos de tiendas</div>
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {% if pag and pag.total > 0 %}
    <div class="health-table-footer">
      {{ pagination_controls(pag, 'page') }}
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="health-empty-state">
    <div class="health-empty-icon"><i class="bi bi-shop-window"></i></div>
    <div class="health-empty-title">Sin datos disponibles</div>
    <div class="health-empty-text">Carga datos de tiendas, productos y ventas para calcular el índice de salud.</div>
  </div>
  {% endif %}

  <div class="health-legend-card">
    <div class="health-legend-title">
      <i class="bi bi-info-circle me-2"></i>Fórmula de Cálculo (Ponderada por Demanda)
    </div>
    <div class="health-legend-content">
      <div class="health-formula">
        <strong>Puntaje = </strong>
        <span class="formula-term">100</span> −
        <span class="formula-term formula-danger">45 × Tasa Quiebre</span> −
        <span class="formula-term formula-warning">25 × (1 − Fill Rate)</span> −
        <span class="formula-term formula-info">20 × Tasa Sobrestock</span> −
        <span class="formula-term formula-muted">10 × Tasa Sin Mov.</span>
      </div>
      <div class="health-metrics-desc">
        <div><strong>Fill Rate (demanda):</strong> % de demanda cubierta según stock vs cobertura objetivo</div>
        <div><strong>Tasa Quiebre:</strong> % de demanda perdida por SKUs sin stock</div>
        <div><strong>Tasa Sobrestock:</strong> % de demanda en SKUs con WoC > {{ default_weights.MAX_WOC }}</div>
        <div><strong>Tasa Sin Mov.:</strong> % de stock en unidades sin demanda reciente</div>
      </div>
      <div class="health-thresholds mt-2">
        <span class="health-threshold health-threshold-green"><i class="bi bi-check-circle me-1"></i>Saludable ≥ 70</span>
        <span class="health-threshold health-threshold-yellow"><i class="bi bi-exclamation-triangle me-1"></i>Atención 45–69</span>
        <span class="health-threshold health-threshold-red"><i class="bi bi-x-octagon me-1"></i>Crítico &lt; 45</span>
      </div>
    </div>
  </div>
</div>

<script>
function updateParam(param, value) {
  const url = new URL(window.location.href);
  url.searchParams.set(param, value);
  if (param !== 'page') url.searchParams.delete('page');
  window.location.href = url.toString();
}

function applySort() {
  const sort = document.getElementById('sortSelect').value;
  updateParam('sort', sort);
}

function toggleOrder() {
  const url = new URL(window.location.href);
  const current = url.searchParams.get('order') || 'asc';
  updateParam('order', current === 'desc' ? 'asc' : 'desc');
}

function toggleDrilldown(storeId) {
  const row = document.getElementById('drilldown-' + storeId);
  const icon = document.getElementById('expand-icon-' + storeId);
  if (row.style.display === 'none') {
    row.style.display = 'table-row';
    icon.classList.remove('bi-chevron-down');
    icon.classList.add('bi-chevron-up');
  } else {
    row.style.display = 'none';
    icon.classList.remove('bi-chevron-up');
    icon.classList.add('bi-chevron-down');
  }
}
</script>
{% endblock %}
