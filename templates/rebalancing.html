{% extends "base.html" %}

{% block title %}Redistribución Tienda-Tienda{% endblock %}
{% block page_title %}Redistribución Tienda-Tienda{% endblock %}

{% block content %}
<div class="rebal-wrap">
  <div class="rebal-header">
    <h1 class="rebal-title">Redistribución Tienda-Tienda</h1>
    <p class="rebal-subtitle">Optimiza el balance de inventario entre tiendas según demanda y reglas de WOC</p>
  </div>

  {% if run_info %}
  {% if run_info.is_simulation %}
  <div class="rebal-alert rebal-alert-warning">
    <div class="rebal-alert-icon"><i class="bi bi-lightning-charge-fill"></i></div>
    <div class="rebal-alert-content">
      <strong>MODO SIMULACIÓN:</strong> Estos resultados no se guardaron en la base de datos.
      <span class="rebal-alert-meta">Generado: {{ run_info.created_at.strftime('%Y-%m-%d %H:%M') if run_info.created_at else 'N/A' }}</span>
    </div>
    <a href="{{ url_for('clear_simulation_route', sim_type='rebalancing', redirect='rebalancing') }}" class="btn btn-sm rebal-btn-clear">
      <i class="bi bi-x-circle me-1"></i>Limpiar simulación
    </a>
  </div>
  {% else %}
  <div class="rebal-alert rebal-alert-info">
    <div class="rebal-alert-icon"><i class="bi bi-check-circle-fill"></i></div>
    <div class="rebal-alert-content">
      <strong>Última corrida:</strong> {{ run_info.created_at.strftime('%Y-%m-%d %H:%M') if run_info.created_at else 'N/A' }}
      <span class="rebal-alert-meta">ID: {{ run_info.run_id[:8] }}...</span>
    </div>
  </div>
  {% endif %}
  {% endif %}

  <div class="rebal-card rebal-params-card">
    <div class="rebal-card-header">
      <i class="bi bi-sliders me-2"></i>Parámetros de Redistribución
    </div>
    <div class="rebal-card-body">
      <form method="POST" action="{{ url_for('rebalancing') }}" id="rebalancingForm"
            data-loader="true"
            data-loader-title="Procesando Redistribución"
            data-loader-msg="Evaluando stock de tiendas y generando transferencias sugeridas..."
            data-loader-icon="store-transfer">
        
        <div class="rebal-params-grid">
          <div class="rebal-field">
            <label class="rebal-label">Tienda destino</label>
            <select name="store_filter" class="form-select">
              <option value="">-- Todas --</option>
              {% for store in stores %}
              <option value="{{ store.name }}" {% if params.store_filter == store.name %}selected{% endif %}>{{ store.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Semanas historial</label>
            <select name="weeks_window" class="form-select">
              {% for w in [2,4,8,12] %}
              <option value="{{ w }}" {% if params.weeks_window == w %}selected{% endif %}>{{ w }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Mín <small class="text-muted">(riesgo)</small></label>
            <input type="number" step="0.1" name="target_woc_min" class="form-control" value="{{ params.target_woc_min }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Objetivo</label>
            <input type="number" step="0.1" name="target_woc_target" class="form-control" value="{{ params.target_woc_target }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Máx <small class="text-muted">(exceso)</small></label>
            <input type="number" step="0.1" name="target_woc_max" class="form-control" value="{{ params.target_woc_max }}">
          </div>
        </div>

        <div class="rebal-params-grid rebal-params-grid-row2">
          <div class="rebal-field">
            <label class="rebal-label">Retener WOC</label>
            <input type="number" step="0.1" name="retain_woc" class="form-control" value="{{ params.retain_woc }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Stock mínimo</label>
            <input type="number" name="stock_floor" class="form-control" value="{{ params.stock_floor }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Transf. mínima</label>
            <input type="number" name="min_transfer_qty" class="form-control" value="{{ params.min_transfer_qty }}">
          </div>
        </div>

        <div class="rebal-actions">
          {% if current_user.has_permission('rebalancing:run') %}
          <label class="rebal-simulate-check">
            <input type="checkbox" name="simulate" value="1" id="simulateCheck">
            <span><i class="bi bi-lightning me-1"></i>Simular (no guardar)</span>
          </label>
          <button type="submit" class="btn rebal-btn-primary">
            <i class="bi bi-play-circle me-1"></i>Generar sugerencias
          </button>
          {% endif %}
          {% if run_info and not run_info.is_simulation %}
          <a href="{{ url_for('export_rebalancing', run_id=run_info.run_id) }}" class="btn rebal-btn-secondary">
            <i class="bi bi-download me-1"></i>Exportar Excel
          </a>
          {% elif run_info and run_info.is_simulation %}
          <a href="{{ url_for('export_simulation', sim_type='rebalancing') }}" class="btn rebal-btn-warning">
            <i class="bi bi-download me-1"></i>Exportar Simulación
          </a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="rebal-params-hint">
      <i class="bi bi-info-circle me-1"></i>Estos parámetros controlan la selección de tiendas donantes y receptoras.
    </div>
  </div>

  <div class="rebal-kpi-row">
    <div class="rebal-kpi-card rebal-kpi-blue">
      <div class="rebal-kpi-badge">
        <i class="bi bi-box-seam"></i>
      </div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.total_units | default(0) }}</div>
        <div class="rebal-kpi-label">Unidades a transferir</div>
      </div>
      <div class="rebal-kpi-deco"></div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-green">
      <div class="rebal-kpi-badge">
        <i class="bi bi-arrow-left-right"></i>
      </div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_moves | default(0) }}</div>
        <div class="rebal-kpi-label">Movimientos sugeridos</div>
      </div>
      <div class="rebal-kpi-deco"></div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-cyan">
      <div class="rebal-kpi-badge">
        <i class="bi bi-upc-scan"></i>
      </div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_skus | default(0) }}</div>
        <div class="rebal-kpi-label">SKUs afectados</div>
      </div>
      <div class="rebal-kpi-deco"></div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-amber">
      <div class="rebal-kpi-badge">
        <i class="bi bi-shop"></i>
      </div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_receivers | default(0) }}</div>
        <div class="rebal-kpi-label">Tiendas destino</div>
      </div>
      <div class="rebal-kpi-deco"></div>
    </div>
  </div>

  <div class="rebal-card rebal-table-card">
    <div class="rebal-table-header">
      <div class="rebal-table-title-wrap">
        <div class="rebal-table-title">
          <i class="bi bi-list-ul me-2"></i>Sugerencias de Redistribución
        </div>
        <div class="rebal-table-hint">
          <i class="bi bi-arrow-right me-1"></i>De tiendas con exceso → a tiendas con alta demanda (según WOC y velocidad de venta)
        </div>
      </div>
      <span class="rebal-table-badge">Top 50 de {{ total_suggestions | default(0) }}</span>
    </div>
    <div class="rebal-table-wrap">
      {% if suggestions %}
      <table class="rebal-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th>Tienda Origen</th>
            <th>Tienda Destino</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Vta/Sem</th>
            <th class="text-end">WOC Orig</th>
            <th class="text-end">WOC Dest</th>
            <th class="text-end">Score</th>
            <th>Razón</th>
            <th class="text-center">Impacto</th>
          </tr>
        </thead>
        <tbody>
          {% for s in suggestions %}
          <tr>
            <td><code class="rebal-sku">{{ s.sku }}</code></td>
            <td class="rebal-name">{{ s.name[:40] }}{% if s.name|length > 40 %}...{% endif %}</td>
            <td><span class="badge-donor">{{ s.from_store }}</span></td>
            <td><span class="badge-receiver">{{ s.to_store }}</span></td>
            <td class="text-end fw-bold">{{ s.qty }}</td>
            <td class="text-end">{{ "%.1f"|format(s.sales_rate_to) }}</td>
            <td class="text-end rebal-woc-high">{{ "%.1f"|format(s.woc_from) }}</td>
            <td class="text-end rebal-woc-low">{{ "%.1f"|format(s.woc_to) }}</td>
            <td class="text-end">{{ "%.1f"|format(s.score) }}</td>
            <td class="rebal-reason">{{ s.reason[:50] }}{% if s.reason|length > 50 %}...{% endif %}</td>
            <td class="text-center">
              {% if s.qty >= 10 %}<span class="impact impact-high">High</span>
              {% elif s.qty >= 5 %}<span class="impact impact-med">Medium</span>
              {% else %}<span class="impact impact-low">Low</span>{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="rebal-empty">
        <div class="rebal-empty-icon"><i class="bi bi-shuffle"></i></div>
        <div class="rebal-empty-title">Sin sugerencias de redistribución</div>
        <div class="rebal-empty-hint">Ajusta los parámetros y ejecuta el proceso para generar transferencias.</div>
      </div>
      {% endif %}
    </div>
  </div>

  {% if current_user.has_permission('rebalancing:run') %}
  <div class="rebal-card rebal-manual-card" id="manualTransferSection">
    <div class="rebal-card-header">
      <div class="d-flex align-items-center">
        <i class="bi bi-hand-index-thumb me-2"></i>
        <span>Constructor de Transferencias Manuales</span>
      </div>
      <button class="btn btn-sm rebal-btn-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#manualTransferBody">
        <i class="bi bi-chevron-down"></i>
      </button>
    </div>
    <div class="collapse show" id="manualTransferBody">
      <div class="rebal-card-body">
        <p class="rebal-manual-subtitle">Selecciona tienda origen, destino y SKUs para crear un plan de transferencia personalizado.</p>
        
        <form id="manualTransferForm" enctype="multipart/form-data">
          <div class="rebal-manual-grid">
            <div class="rebal-field">
              <label class="rebal-label">Tienda Origen (Donante)</label>
              <select name="from_store_id" id="mtFromStore" class="form-select" required>
                <option value="">-- Seleccionar --</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="rebal-field">
              <label class="rebal-label">Tienda Destino (Receptora)</label>
              <select name="to_store_id" id="mtToStore" class="form-select" required>
                <option value="">-- Seleccionar --</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="rebal-field">
              <label class="rebal-label">Stock mínimo a retener</label>
              <input type="number" name="donor_floor" id="mtDonorFloor" class="form-control" value="1" min="0">
            </div>
          </div>

          <div class="rebal-manual-input-section">
            <div class="rebal-field">
              <label class="rebal-label">Archivo CSV/Excel (columnas: sku, qty)</label>
              <input type="file" name="items_file" id="mtItemsFile" class="form-control" accept=".csv,.xlsx,.xls">
              <small class="text-muted">O pega la lista de SKUs abajo</small>
            </div>
            <div class="rebal-field">
              <label class="rebal-label">Lista de SKUs (una línea por SKU: sku,cantidad)</label>
              <textarea name="items_text" id="mtItemsText" class="form-control" rows="4" placeholder="Ejemplo:&#10;SKU001,5&#10;SKU002,10&#10;SKU003,3"></textarea>
            </div>
          </div>

          <div class="rebal-manual-actions">
            <button type="submit" class="btn rebal-btn-primary" id="mtValidateBtn">
              <i class="bi bi-check2-circle me-1"></i>Validar transferencias
            </button>
          </div>
        </form>

        <div id="mtValidationResults" class="rebal-manual-results" style="display:none;">
          <div class="rebal-manual-results-header">
            <h5><i class="bi bi-list-check me-2"></i>Resultados de Validación</h5>
            <div class="rebal-manual-results-summary">
              <span class="mt-badge mt-badge-ok" id="mtOkCount">0 OK</span>
              <span class="mt-badge mt-badge-warn" id="mtWarnCount">0 Advertencias</span>
              <span class="mt-badge mt-badge-error" id="mtErrorCount">0 Errores</span>
            </div>
          </div>
          <div class="rebal-table-wrap">
            <table class="rebal-table rebal-manual-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Stock Origen</th>
                  <th>Estado</th>
                  <th>Notas</th>
                </tr>
              </thead>
              <tbody id="mtValidationBody"></tbody>
            </table>
          </div>
          <div class="rebal-manual-actions mt-3">
            <button type="button" class="btn rebal-btn-success" id="mtAddToPlanBtn">
              <i class="bi bi-plus-circle me-1"></i>Agregar al plan
            </button>
            <button type="button" class="btn rebal-btn-secondary" id="mtClearValidationBtn">
              <i class="bi bi-x-circle me-1"></i>Limpiar validación
            </button>
          </div>
        </div>

        <hr class="rebal-manual-divider">

        <div class="rebal-manual-plan-section">
          <div class="rebal-manual-plan-header">
            <h5><i class="bi bi-clipboard-data me-2"></i>Plan de Transferencia Manual</h5>
            <span class="rebal-table-badge" id="mtPlanCount">0 items</span>
          </div>
          <div class="rebal-table-wrap">
            <table class="rebal-table rebal-manual-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Producto</th>
                  <th>Tienda Origen</th>
                  <th>Tienda Destino</th>
                  <th class="text-end">Cantidad</th>
                  <th>Estado</th>
                  <th>Notas</th>
                  <th class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody id="mtPlanBody">
                <tr class="rebal-empty-row">
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i>El plan está vacío. Valida y agrega SKUs arriba.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="rebal-manual-actions mt-3">
            <a href="{{ url_for('manual_transfer_export') }}" class="btn rebal-btn-secondary" id="mtExportBtn">
              <i class="bi bi-download me-1"></i>Exportar plan (Excel)
            </a>
            <button type="button" class="btn rebal-btn-danger" id="mtClearPlanBtn">
              <i class="bi bi-trash me-1"></i>Limpiar plan
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let validatedItems = [];
  let validationContext = {};

  const form = document.getElementById('manualTransferForm');
  const resultsDiv = document.getElementById('mtValidationResults');
  const validationBody = document.getElementById('mtValidationBody');
  const planBody = document.getElementById('mtPlanBody');

  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const fromStore = document.getElementById('mtFromStore').value;
      const toStore = document.getElementById('mtToStore').value;
      
      if (!fromStore || !toStore) {
        alert('Selecciona tienda origen y destino');
        return;
      }
      
      if (fromStore === toStore) {
        alert('Tienda origen no puede ser igual a destino');
        return;
      }
      
      const formData = new FormData(form);
      const btn = document.getElementById('mtValidateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Validando...';
      
      fetch('/rebalancing/manual/validate', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check2-circle me-1"></i>Validar transferencias';
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        validatedItems = data.items;
        validationContext = {
          from_store_id: data.from_store_id,
          to_store_id: data.to_store_id,
          from_store: data.from_store,
          to_store: data.to_store
        };
        
        document.getElementById('mtOkCount').textContent = data.ok_count + ' OK';
        document.getElementById('mtWarnCount').textContent = data.warning_count + ' Advertencias';
        document.getElementById('mtErrorCount').textContent = data.error_count + ' Errores';
        
        validationBody.innerHTML = '';
        data.items.forEach(item => {
          const statusClass = item.status === 'OK' ? 'mt-status-ok' : 
                             (item.status === 'WARNING' ? 'mt-status-warn' : 'mt-status-error');
          validationBody.innerHTML += `
            <tr>
              <td><code class="rebal-sku">${item.sku}</code></td>
              <td class="rebal-name">${item.product_name}</td>
              <td class="text-end">${item.qty}</td>
              <td class="text-end">${item.donor_stock}</td>
              <td><span class="mt-status ${statusClass}">${item.status}</span></td>
              <td class="text-muted">${item.notes || '-'}</td>
            </tr>
          `;
        });
        
        resultsDiv.style.display = 'block';
      })
      .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check2-circle me-1"></i>Validar transferencias';
        alert('Error: ' + err.message);
      });
    });
  }

  document.getElementById('mtAddToPlanBtn')?.addEventListener('click', function() {
    const validItems = validatedItems.filter(i => i.status === 'OK' || i.status === 'WARNING');
    
    if (validItems.length === 0) {
      alert('No hay items válidos para agregar');
      return;
    }
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Agregando...';
    
    fetch('/rebalancing/manual/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        from_store_id: validationContext.from_store_id,
        to_store_id: validationContext.to_store_id,
        items: validItems
      })
    })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Agregar al plan';
      
      if (data.error) {
        alert(data.error);
        return;
      }
      
      loadPlanItems();
      resultsDiv.style.display = 'none';
      validatedItems = [];
      document.getElementById('mtItemsFile').value = '';
      document.getElementById('mtItemsText').value = '';
    })
    .catch(err => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Agregar al plan';
      alert('Error: ' + err.message);
    });
  });

  document.getElementById('mtClearValidationBtn')?.addEventListener('click', function() {
    resultsDiv.style.display = 'none';
    validatedItems = [];
  });

  document.getElementById('mtClearPlanBtn')?.addEventListener('click', function() {
    if (!confirm('¿Estás seguro de limpiar todo el plan de transferencia?')) return;
    
    fetch('/rebalancing/manual/clear', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      loadPlanItems();
    });
  });

  function loadPlanItems() {
    fetch('/rebalancing/manual/items')
    .then(r => r.json())
    .then(data => {
      const items = data.items || [];
      document.getElementById('mtPlanCount').textContent = items.length + ' items';
      
      if (items.length === 0) {
        planBody.innerHTML = `
          <tr class="rebal-empty-row">
            <td colspan="8" class="text-center text-muted py-4">
              <i class="bi bi-inbox me-2"></i>El plan está vacío. Valida y agrega SKUs arriba.
            </td>
          </tr>
        `;
        return;
      }
      
      planBody.innerHTML = '';
      items.forEach(item => {
        const statusClass = item.status === 'OK' ? 'mt-status-ok' : 
                           (item.status === 'WARNING' ? 'mt-status-warn' : 'mt-status-error');
        planBody.innerHTML += `
          <tr>
            <td><code class="rebal-sku">${item.sku}</code></td>
            <td class="rebal-name">${item.product_name}</td>
            <td><span class="badge-donor">${item.from_store}</span></td>
            <td><span class="badge-receiver">${item.to_store}</span></td>
            <td class="text-end fw-bold">${item.qty}</td>
            <td><span class="mt-status ${statusClass}">${item.status}</span></td>
            <td class="text-muted">${item.notes || '-'}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger mt-remove-btn" data-id="${item.id}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      document.querySelectorAll('.mt-remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemId = this.dataset.id;
          fetch('/rebalancing/manual/remove/' + itemId, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.success) loadPlanItems();
          });
        });
      });
    });
  }

  loadPlanItems();
});
</script>

{% endblock %}
