{% extends "base.html" %}

{% block title %}Redistribución Tienda-Tienda{% endblock %}
{% block page_title %}Redistribución Tienda-Tienda{% endblock %}

{% block content %}
<div class="rebal-wrap">
  <div class="rebal-header">
    <h1 class="rebal-title">Redistribución Tienda-Tienda</h1>
    <p class="rebal-subtitle">Optimiza el balance de inventario entre tiendas según demanda y reglas de WOC</p>
  </div>

  {% if run_info %}
  {% if run_info.is_simulation %}
  <div class="rebal-alert rebal-alert-warning">
    <div class="rebal-alert-icon"><i class="bi bi-lightning-charge-fill"></i></div>
    <div class="rebal-alert-content">
      <strong>MODO SIMULACIÓN:</strong> Estos resultados no se guardaron en la base de datos.
      <span class="rebal-alert-meta">Generado: {{ run_info.created_at.strftime('%Y-%m-%d %H:%M') if run_info.created_at else 'N/A' }}</span>
    </div>
    <a href="{{ url_for('clear_simulation_route', sim_type='rebalancing', redirect='rebalancing') }}" class="btn btn-sm rebal-btn-clear">
      <i class="bi bi-x-circle me-1"></i>Limpiar simulación
    </a>
  </div>
  {% else %}
  <div class="rebal-alert rebal-alert-info">
    <div class="rebal-alert-icon"><i class="bi bi-check-circle-fill"></i></div>
    <div class="rebal-alert-content">
      <strong>Última corrida:</strong> {{ run_info.created_at.strftime('%Y-%m-%d %H:%M') if run_info.created_at else 'N/A' }}
      <span class="rebal-alert-meta">ID: {{ run_info.run_id[:8] }}...</span>
    </div>
  </div>
  {% endif %}
  {% endif %}

  <div class="rebal-card rebal-main-card">
    <div class="rebal-mode-tabs">
      <button type="button" class="rebal-mode-tab active" data-mode="auto">
        <i class="bi bi-lightning-charge me-1"></i>Sugerencias Automáticas
      </button>
      {% if current_user.has_permission('rebalancing:run') %}
      <button type="button" class="rebal-mode-tab" data-mode="manual">
        <i class="bi bi-hand-index-thumb me-1"></i>Plan Manual Asistido
      </button>
      {% endif %}
    </div>

    <div class="rebal-card-body">
      <div class="rebal-params-section">
        <div class="rebal-params-header">
          <i class="bi bi-sliders me-2"></i>Parámetros Compartidos
        </div>
        <div class="rebal-params-grid rebal-params-compact">
          <div class="rebal-field">
            <label class="rebal-label">Semanas historial</label>
            <select id="paramWeeksWindow" class="form-select form-select-sm">
              {% for w in [2,4,8,12] %}
              <option value="{{ w }}" {% if params.weeks_window == w %}selected{% endif %}>{{ w }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Mín</label>
            <input type="number" step="0.1" id="paramWocMin" class="form-control form-control-sm" value="{{ params.target_woc_min }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Objetivo</label>
            <input type="number" step="0.1" id="paramWocTarget" class="form-control form-control-sm" value="{{ params.target_woc_target }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">WOC Máx</label>
            <input type="number" step="0.1" id="paramWocMax" class="form-control form-control-sm" value="{{ params.target_woc_max }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Retener WOC</label>
            <input type="number" step="0.1" id="paramRetainWoc" class="form-control form-control-sm" value="{{ params.retain_woc }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Stock mín</label>
            <input type="number" id="paramStockFloor" class="form-control form-control-sm" value="{{ params.stock_floor }}">
          </div>
          <div class="rebal-field">
            <label class="rebal-label">Transf. mín</label>
            <input type="number" id="paramMinTransfer" class="form-control form-control-sm" value="{{ params.min_transfer_qty }}">
          </div>
        </div>
      </div>

      <div id="autoModeContent" class="rebal-mode-content active">
        <form method="POST" action="{{ url_for('rebalancing') }}" id="autoRebalancingForm"
              data-loader="true"
              data-loader-title="Procesando Redistribución"
              data-loader-msg="Evaluando stock de tiendas y generando transferencias sugeridas..."
              data-loader-icon="store-transfer">
          
          <input type="hidden" name="weeks_window" id="autoWeeksWindow">
          <input type="hidden" name="target_woc_min" id="autoWocMin">
          <input type="hidden" name="target_woc_target" id="autoWocTarget">
          <input type="hidden" name="target_woc_max" id="autoWocMax">
          <input type="hidden" name="retain_woc" id="autoRetainWoc">
          <input type="hidden" name="stock_floor" id="autoStockFloor">
          <input type="hidden" name="min_transfer_qty" id="autoMinTransfer">

          <div class="rebal-auto-controls">
            <div class="rebal-field rebal-field-inline">
              <label class="rebal-label">Tienda destino (filtro)</label>
              <select name="store_filter" class="form-select form-select-sm" style="width: 200px;">
                <option value="">-- Todas --</option>
                {% for store in stores %}
                <option value="{{ store.name }}" {% if params.store_filter == store.name %}selected{% endif %}>{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="rebal-auto-actions">
              {% if current_user.has_permission('rebalancing:run') %}
              <label class="rebal-simulate-check">
                <input type="checkbox" name="simulate" value="1" id="simulateCheck">
                <span><i class="bi bi-lightning me-1"></i>Simular</span>
              </label>
              <button type="submit" class="btn btn-sm rebal-btn-primary">
                <i class="bi bi-play-circle me-1"></i>Generar
              </button>
              {% endif %}
              {% if run_info and not run_info.is_simulation %}
              <a href="{{ url_for('export_rebalancing', run_id=run_info.run_id) }}" class="btn btn-sm rebal-btn-secondary">
                <i class="bi bi-download me-1"></i>Exportar
              </a>
              {% elif run_info and run_info.is_simulation %}
              <a href="{{ url_for('export_simulation', sim_type='rebalancing') }}" class="btn btn-sm rebal-btn-warning">
                <i class="bi bi-download me-1"></i>Exportar Sim
              </a>
              {% endif %}
            </div>
          </div>
        </form>
      </div>

      {% if current_user.has_permission('rebalancing:run') %}
      <div id="manualModeContent" class="rebal-mode-content">
        <div class="rebal-manual-controls">
          <div class="rebal-manual-stores-row">
            <div class="rebal-field">
              <label class="rebal-label">Tienda destino <span class="text-danger">*</span></label>
              <select id="manualToStore" class="form-select form-select-sm" required>
                <option value="">-- Seleccionar --</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="rebal-field">
              <label class="rebal-label">Tienda donante <span class="text-muted">(opcional)</span></label>
              <select id="manualFromStore" class="form-select form-select-sm">
                <option value="">-- Auto (mejor donante) --</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="rebal-manual-input-row">
            <div class="rebal-field rebal-field-file">
              <label class="rebal-label">Archivo SKUs (CSV/Excel, columna: sku)</label>
              <input type="file" id="manualSkuFile" class="form-control form-control-sm" accept=".csv,.xlsx,.xls">
            </div>
            <div class="rebal-field-divider">o</div>
            <div class="rebal-field rebal-field-textarea">
              <label class="rebal-label">Lista SKUs (uno por línea)</label>
              <textarea id="manualSkuText" class="form-control form-control-sm" rows="3" placeholder="SKU001&#10;SKU002&#10;SKU003">{% if prefill_sku %}{{ prefill_sku }}{% endif %}</textarea>
            </div>
          </div>
          <div class="rebal-manual-actions">
            <button type="button" class="btn btn-sm rebal-btn-primary" id="manualCalculateBtn">
              <i class="bi bi-calculator me-1"></i>Calcular plan
            </button>
          </div>
        </div>

        <div id="manualPlanSection" class="rebal-manual-plan" style="display:none;">
          <div class="rebal-manual-plan-header">
            <h6><i class="bi bi-clipboard-data me-2"></i>Plan Calculado</h6>
            <div class="rebal-manual-plan-badges">
              <span class="mt-badge mt-badge-ok" id="manualOkCount">0 OK</span>
              <span class="mt-badge mt-badge-warn" id="manualNoNeedCount">0 Sin necesidad</span>
              <span class="mt-badge mt-badge-error" id="manualNoDonorCount">0 Sin donante</span>
            </div>
          </div>
          <div class="rebal-table-wrap rebal-table-compact">
            <table class="rebal-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Producto</th>
                  <th>Donante</th>
                  <th>Destino</th>
                  <th class="text-end">Cantidad</th>
                  <th class="text-end">WOC Dest</th>
                  <th class="text-end">Donante da</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="manualPlanBody"></tbody>
            </table>
          </div>
          <div class="rebal-manual-plan-actions">
            <button type="button" class="btn btn-sm rebal-btn-success" id="manualSavePlanBtn">
              <i class="bi bi-save me-1"></i>Guardar plan
            </button>
            <button type="button" class="btn btn-sm rebal-btn-secondary" id="manualExportPlanBtn">
              <i class="bi bi-download me-1"></i>Exportar Excel
            </button>
            <button type="button" class="btn btn-sm rebal-btn-outline" id="manualClearPlanBtn">
              <i class="bi bi-x-circle me-1"></i>Limpiar
            </button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="rebal-kpi-row">
    <div class="rebal-kpi-card rebal-kpi-blue">
      <div class="rebal-kpi-badge"><i class="bi bi-box-seam"></i></div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.total_units | default(0) }}</div>
        <div class="rebal-kpi-label">Unidades a transferir</div>
      </div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-green">
      <div class="rebal-kpi-badge"><i class="bi bi-arrow-left-right"></i></div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_moves | default(0) }}</div>
        <div class="rebal-kpi-label">Movimientos sugeridos</div>
      </div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-cyan">
      <div class="rebal-kpi-badge"><i class="bi bi-upc-scan"></i></div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_skus | default(0) }}</div>
        <div class="rebal-kpi-label">SKUs afectados</div>
      </div>
    </div>
    <div class="rebal-kpi-card rebal-kpi-amber">
      <div class="rebal-kpi-badge"><i class="bi bi-shop"></i></div>
      <div class="rebal-kpi-content">
        <div class="rebal-kpi-value">{{ kpis.num_receivers | default(0) }}</div>
        <div class="rebal-kpi-label">Tiendas destino</div>
      </div>
    </div>
  </div>

  <div class="rebal-card rebal-table-card">
    <div class="rebal-table-header">
      <div class="rebal-table-title-wrap">
        <div class="rebal-table-title">
          <i class="bi bi-list-ul me-2"></i>Sugerencias de Redistribución
        </div>
        <div class="rebal-table-hint">
          <i class="bi bi-arrow-right me-1"></i>De tiendas con exceso → a tiendas con alta demanda
        </div>
      </div>
      <span class="rebal-table-badge">{{ sug_pagination.start }}-{{ sug_pagination.end }} de {{ sug_pagination.total }}</span>
    </div>
    <div class="rebal-table-wrap">
      {% if suggestions %}
      <table class="rebal-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th>Tienda Origen</th>
            <th>Tienda Destino</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Vta/Sem</th>
            <th class="text-end">WOC Orig</th>
            <th class="text-end">WOC Dest</th>
            <th class="text-end">Score</th>
            <th>Razón</th>
            <th class="text-center">Impacto</th>
          </tr>
        </thead>
        <tbody>
          {% for s in suggestions %}
          <tr>
            <td><code class="rebal-sku">{{ s.sku }}</code></td>
            <td class="rebal-name">{{ s.name[:40] }}{% if s.name|length > 40 %}...{% endif %}</td>
            <td><span class="badge-donor">{{ s.from_store }}</span></td>
            <td><span class="badge-receiver">{{ s.to_store }}</span></td>
            <td class="text-end fw-bold">{{ s.qty }}</td>
            <td class="text-end">{{ "%.1f"|format(s.sales_rate_to) }}</td>
            <td class="text-end rebal-woc-high">{{ "%.1f"|format(s.woc_from) }}</td>
            <td class="text-end rebal-woc-low">{{ "%.1f"|format(s.woc_to) }}</td>
            <td class="text-end">{{ "%.1f"|format(s.score) }}</td>
            <td class="rebal-reason">{{ s.reason[:50] }}{% if s.reason|length > 50 %}...{% endif %}</td>
            <td class="text-center">
              {% if s.qty >= 10 %}<span class="impact impact-high">High</span>
              {% elif s.qty >= 5 %}<span class="impact impact-med">Medium</span>
              {% else %}<span class="impact impact-low">Low</span>{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if sug_pagination.pages > 1 %}
      <div class="rebal-pagination">
        <button type="button" class="rebal-page-btn" onclick="updateSugPage({{ sug_pagination.prev_num }})" {% if not sug_pagination.has_prev %}disabled{% endif %}>
          <i class="bi bi-chevron-left"></i> Anterior
        </button>
        <div class="rebal-page-nums">
          {% for p in range(1, sug_pagination.pages + 1) %}
            {% if p == sug_pagination.page %}
              <span class="rebal-page-num active">{{ p }}</span>
            {% elif p == 1 or p == sug_pagination.pages or (p >= sug_pagination.page - 2 and p <= sug_pagination.page + 2) %}
              <button type="button" class="rebal-page-num" onclick="updateSugPage({{ p }})">{{ p }}</button>
            {% elif p == sug_pagination.page - 3 or p == sug_pagination.page + 3 %}
              <span class="rebal-page-ellipsis">...</span>
            {% endif %}
          {% endfor %}
        </div>
        <button type="button" class="rebal-page-btn" onclick="updateSugPage({{ sug_pagination.next_num }})" {% if not sug_pagination.has_next %}disabled{% endif %}>
          Siguiente <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      {% endif %}
      {% else %}
      <div class="rebal-empty">
        <div class="rebal-empty-icon"><i class="bi bi-shuffle"></i></div>
        <div class="rebal-empty-title">Sin sugerencias de redistribución</div>
        <div class="rebal-empty-hint">Ajusta los parámetros y ejecuta el proceso para generar transferencias.</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function updateSugPage(page) {
  const url = new URL(window.location.href);
  url.searchParams.set('sug_page', page);
  window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  const modeTabs = document.querySelectorAll('.rebal-mode-tab');
  const autoContent = document.getElementById('autoModeContent');
  const manualContent = document.getElementById('manualModeContent');
  
  modeTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      modeTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const mode = this.dataset.mode;
      if (mode === 'auto') {
        autoContent.classList.add('active');
        if (manualContent) manualContent.classList.remove('active');
      } else {
        autoContent.classList.remove('active');
        if (manualContent) manualContent.classList.add('active');
      }
    });
  });

  function syncAutoParams() {
    document.getElementById('autoWeeksWindow').value = document.getElementById('paramWeeksWindow').value;
    document.getElementById('autoWocMin').value = document.getElementById('paramWocMin').value;
    document.getElementById('autoWocTarget').value = document.getElementById('paramWocTarget').value;
    document.getElementById('autoWocMax').value = document.getElementById('paramWocMax').value;
    document.getElementById('autoRetainWoc').value = document.getElementById('paramRetainWoc').value;
    document.getElementById('autoStockFloor').value = document.getElementById('paramStockFloor').value;
    document.getElementById('autoMinTransfer').value = document.getElementById('paramMinTransfer').value;
  }

  document.getElementById('autoRebalancingForm')?.addEventListener('submit', function() {
    syncAutoParams();
  });

  const prefillSku = '{{ prefill_sku|default("", true) }}';
  if (prefillSku) {
    modeTabs.forEach(t => t.classList.remove('active'));
    document.querySelector('[data-mode="manual"]')?.classList.add('active');
    autoContent.classList.remove('active');
    if (manualContent) manualContent.classList.add('active');
  }

  let calculatedPlan = [];

  const calculateBtn = document.getElementById('manualCalculateBtn');
  if (calculateBtn) {
    calculateBtn.addEventListener('click', function() {
      const toStore = document.getElementById('manualToStore').value;
      if (!toStore) {
        alert('Selecciona una tienda destino');
        return;
      }

      const fromStore = document.getElementById('manualFromStore').value;
      const fileInput = document.getElementById('manualSkuFile');
      const textInput = document.getElementById('manualSkuText').value.trim();

      if (!fileInput.files.length && !textInput) {
        alert('Proporciona un archivo o lista de SKUs');
        return;
      }

      const params = {
        weeks_window: document.getElementById('paramWeeksWindow').value,
        woc_min: document.getElementById('paramWocMin').value,
        woc_target: document.getElementById('paramWocTarget').value,
        woc_max: document.getElementById('paramWocMax').value,
        retain_woc: document.getElementById('paramRetainWoc').value,
        stock_floor: document.getElementById('paramStockFloor').value,
        min_transfer_qty: document.getElementById('paramMinTransfer').value
      };

      const formData = new FormData();
      formData.append('to_store_id', toStore);
      if (fromStore) formData.append('from_store_id', fromStore);
      formData.append('sku_text', textInput);
      if (fileInput.files.length) formData.append('sku_file', fileInput.files[0]);
      Object.keys(params).forEach(k => formData.append(k, params[k]));

      calculateBtn.disabled = true;
      calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Calculando...';

      fetch('/rebalancing/manual/calculate', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        calculateBtn.disabled = false;
        calculateBtn.innerHTML = '<i class="bi bi-calculator me-1"></i>Calcular plan';

        if (data.error) {
          alert(data.error);
          return;
        }

        calculatedPlan = data.items || [];
        renderManualPlan(data);
      })
      .catch(err => {
        calculateBtn.disabled = false;
        calculateBtn.innerHTML = '<i class="bi bi-calculator me-1"></i>Calcular plan';
        alert('Error: ' + err.message);
      });
    });
  }

  function renderManualPlan(data) {
    document.getElementById('manualOkCount').textContent = (data.ok_count || 0) + ' OK';
    document.getElementById('manualNoNeedCount').textContent = (data.no_need_count || 0) + ' Sin necesidad';
    document.getElementById('manualNoDonorCount').textContent = (data.no_donor_count || 0) + ' Sin donante';

    const tbody = document.getElementById('manualPlanBody');
    tbody.innerHTML = '';

    (data.items || []).forEach(item => {
      const statusClass = item.status === 'OK' ? 'mt-status-ok' : 
                         (item.status === 'NO-NEED' ? 'mt-status-warn' : 'mt-status-error');
      const statusLabel = item.status === 'OK' ? 'OK' :
                         (item.status === 'NO-NEED' ? 'Sin necesidad' : 
                         (item.status === 'NO-DONOR' ? 'Sin donante' : 'Sin ventas'));
      tbody.innerHTML += `
        <tr>
          <td><code class="rebal-sku">${item.sku}</code></td>
          <td class="rebal-name">${(item.product_name || '').substring(0, 35)}</td>
          <td>${item.donor_store ? '<span class="badge-donor">' + item.donor_store + '</span>' : '-'}</td>
          <td><span class="badge-receiver">${item.to_store || ''}</span></td>
          <td class="text-end fw-bold">${item.transfer_qty || 0}</td>
          <td class="text-end">${(item.woc_dest || 0).toFixed(1)}</td>
          <td class="text-end">${item.donor_give || 0}</td>
          <td><span class="mt-status ${statusClass}">${statusLabel}</span></td>
        </tr>
      `;
    });

    document.getElementById('manualPlanSection').style.display = 'block';
  }

  document.getElementById('manualSavePlanBtn')?.addEventListener('click', function() {
    const okItems = calculatedPlan.filter(i => i.status === 'OK' && i.transfer_qty > 0);
    if (okItems.length === 0) {
      alert('No hay items con transferencias válidas para guardar');
      return;
    }

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

    fetch('/rebalancing/manual/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: okItems })
    })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-save me-1"></i>Guardar plan';
      if (data.success) {
        alert('Plan guardado exitosamente (' + data.count + ' items)');
      } else {
        alert(data.error || 'Error al guardar');
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-save me-1"></i>Guardar plan';
      alert('Error: ' + err.message);
    });
  });

  document.getElementById('manualExportPlanBtn')?.addEventListener('click', function() {
    const okItems = calculatedPlan.filter(i => i.status === 'OK' && i.transfer_qty > 0);
    if (okItems.length === 0) {
      alert('No hay items para exportar');
      return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/rebalancing/manual/export-calculated';
    form.style.display = 'none';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'items';
    input.value = JSON.stringify(okItems);
    form.appendChild(input);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  });

  document.getElementById('manualClearPlanBtn')?.addEventListener('click', function() {
    calculatedPlan = [];
    document.getElementById('manualPlanBody').innerHTML = '';
    document.getElementById('manualPlanSection').style.display = 'none';
    document.getElementById('manualSkuFile').value = '';
    document.getElementById('manualSkuText').value = '';
  });
});
</script>

{% endblock %}
