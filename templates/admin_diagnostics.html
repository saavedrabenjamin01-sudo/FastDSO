{% extends 'base.html' %}
{% block title %}Diagnósticos de Datos - FastDSO{% endblock %}
{% block page_title %}Diagnósticos de Datos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Esta página muestra estadísticas de las fuentes de datos cargadas y la fecha de análisis calculada.
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Ventas Macro (SalesWeeklyAgg)</h6>
        </div>
        <div class="card-body">
          {% if diagnostics.macro_sales.has_data %}
          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td class="text-muted">Total registros:</td>
              <td class="text-end fw-bold">{{ diagnostics.macro_sales.total_rows | default(0) | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha mínima:</td>
              <td class="text-end">{{ diagnostics.macro_sales.min_week_start }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha máxima:</td>
              <td class="text-end">{{ diagnostics.macro_sales.max_week_start }}</td>
            </tr>
            <tr>
              <td class="text-muted">SKUs distintos:</td>
              <td class="text-end">{{ diagnostics.macro_sales.distinct_skus | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Tiendas distintas:</td>
              <td class="text-end">{{ diagnostics.macro_sales.distinct_stores | format_number }}</td>
            </tr>
          </table>
          {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-exclamation-triangle text-warning fs-3"></i>
            <p class="mt-2 mb-0">Sin datos de ventas macro cargados</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-shop me-2"></i>Stock Tiendas (StockSnapshot)</h6>
        </div>
        <div class="card-body">
          {% if diagnostics.store_stock.total_rows > 0 %}
          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td class="text-muted">Total registros:</td>
              <td class="text-end fw-bold">{{ diagnostics.store_stock.total_rows | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha mínima:</td>
              <td class="text-end">{{ diagnostics.store_stock.min_date }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha máxima:</td>
              <td class="text-end">{{ diagnostics.store_stock.max_date }}</td>
            </tr>
            <tr>
              <td class="text-muted">SKUs distintos:</td>
              <td class="text-end">{{ diagnostics.store_stock.distinct_skus | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Tiendas distintas:</td>
              <td class="text-end">{{ diagnostics.store_stock.distinct_stores | format_number }}</td>
            </tr>
          </table>
          {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-exclamation-triangle text-warning fs-3"></i>
            <p class="mt-2 mb-0">Sin datos de stock tiendas cargados</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0"><i class="bi bi-box-seam me-2"></i>Stock CD (StockCD)</h6>
        </div>
        <div class="card-body">
          {% if diagnostics.cd_stock.total_rows > 0 %}
          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td class="text-muted">Total registros:</td>
              <td class="text-end fw-bold">{{ diagnostics.cd_stock.total_rows | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha mínima:</td>
              <td class="text-end">{{ diagnostics.cd_stock.min_date }}</td>
            </tr>
            <tr>
              <td class="text-muted">Fecha máxima:</td>
              <td class="text-end">{{ diagnostics.cd_stock.max_date }}</td>
            </tr>
            <tr>
              <td class="text-muted">SKUs distintos:</td>
              <td class="text-end">{{ diagnostics.cd_stock.distinct_skus | format_number }}</td>
            </tr>
          </table>
          {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-exclamation-triangle text-warning fs-3"></i>
            <p class="mt-2 mb-0">Sin datos de stock CD cargados</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Fecha de Análisis Calculada</h6>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="display-6 text-primary me-3">{{ diagnostics.analysis_end_date }}</div>
            <div class="text-muted">
              Esta fecha se usa como referencia para calcular ventanas de ventas en módulos como Redistribución, Stock Lento y Salud de Tiendas.
            </div>
          </div>
          {% if diagnostics.macro_sales.has_data %}
          <div class="alert alert-success mt-3 mb-0">
            <i class="bi bi-check-circle me-2"></i>
            Fecha basada en max(SalesWeeklyAgg.week_start) + 6 días
          </div>
          {% else %}
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Sin datos macro - usando fecha de hoy como fallback
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>Muestra de Datos (Top 5 por Ventas)</h6>
        </div>
        <div class="card-body">
          {% if diagnostics.sample_sales %}
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>SKU</th>
                <th>Tienda</th>
                <th class="text-end">Unidades</th>
              </tr>
            </thead>
            <tbody>
              {% for s in diagnostics.sample_sales %}
              <tr>
                <td><code>{{ s.sku }}</code></td>
                <td>{{ s.store }}</td>
                <td class="text-end">{{ s.units | format_number }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-database-slash fs-3"></i>
            <p class="mt-2 mb-0">Sin datos de muestra disponibles</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-dark text-white">
          <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Ledger de Inventario Operacional</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td class="text-muted">Total eventos:</td>
              <td class="text-end fw-bold">{{ diagnostics.inventory_ledger.total_events | format_number }}</td>
            </tr>
            <tr>
              <td class="text-muted">Baseline CD:</td>
              <td class="text-end">{{ diagnostics.inventory_ledger.cd_baseline_date or 'Sin baseline' }}</td>
            </tr>
            <tr>
              <td class="text-muted">Baseline Tiendas:</td>
              <td class="text-end">{{ diagnostics.inventory_ledger.store_baseline_date or 'Sin baseline' }}</td>
            </tr>
            <tr>
              <td class="text-muted">Holds activos:</td>
              <td class="text-end">{{ diagnostics.inventory_ledger.active_holds }}</td>
            </tr>
          </table>
          {% if diagnostics.inventory_ledger.event_types %}
          <hr class="my-2">
          <small class="text-muted d-block mb-1">Eventos por tipo:</small>
          {% for etype, ecount in diagnostics.inventory_ledger.event_types.items() %}
          <span class="badge bg-secondary me-1 mb-1">{{ etype }}: {{ ecount }}</span>
          {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-bug me-2"></i>Debug Stock Operacional</h6>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-2">Consulta el stock operacional vs snapshot para un SKU específico.</p>
          <form id="opStockDebugForm" class="d-flex gap-2">
            <input type="text" id="debugSku" class="form-control form-control-sm" placeholder="Ingrese SKU...">
            <button type="submit" class="btn btn-sm btn-info text-white">Consultar</button>
          </form>
          <div id="opStockResult" class="mt-2" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Volver a Usuarios
      </a>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary ms-2">
        <i class="bi bi-house me-1"></i>Ir al Dashboard
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('opStockDebugForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var sku = document.getElementById('debugSku').value.trim();
  if (!sku) return;
  var resultDiv = document.getElementById('opStockResult');
  resultDiv.innerHTML = '<span class="text-muted">Consultando...</span>';
  fetch('/admin/operational_stock_debug?sku=' + encodeURIComponent(sku))
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) {
        resultDiv.innerHTML = '<span class="text-danger">' + data.error + '</span>';
        return;
      }
      var html = '<strong>CD:</strong> Snapshot=' + data.cd_stock.snapshot_qty +
        ' | Operacional=' + data.cd_stock.operational_qty +
        ' | Δ=' + data.cd_stock.delta + '<br>';
      if (data.store_comparison.length > 0) {
        html += '<strong>Tiendas con stock:</strong><br>';
        html += '<table class="table table-sm table-bordered mb-0"><thead><tr><th>Tienda</th><th>Snap</th><th>Op</th><th>Δ</th></tr></thead><tbody>';
        data.store_comparison.forEach(function(s) {
          var cls = s.delta !== 0 ? 'table-warning' : '';
          html += '<tr class="' + cls + '"><td>' + s.store + '</td><td>' + s.snapshot_qty + '</td><td>' + s.operational_qty + '</td><td>' + s.delta + '</td></tr>';
        });
        html += '</tbody></table>';
      }
      if (data.cd_events.length > 0) {
        html += '<strong>Últimos eventos CD:</strong><br>';
        data.cd_events.forEach(function(ev) {
          html += '<small>' + ev.type + ' ' + ev.date + ' qty=' + ev.qty_delta + '</small><br>';
        });
      }
      resultDiv.innerHTML = html;
    })
    .catch(function(err) {
      resultDiv.innerHTML = '<span class="text-danger">Error: ' + err.message + '</span>';
    });
});
</script>
{% endblock %}
