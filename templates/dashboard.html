{% extends 'base.html' %}
{% block content %}

{# Pagination controls macro #}
{% macro pagination_controls(pag, page_param, size_param, size_val) %}
<div class="dashv1-pagination">
  <small class="text-muted">{{ pag.total }} registros</small>
  <div class="d-flex align-items-center gap-2">
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if not pag.has_prev %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.prev_num or 1 }})">Ant</a>
        </li>
        {% for p in pag.iter_pages() %}
          {% if p %}
            <li class="page-item {% if p == pag.page %}active{% endif %}">
              <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ p }})">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pag.has_next %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.next_num or pag.pages }})">Sig</a>
        </li>
      </ul>
    </nav>
    <select class="form-select form-select-sm" style="width:60px;" onchange="updateParam('{{ size_param }}', this.value, '{{ page_param }}')">
      <option value="10" {% if size_val == 10 %}selected{% endif %}>10</option>
      <option value="25" {% if size_val == 25 %}selected{% endif %}>25</option>
      <option value="50" {% if size_val == 50 %}selected{% endif %}>50</option>
    </select>
  </div>
</div>
{% endmacro %}

<div class="dashv1">

  {# Pending approvals alert for managers #}
  {% if sidebar_counts.pending_approvals > 0 and current_user.has_permission('runs:approve') %}
  <div class="pending-alert-banner">
    <div class="pending-alert-icon"><i class="bi bi-hourglass-split"></i></div>
    <div class="pending-alert-content">
      <div class="pending-alert-title">Tienes {{ sidebar_counts.pending_approvals }} autorización{% if sidebar_counts.pending_approvals > 1 %}es{% endif %} pendiente{% if sidebar_counts.pending_approvals > 1 %}s{% endif %}</div>
      <div class="pending-alert-subtitle">Corridas de distribución esperan tu aprobación</div>
    </div>
    <a href="{{ url_for('runs') }}" class="btn btn-warning btn-sm"><i class="bi bi-arrow-right"></i> Ir a Centro de Corridas</a>
  </div>
  {% endif %}

  {# Simulation alerts #}
  {% if active_simulations is defined and active_simulations %}
  <div class="dashv1-alert dashv1-alert-warning">
    <div class="dashv1-alert-content">
      <div class="dashv1-alert-icon">
        <i class="bi bi-lightning-charge"></i>
      </div>
      <div class="dashv1-alert-text">
        <strong>Simulaciones activas:</strong>
        {% for sim_type, sim_data in active_simulations.items() %}
          <span class="dashv1-badge-warning">{{ sim_type|capitalize }}</span>
        {% endfor %}
      </div>
      <a href="{{ url_for('clear_simulation_route', sim_type='all', redirect='dashboard') }}" class="btn btn-sm btn-outline-warning">Limpiar</a>
    </div>
  </div>
  {% endif %}

  {# A) Run summary strip #}
  <div class="dashv1-runstrip">
    {% if runs is defined and runs and selected_run_id %}
      {% set current_run = runs|selectattr('run_id', 'equalto', selected_run_id)|first %}
      {% if current_run %}
        <span class="dashv1-runtext">
          Folio: <strong>{{ folio if folio else 'N/A' }}</strong>
          {% if responsable %} | Resp: <strong>{{ responsable }}</strong>{% endif %}
          {% if current_run.created_at %} — <span class="text-muted">{{ current_run.created_at.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
        </span>
      {% else %}
        <span class="dashv1-runtext">Corrida activa: —</span>
      {% endif %}
    {% else %}
      <span class="dashv1-runtext">Corrida activa: —</span>
    {% endif %}
  </div>

  {# B) Filters row (compact) #}
  <form class="dashv1-filters" method="get" action="{{ url_for('dashboard') }}">
    <div class="dashv1-filter">
      <label class="dashv1-label">Corrida</label>
      <select class="form-select form-select-sm dashv1-input" name="run_id">
        {% for r in runs %}
          <option value="{{ r.run_id }}" {% if selected_run_id == r.run_id %}selected{% endif %}>
            {{ r.label() if r.label is callable else r.run_id[:8] }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Tiendas</label>
      <select class="form-select form-select-sm dashv1-input" name="store">
        <option value="">Todas las tiendas</option>
        {% for s in stores %}
          <option value="{{ s.name }}" {% if selected_store == s.name %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Folio</label>
      <input class="form-control form-control-sm dashv1-input" name="folio" value="{{ folio or '' }}" placeholder="Folio">
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Responsable</label>
      <input class="form-control form-control-sm dashv1-input" name="responsable" value="{{ responsable or '' }}" placeholder="Responsable">
    </div>

    <div class="dashv1-actions">
      <button class="btn btn-primary dashv1-btn-apply">Aplicar</button>
      <a class="btn btn-outline-secondary dashv1-btn-clear" href="{{ url_for('dashboard') }}">Limpiar</a>
    </div>
  </form>

  {# C) Macro Health Overview - 3 macro KPI cards (primary + 2 secondary) #}
  <div class="macro-grid macro-grid-hierarchy">
    <div class="macro-card macro-card-stores macro-card-primary">
      <div class="macro-icon"><i class="bi bi-shop"></i></div>
      <div class="macro-body">
        <div class="macro-title">Impacto Red</div>
        <div class="macro-value">{{ "{:,}".format(kpi_tiendas_alcanzadas|int if kpi_tiendas_alcanzadas is defined else 0) }}</div>
        <div class="macro-sub">Tiendas alcanzadas por la corrida activa</div>
      </div>
    </div>

    <div class="macro-card macro-card-cd macro-card-secondary">
      <div class="macro-icon"><i class="bi bi-archive"></i></div>
      <div class="macro-body">
        <div class="macro-title">Stock CD</div>
        <div class="macro-value">{{ "{:,}".format(kpi_stock_cd_total|int if kpi_stock_cd_total is defined else 0) }}</div>
        <div class="macro-sub">Unidades disponibles en CD</div>
      </div>
    </div>

    <div class="macro-card macro-card-units macro-card-secondary">
      <div class="macro-icon"><i class="bi bi-box-arrow-right"></i></div>
      <div class="macro-body">
        <div class="macro-title">Distribución</div>
        <div class="macro-value">{{ "{:,}".format(kpi_units_suggested|int if kpi_units_suggested is defined else 0) }}</div>
        <div class="macro-sub">Unidades sugeridas (corrida activa)</div>
      </div>
    </div>
  </div>

  {# D) Executive Alerts Widget (compact, proportional) #}
  {% if alerts_summary is defined and alerts_summary.total_count > 0 %}
  {% set total = alerts_summary.total_count if alerts_summary.total_count > 0 else 1 %}
  {% set high_pct = (alerts_summary.high_count / total * 100)|round|int %}
  {% set medium_pct = (alerts_summary.medium_count / total * 100)|round|int %}
  {% set low_pct = (100 - high_pct - medium_pct) if (alerts_summary.low_count > 0) else 0 %}
  <div class="exec-alerts exec-alerts-v2">
    <div class="exec-alerts-header">
      <div class="exec-alerts-title">
        <i class="bi bi-bell"></i>
        <span>Alertas</span>
      </div>
      <a href="{{ url_for('alerts_page') }}" class="btn btn-sm btn-outline-primary exec-alerts-btn">Ver alertas</a>
    </div>
    <div class="exec-alerts-body">
      <div class="alert-chips-v2">
        <div class="alert-chip-v2 alert-chip-v2-high">
          <span class="alert-chip-v2-pct">{{ high_pct }}%</span>
          <span class="alert-chip-v2-label">Alta</span>
        </div>
        <div class="alert-chip-v2 alert-chip-v2-med">
          <span class="alert-chip-v2-pct">{{ medium_pct }}%</span>
          <span class="alert-chip-v2-label">Media</span>
        </div>
        <div class="alert-chip-v2 alert-chip-v2-low">
          <span class="alert-chip-v2-pct">{{ low_pct }}%</span>
          <span class="alert-chip-v2-label">Baja</span>
        </div>
      </div>
      <div class="alert-bar-wrap">
        <div class="alert-bar-v2">
          {% if high_pct > 0 %}
          <div class="alert-bar-seg-v2 alert-bar-seg-high" style="width: {{ high_pct }}%;" title="Alta: {{ high_pct }}%"></div>
          {% endif %}
          {% if medium_pct > 0 %}
          <div class="alert-bar-seg-v2 alert-bar-seg-med" style="width: {{ medium_pct }}%;" title="Media: {{ medium_pct }}%"></div>
          {% endif %}
          {% if low_pct > 0 %}
          <div class="alert-bar-seg-v2 alert-bar-seg-low" style="width: {{ low_pct }}%;" title="Baja: {{ low_pct }}%"></div>
          {% endif %}
        </div>
      </div>
      <div class="exec-alerts-footer">
        <span class="exec-alerts-hint">Proporción de alertas (no listado completo)</span>
        <span class="exec-alerts-total">{{ "{:,}".format(alerts_summary.total_count) }} alertas</span>
      </div>
    </div>
  </div>
  {% endif %}

  {# E) Visual Insights - Two charts side by side #}
  <div class="dash-charts-grid">
    <div class="chart-card">
      <div class="chart-title"><i class="bi bi-bar-chart-fill me-2"></i>Distribución por tienda (Top 10)</div>
      <div id="chartStoreDistribution" class="chart-container"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title"><i class="bi bi-heart-pulse-fill me-2"></i>CD Stock Health Overview</div>
      <div id="chartCDHealth" class="chart-container"></div>
    </div>
  </div>

  {# F) Details Accordion (tables collapsed by default) #}
  <div class="details-accordion">
    <div class="accordion" id="dashDetailsAccordion">
      
      {# Predictions table accordion #}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDistribution">
            <i class="bi bi-diagram-3 me-2"></i>Detalle distribución sugerida
            <span class="badge bg-primary ms-2">{{ pred_pagination.total if pred_pagination is defined and pred_pagination else (predictions|length if predictions else 0) }}</span>
          </button>
        </h2>
        <div id="collapseDistribution" class="accordion-collapse collapse" data-bs-parent="#dashDetailsAccordion">
          <div class="accordion-body">
            <div class="dashv1-panel-head">
              <div class="dashv1-panel-title-group">
                <span class="dashv1-panel-title">Distribución sugerida</span>
                {% if predictions and predictions|length > 0 %}
                  {% set subtitle_text = predictions[0][0].model_name if predictions[0][0].model_name else '' %}
                  <span class="dashv1-subtitle dash-subtitle-truncate" title="{{ subtitle_text }}">{{ subtitle_text }}</span>
                {% endif %}
                <span class="badge bg-light text-muted ms-2" style="font-size:0.7rem;"><i class="bi bi-funnel"></i> Solo qty &gt; 0</span>
              </div>
              <div class="dashv1-panel-tools">
                {% if current_user.has_permission('admin:reset') %}
                <div class="dash-quick-actions">
                  <form method="post" action="{{ url_for('reset_sales') }}" onsubmit="return confirm('¿Eliminar TODAS las ventas?')"><button type="submit" class="qa-btn" title="Reset ventas"><i class="bi bi-trash3"></i></button></form>
                  <form method="post" action="{{ url_for('reset_predictions') }}" onsubmit="return confirm('¿Eliminar TODAS las distribuciones?')"><button type="submit" class="qa-btn" title="Reset distribuciones"><i class="bi bi-diagram-3"></i></button></form>
                  <form method="post" action="{{ url_for('reset_store_stock') }}" onsubmit="return confirm('¿Eliminar TODO el stock de tiendas?')"><button type="submit" class="qa-btn" title="Reset stock tiendas"><i class="bi bi-shop"></i></button></form>
                  <form method="post" action="{{ url_for('reset_stock_cd') }}" onsubmit="return confirm('¿Eliminar TODO el stock del CD?')"><button type="submit" class="qa-btn" title="Reset stock CD"><i class="bi bi-box-seam"></i></button></form>
                </div>
                {% endif %}
                <input class="form-control form-control-sm dashv1-search" placeholder="Buscar SKU" value="{{ pred_search if pred_search is defined else '' }}" onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('pred_search', this.value, 'pred_page');}">
                {% if selected_run_id %}
                  <a class="btn btn-primary dashv1-btn-export" href="{{ url_for('export_predictions', run_id=selected_run_id) }}">Exportar</a>
                {% else %}
                  <button class="btn btn-outline-secondary dashv1-btn-export" disabled>Exportar</button>
                {% endif %}
              </div>
            </div>

            <div class="dashv1-tablewrap dash-table-scroll">
              <table class="table table-sm mb-0 dashv1-table dash-table">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Producto</th>
                    <th>Tienda</th>
                    <th class="text-end">Cant.</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody>
                  {% set pred_rows = pred_pagination.items if (pred_pagination is defined and pred_pagination) else predictions %}
                  {% if pred_rows and pred_rows|length > 0 %}
                    {% set display_rows = pred_rows if (pred_pagination is defined and pred_pagination) else pred_rows[:10] %}
                    {% for p, prod, st in display_rows %}
                      <tr>
                        <td class="dashv1-mono">{{ prod.sku }}</td>
                        <td>{{ prod.name }}</td>
                        <td>{{ st.name }}</td>
                        <td class="text-end">{{ "{:,}".format(p.quantity|int) }}</td>
                        <td class="text-center">
                          <button class="explain-btn" onclick="showDistExplanation({{ prod.id }}, {{ st.id }}, {{ p.quantity }}, '{{ selected_run_id or '' }}')" title="¿Por qué?">
                            <i class="bi bi-question-circle"></i>
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="5" class="dash-empty-cell">
                      <div class="dash-empty-wrap">
                        <i class="bi bi-inbox dash-empty-icon"></i>
                        <div class="dash-empty-title">Sin predicciones</div>
                        <div class="dash-empty-hint">Carga ventas para generar distribución</div>
                      </div>
                    </td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            {% if pred_pagination is defined and pred_pagination %}
              {{ pagination_controls(pred_pagination, 'pred_page', 'pred_size', pred_size) }}
            {% endif %}
          </div>
        </div>
      </div>

      {# Remanente CD table accordion #}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRemanente">
            <i class="bi bi-archive me-2"></i>Detalle remanente CD
            <span class="badge bg-secondary ms-2">{{ cd_pagination.total if cd_pagination is defined and cd_pagination else (stock_cd_filtered|length if stock_cd_filtered else 0) }}</span>
          </button>
        </h2>
        <div id="collapseRemanente" class="accordion-collapse collapse" data-bs-parent="#dashDetailsAccordion">
          <div class="accordion-body">
            <div class="dashv1-panel-head">
              <div class="dashv1-panel-title-group">
                <span class="dashv1-panel-title">Remanente CD</span>
                <span class="dashv1-subtitle">saldo mínimo CD pos distribución seleccionada</span>
              </div>
              <div class="dashv1-panel-tools">
                <input class="form-control form-control-sm dashv1-search" placeholder="Buscar SKU..." value="{{ cd_search if cd_search is defined else '' }}" onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('cd_search', this.value, 'cd_page');}">
                {% if selected_run_id %}
                  <a class="btn btn-outline-secondary dashv1-btn-export" href="{{ url_for('export_cd_remanente', run_id=selected_run_id) }}">Exportar remanente</a>
                {% else %}
                  <button class="btn btn-outline-secondary dashv1-btn-export" disabled>Exportar remanente</button>
                {% endif %}
              </div>
            </div>

            <div class="dashv1-tablewrap dash-table-scroll">
              <table class="table table-sm mb-0 dashv1-table dash-table">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Producto</th>
                    <th class="text-end">Stock CD disponible</th>
                  </tr>
                </thead>
                <tbody>
                  {% set cd_rows = cd_pagination.items if (cd_pagination is defined and cd_pagination) else stock_cd_filtered %}
                  {% if cd_rows and cd_rows|length > 0 %}
                    {% set display_cd = cd_rows if (cd_pagination is defined and cd_pagination) else cd_rows[:10] %}
                    {% for cd, prod in display_cd %}
                      <tr>
                        <td class="dashv1-mono">{{ prod.sku }}</td>
                        <td>{{ prod.name }}</td>
                        <td class="text-end">{{ "{:,}".format(cd.quantity|int) }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="3" class="dash-empty-cell">
                      <div class="dash-empty-wrap">
                        <i class="bi bi-box dash-empty-icon"></i>
                        <div class="dash-empty-title">Sin remanente CD</div>
                        <div class="dash-empty-hint">Carga stock CD o ejecuta una nueva distribución</div>
                      </div>
                    </td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            {% if cd_pagination is defined and cd_pagination %}
              {{ pagination_controls(cd_pagination, 'cd_page', 'cd_size', cd_size) }}
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

{# Explain Modal #}
<div class="modal fade" id="explainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content explain-modal-content">
      <div class="modal-header explain-modal-header">
        <h5 class="modal-title"><i class="bi bi-lightbulb me-2"></i>¿Por qué esta sugerencia?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body explain-modal-body">
        <div class="explain-header">
          <div class="explain-sku" id="explainSku"></div>
          <div class="explain-product" id="explainProduct"></div>
          <div class="explain-store" id="explainStore"></div>
        </div>
        <div class="explain-qty">
          <span class="explain-qty-label">Cantidad sugerida:</span>
          <span class="explain-qty-value" id="explainQty"></span>
        </div>
        <ul class="explain-bullets" id="explainBullets"></ul>
      </div>
    </div>
  </div>
</div>

{# Plotly CDN #}
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<script>
function updateParam(param, value, resetPageParam) {
  const url = new URL(window.location.href);
  url.searchParams.set(param, value);
  if (resetPageParam && param !== resetPageParam) url.searchParams.set(resetPageParam, 1);
  window.location.href = url.toString();
}

let explainModal = null;
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('explainModal');
  if (modalEl && typeof bootstrap !== 'undefined') {
    explainModal = new bootstrap.Modal(modalEl);
  }
  
  // Build charts from page data
  buildCharts();
});

function buildCharts() {
  // Chart 1: Distribution by Store (Top 10)
  // Raw prediction data - will aggregate in JS
  const rawPredictions = [
    {% if predictions and predictions|length > 0 %}
      {% for p, prod, st in predictions %}
        {store: "{{ st.name }}", qty: {{ p.quantity }}},
      {% endfor %}
    {% endif %}
  ];
  
  // Aggregate by store in JavaScript
  const storeAgg = {};
  rawPredictions.forEach(item => {
    if (storeAgg[item.store]) {
      storeAgg[item.store] += item.qty;
    } else {
      storeAgg[item.store] = item.qty;
    }
  });
  
  // Convert to array and sort
  const storeData = Object.entries(storeAgg).map(([store, qty]) => ({store, qty}));
  storeData.sort((a, b) => b.qty - a.qty);
  const top10Stores = storeData.slice(0, 10);
  
  if (top10Stores.length > 0) {
    Plotly.newPlot('chartStoreDistribution', [{
      x: top10Stores.map(d => d.store),
      y: top10Stores.map(d => d.qty),
      type: 'bar',
      marker: { color: '#3b82f6', cornerradius: 4 }
    }], {
      margin: { t: 20, b: 80, l: 50, r: 20 },
      xaxis: { tickangle: -45, tickfont: { size: 10 } },
      yaxis: { title: 'Unidades' },
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent'
    }, { responsive: true, displayModeBar: false });
  } else {
    document.getElementById('chartStoreDistribution').innerHTML = '<div class="chart-empty"><i class="bi bi-bar-chart"></i><span>Sin datos de distribución</span></div>';
  }
  
  // Chart 2: CD Stock Health Donut
  const cdHealthData = {
    healthy: {{ cd_health_data.healthy if cd_health_data else 0 }},
    slow: {{ cd_health_data.slow if cd_health_data else 0 }},
    dead: {{ cd_health_data.dead if cd_health_data else 0 }},
    allocated: {{ cd_health_data.allocated if cd_health_data else 0 }}
  };
  
  const totalHealth = cdHealthData.healthy + cdHealthData.slow + cdHealthData.dead + cdHealthData.allocated;
  
  if (totalHealth > 0) {
    const labels = ['Saludable', 'Lento', 'Muerto', 'Asignado'];
    const values = [cdHealthData.healthy, cdHealthData.slow, cdHealthData.dead, cdHealthData.allocated];
    const colors = ['#10b981', '#f59e0b', '#ef4444', '#6366f1'];
    
    const percentages = values.map(v => ((v / totalHealth) * 100).toFixed(1));
    const hoverText = values.map((v, i) => `${labels[i]}: ${v.toLocaleString()} uds (${percentages[i]}%)`);
    
    Plotly.newPlot('chartCDHealth', [{
      values: values,
      labels: labels,
      type: 'pie',
      hole: 0.5,
      marker: { colors: colors },
      textinfo: 'percent',
      textposition: 'outside',
      textfont: { size: 11 },
      hoverinfo: 'text',
      hovertext: hoverText,
      pull: [0, 0, 0.02, 0]
    }], {
      margin: { t: 30, b: 30, l: 30, r: 30 },
      paper_bgcolor: 'transparent',
      showlegend: true,
      legend: { orientation: 'h', y: -0.1, x: 0.5, xanchor: 'center', font: { size: 10 } },
      annotations: [{
        text: `<b>${totalHealth.toLocaleString()}</b><br>Total`,
        showarrow: false,
        font: { size: 14, color: '#374151' }
      }]
    }, { responsive: true, displayModeBar: false });
  } else {
    document.getElementById('chartCDHealth').innerHTML = '<div class="chart-empty"><i class="bi bi-heart-pulse"></i><span>Sin datos de stock CD</span></div>';
  }
}

async function showDistExplanation(productId, storeId, qty, runId) {
  if (!explainModal) {
    const modalEl = document.getElementById('explainModal');
    if (modalEl && typeof bootstrap !== 'undefined') {
      explainModal = new bootstrap.Modal(modalEl);
    } else {
      alert('Error: No se puede mostrar la explicación');
      return;
    }
  }
  
  document.getElementById('explainSku').textContent = 'Cargando...';
  document.getElementById('explainProduct').textContent = '';
  document.getElementById('explainStore').textContent = '';
  document.getElementById('explainQty').textContent = qty;
  document.getElementById('explainBullets').innerHTML = '<li>Cargando explicación...</li>';
  explainModal.show();
  
  try {
    const params = new URLSearchParams({
      product_id: productId,
      store_id: storeId,
      qty: qty,
      run_id: runId || ''
    });
    const resp = await fetch('/api/explain/distribution?' + params);
    const data = await resp.json();
    
    if (!resp.ok || data.error) {
      document.getElementById('explainBullets').innerHTML = '<li>' + (data.error || 'Error al cargar explicación') + '</li>';
      return;
    }
    
    document.getElementById('explainSku').textContent = 'SKU: ' + (data.sku || 'N/A');
    document.getElementById('explainProduct').textContent = data.product_name || 'Producto desconocido';
    document.getElementById('explainStore').textContent = 'Tienda: ' + (data.store_name || 'N/A');
    document.getElementById('explainQty').textContent = data.quantity || qty;
    
    const bullets = data.bullets || [];
    const bulletsHtml = bullets.length > 0 
      ? bullets.map(b => '<li>' + b + '</li>').join('')
      : '<li>Sin información disponible</li>';
    document.getElementById('explainBullets').innerHTML = bulletsHtml;
  } catch (err) {
    document.getElementById('explainBullets').innerHTML = '<li>Error al cargar explicación: ' + err.message + '</li>';
  }
}
</script>

<style>
/* Macro Grid - 3 KPI cards */
.macro-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}
@media (max-width: 768px) {
  .macro-grid { grid-template-columns: 1fr; }
}
.macro-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  border: 1px solid #e2e8f0;
}
.macro-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
}
.macro-card-stores .macro-icon { background: #dbeafe; color: #2563eb; }
.macro-card-cd .macro-icon { background: #d1fae5; color: #059669; }
.macro-card-units .macro-icon { background: #fef3c7; color: #d97706; }
.macro-body { flex: 1; }
.macro-title { font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 600; letter-spacing: 0.5px; }
.macro-value { font-size: 1.75rem; font-weight: 700; color: #1e293b; line-height: 1.2; }
.macro-sub { font-size: 0.8rem; color: #94a3b8; }

/* Dashboard KPI hierarchy */
.macro-grid-hierarchy {
  grid-template-columns: 1.15fr 1fr 1fr;
}
@media (max-width: 768px) {
  .macro-grid-hierarchy { grid-template-columns: 1fr; }
}
.macro-card-primary {
  border: 1.5px solid #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08), 0 2px 6px rgba(0,0,0,0.06);
}
.macro-card-primary .macro-value {
  font-size: 2rem;
}
.macro-card-primary .macro-icon {
  width: 52px;
  height: 52px;
  font-size: 1.35rem;
}
.macro-card-primary .macro-sub {
  font-size: 0.75rem;
  color: #64748b;
}
.macro-card-secondary {
  border: 1px solid #e2e8f0;
}
.macro-card-secondary .macro-value {
  font-size: 1.6rem;
}
.macro-card-secondary .macro-sub {
  font-size: 0.7rem;
}

/* Dashboard alerts polish - Executive v2 */
.exec-alerts-v2 {
  background: #fff;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.exec-alerts-v2 .exec-alerts-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.exec-alerts-v2 .exec-alerts-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  color: #475569;
}
.exec-alerts-v2 .exec-alerts-title i { color: #94a3b8; font-size: 1rem; }
.exec-alerts-v2 .exec-alerts-btn { font-size: 0.75rem; padding: 4px 12px; }
.exec-alerts-body { display: flex; flex-direction: column; gap: 12px; }
.alert-chips-v2 { display: flex; gap: 10px; }
.alert-chip-v2 {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 6px;
  background: #f8fafc;
}
.alert-chip-v2-high { background: #fef2f2; }
.alert-chip-v2-med { background: #fff7ed; }
.alert-chip-v2-low { background: #fefce8; }
.alert-chip-v2-pct { font-size: 0.875rem; font-weight: 600; }
.alert-chip-v2-high .alert-chip-v2-pct { color: #b91c1c; }
.alert-chip-v2-med .alert-chip-v2-pct { color: #c2410c; }
.alert-chip-v2-low .alert-chip-v2-pct { color: #a16207; }
.alert-chip-v2-label { font-size: 0.7rem; text-transform: uppercase; color: #64748b; letter-spacing: 0.3px; }
.alert-bar-wrap { max-width: 65%; }
.alert-bar-v2 {
  height: 6px;
  background: #f1f5f9;
  border-radius: 3px;
  display: flex;
  overflow: hidden;
}
.alert-bar-seg-v2 { height: 100%; transition: width 0.3s ease; }
.alert-bar-seg-high { background: #fca5a5; }
.alert-bar-seg-med { background: #fdba74; }
.alert-bar-seg-low { background: #fde047; }
.exec-alerts-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 4px;
}
.exec-alerts-hint { font-size: 0.7rem; color: #94a3b8; font-style: italic; }
.exec-alerts-total { font-size: 0.7rem; color: #64748b; }

/* Charts Grid */
.dash-charts-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}
@media (max-width: 992px) {
  .dash-charts-grid { grid-template-columns: 1fr; }
}
.chart-card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.chart-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
}
.chart-title i { color: #64748b; }
.chart-container { height: 280px; }
.chart-empty {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  gap: 8px;
}
.chart-empty i { font-size: 2rem; opacity: 0.5; }
.chart-empty span { font-size: 0.875rem; }

/* Details Accordion */
.details-accordion {
  margin-bottom: 20px;
}
.details-accordion .accordion-item {
  border: 1px solid #e2e8f0;
  border-radius: 12px !important;
  margin-bottom: 12px;
  overflow: hidden;
}
.details-accordion .accordion-button {
  font-weight: 600;
  color: #1e293b;
  background: #f8fafc;
}
.details-accordion .accordion-button:not(.collapsed) {
  background: #fff;
  color: #3b82f6;
  box-shadow: none;
}
.details-accordion .accordion-button::after {
  background-size: 1rem;
}
.details-accordion .accordion-body {
  padding: 16px;
}

/* Explain Button */
.explain-btn {
  background: transparent;
  border: none;
  color: #64748b;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.15s ease;
}
.explain-btn:hover {
  background: #f1f5f9;
  color: #3b82f6;
}
.explain-modal-content {
  border-radius: 16px;
  border: none;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}
.explain-modal-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: #fff;
  border-radius: 16px 16px 0 0;
  padding: 16px 20px;
}
.explain-modal-header .btn-close {
  filter: brightness(0) invert(1);
}
.explain-modal-body {
  padding: 20px;
}
.explain-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e2e8f0;
}
.explain-sku {
  font-family: 'SF Mono', 'Consolas', monospace;
  font-size: 0.875rem;
  color: #3b82f6;
  font-weight: 600;
}
.explain-product {
  font-size: 1.1rem;
  font-weight: 600;
  color: #1e293b;
  margin-top: 4px;
}
.explain-store {
  font-size: 0.875rem;
  color: #64748b;
  margin-top: 4px;
}
.explain-qty {
  background: #f0fdf4;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.explain-qty-label {
  font-size: 0.875rem;
  color: #15803d;
}
.explain-qty-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: #15803d;
}
.explain-bullets {
  list-style: none;
  padding: 0;
  margin: 0;
}
.explain-bullets li {
  padding: 8px 0 8px 24px;
  position: relative;
  font-size: 0.875rem;
  color: #334155;
  border-bottom: 1px solid #f1f5f9;
}
.explain-bullets li:last-child {
  border-bottom: none;
}
.explain-bullets li::before {
  content: '•';
  position: absolute;
  left: 8px;
  color: #3b82f6;
  font-weight: bold;
}
</style>
{% endblock %}
