{% extends 'base.html' %}
{% block content %}

{# Pagination controls macro #}
{% macro pagination_controls(pag, page_param, size_param, size_val) %}
<div class="dashv1-pagination">
  <small class="text-muted">{{ pag.total }} registros</small>
  <div class="d-flex align-items-center gap-2">
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if not pag.has_prev %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.prev_num or 1 }})">Ant</a>
        </li>
        {% for p in pag.iter_pages() %}
          {% if p %}
            <li class="page-item {% if p == pag.page %}active{% endif %}">
              <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ p }})">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pag.has_next %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.next_num or pag.pages }})">Sig</a>
        </li>
      </ul>
    </nav>
    <select class="form-select form-select-sm" style="width:60px;" onchange="updateParam('{{ size_param }}', this.value, '{{ page_param }}')">
      <option value="10" {% if size_val == 10 %}selected{% endif %}>10</option>
      <option value="25" {% if size_val == 25 %}selected{% endif %}>25</option>
      <option value="50" {% if size_val == 50 %}selected{% endif %}>50</option>
    </select>
  </div>
</div>
{% endmacro %}

<div class="dashv1">

  {# Simulation alerts #}
  {% if active_simulations is defined and active_simulations %}
  <div class="dashv1-alert dashv1-alert-warning">
    <div class="dashv1-alert-content">
      <div class="dashv1-alert-icon">
        <i class="bi bi-lightning-charge"></i>
      </div>
      <div class="dashv1-alert-text">
        <strong>Simulaciones activas:</strong>
        {% for sim_type, sim_data in active_simulations.items() %}
          <span class="dashv1-badge-warning">{{ sim_type|capitalize }}</span>
        {% endfor %}
      </div>
      <a href="{{ url_for('clear_simulation_route', sim_type='all', redirect='dashboard') }}" class="btn btn-sm btn-outline-warning">Limpiar</a>
    </div>
  </div>
  {% endif %}

  {# A) Run summary strip #}
  <div class="dashv1-runstrip">
    {% if runs is defined and runs and selected_run_id %}
      {% set current_run = runs|selectattr('run_id', 'equalto', selected_run_id)|first %}
      {% if current_run %}
        <span class="dashv1-runtext">
          Folio: <strong>{{ folio if folio else 'N/A' }}</strong>
          {% if responsable %} | Resp: <strong>{{ responsable }}</strong>{% endif %}
          {% if current_run.created_at %} — <span class="text-muted">{{ current_run.created_at.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
        </span>
      {% else %}
        <span class="dashv1-runtext">Corrida activa: —</span>
      {% endif %}
    {% else %}
      <span class="dashv1-runtext">Corrida activa: —</span>
    {% endif %}
  </div>

  {# B) Filters row #}
  <form class="dashv1-filters" method="get" action="{{ url_for('dashboard') }}">
    <div class="dashv1-filter">
      <label class="dashv1-label">Corrida</label>
      <select class="form-select form-select-sm dashv1-input" name="run_id">
        {% for r in runs %}
          <option value="{{ r.run_id }}" {% if selected_run_id == r.run_id %}selected{% endif %}>
            {{ r.label() if r.label is callable else r.run_id[:8] }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Tiendas</label>
      <select class="form-select form-select-sm dashv1-input" name="store">
        <option value="">Todas las tiendas</option>
        {% for s in stores %}
          <option value="{{ s.name }}" {% if selected_store == s.name %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Folio</label>
      <input class="form-control form-control-sm dashv1-input" name="folio" value="{{ folio or '' }}" placeholder="Folio">
    </div>

    <div class="dashv1-filter">
      <label class="dashv1-label">Responsable</label>
      <input class="form-control form-control-sm dashv1-input" name="responsable" value="{{ responsable or '' }}" placeholder="Responsable">
    </div>

    <div class="dashv1-actions">
      <button class="btn btn-primary dashv1-btn-apply">Aplicar filtros</button>
      <a class="btn btn-outline-secondary dashv1-btn-clear" href="{{ url_for('dashboard') }}">Limpiar</a>
    </div>
  </form>

  {# C) KPI row (2 cards only) #}
  <div class="dashv1-kpis">
    <div class="dashv1-kpi dash-kpi-card dash-kpi-art-sales">
      <div class="dashv1-kpi-badge dashv1-kpi-badge-blue">
        <i class="bi bi-box-seam"></i>
      </div>
      <div class="dashv1-kpi-body">
        <div class="dashv1-kpi-label">Top productos vendidos</div>
        <div class="dashv1-kpi-number">
          {% set top_units = namespace(value=0) %}
          {% if top_sales is defined and top_sales %}
            {% for r in top_sales %}
              {% set top_units.value = top_units.value + (r.units if r.units is defined else 0) %}
            {% endfor %}
          {% else %}
            {% set top_units.value = (kpi_units_suggested if kpi_units_suggested is defined else 0) %}
          {% endif %}
          {{ "{:,}".format(top_units.value|int) }}
        </div>
        <div class="dashv1-kpi-sub">últimos 7 días</div>
      </div>
      <div class="dash-kpi-art"></div>
    </div>

    <div class="dashv1-kpi dash-kpi-card dash-kpi-art-cd">
      <div class="dashv1-kpi-badge dashv1-kpi-badge-green">
        <i class="bi bi-archive"></i>
      </div>
      <div class="dashv1-kpi-body">
        <div class="dashv1-kpi-label">Stock CD hoy</div>
        <div class="dashv1-kpi-number">{{ "{:,}".format(kpi_stock_cd_total|int if kpi_stock_cd_total is defined else 0) }}</div>
        <div class="dashv1-kpi-sub">disponible</div>
      </div>
      <div class="dash-kpi-art"></div>
    </div>
  </div>

  {# D) Main panel (predictions + remanente in ONE card) #}
  <div class="dashv1-panel">

    {# Predictions header #}
    <div class="dashv1-panel-head">
      <div class="dashv1-panel-title-group">
        <span class="dashv1-panel-title">Distribución sugerida</span>
        {% if predictions and predictions|length > 0 %}
          <span class="dashv1-subtitle">{{ predictions[0][0].model_name if predictions[0][0].model_name else '' }}</span>
        {% endif %}
      </div>
      <div class="dashv1-panel-tools">
        {% if current_user.has_permission('admin:reset') %}
        <div class="dash-quick-actions">
          <form method="post" action="{{ url_for('reset_sales') }}" onsubmit="return confirm('¿Eliminar TODAS las ventas?')"><button type="submit" class="qa-btn" title="Reset ventas"><i class="bi bi-trash3"></i></button></form>
          <form method="post" action="{{ url_for('reset_predictions') }}" onsubmit="return confirm('¿Eliminar TODAS las distribuciones?')"><button type="submit" class="qa-btn" title="Reset distribuciones"><i class="bi bi-diagram-3"></i></button></form>
          <form method="post" action="{{ url_for('reset_store_stock') }}" onsubmit="return confirm('¿Eliminar TODO el stock de tiendas?')"><button type="submit" class="qa-btn" title="Reset stock tiendas"><i class="bi bi-shop"></i></button></form>
          <form method="post" action="{{ url_for('reset_stock_cd') }}" onsubmit="return confirm('¿Eliminar TODO el stock del CD?')"><button type="submit" class="qa-btn" title="Reset stock CD"><i class="bi bi-box-seam"></i></button></form>
        </div>
        {% endif %}
        <input class="form-control form-control-sm dashv1-search" placeholder="Buscar SKU" value="{{ pred_search if pred_search is defined else '' }}" onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('pred_search', this.value, 'pred_page');}">
        {% if selected_run_id %}
          <a class="btn btn-primary dashv1-btn-export" href="{{ url_for('export_predictions', run_id=selected_run_id) }}">Exportar</a>
        {% else %}
          <button class="btn btn-outline-secondary dashv1-btn-export" disabled>Exportar</button>
        {% endif %}
      </div>
    </div>

    {# Predictions table #}
    <div class="dashv1-tablewrap dash-table-scroll">
      <table class="table table-sm mb-0 dashv1-table dash-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th>Tienda</th>
            <th class="text-end">Cant.</th>
          </tr>
        </thead>
        <tbody>
          {% set pred_rows = pred_pagination.items if (pred_pagination is defined and pred_pagination) else predictions %}
          {% if pred_rows and pred_rows|length > 0 %}
            {% set display_rows = pred_rows if (pred_pagination is defined and pred_pagination) else pred_rows[:10] %}
            {% for p, prod, st in display_rows %}
              <tr>
                <td class="dashv1-mono">{{ prod.sku }}</td>
                <td>{{ prod.name }}</td>
                <td>{{ st.name }}</td>
                <td class="text-end">{{ "{:,}".format(p.quantity|int) }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="4" class="dashv1-empty">Sin predicciones para los filtros seleccionados.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if pred_pagination is defined and pred_pagination %}
      {{ pagination_controls(pred_pagination, 'pred_page', 'pred_size', pred_size) }}
    {% endif %}

    <div class="dashv1-divider"></div>

    {# Remanente header #}
    <div class="dashv1-panel-head">
      <div class="dashv1-panel-title-group">
        <span class="dashv1-panel-title">Remanente CD</span>
        <span class="dashv1-subtitle">saldo mínimo CD pos distribución seleccionada</span>
      </div>
      <div class="dashv1-panel-tools">
        <input class="form-control form-control-sm dashv1-search" placeholder="Buscar SKU..." value="{{ cd_search if cd_search is defined else '' }}" onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('cd_search', this.value, 'cd_page');}">
        {% if selected_run_id %}
          <a class="btn btn-outline-secondary dashv1-btn-export" href="{{ url_for('export_cd_remanente', run_id=selected_run_id) }}">Exportar remanente</a>
        {% else %}
          <button class="btn btn-outline-secondary dashv1-btn-export" disabled>Exportar remanente</button>
        {% endif %}
      </div>
    </div>

    {# Remanente table #}
    <div class="dashv1-tablewrap dash-table-scroll">
      <table class="table table-sm mb-0 dashv1-table dash-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Stock CD disponible</th>
          </tr>
        </thead>
        <tbody>
          {% set cd_rows = cd_pagination.items if (cd_pagination is defined and cd_pagination) else stock_cd_filtered %}
          {% if cd_rows and cd_rows|length > 0 %}
            {% set display_cd = cd_rows if (cd_pagination is defined and cd_pagination) else cd_rows[:10] %}
            {% for cd, prod in display_cd %}
              <tr>
                <td class="dashv1-mono">{{ prod.sku }}</td>
                <td>{{ prod.name }}</td>
                <td class="text-end">{{ "{:,}".format(cd.quantity|int) }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="3" class="dashv1-empty">Sin datos de Stock CD disponibles para este run.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if cd_pagination is defined and cd_pagination %}
      {{ pagination_controls(cd_pagination, 'cd_page', 'cd_size', cd_size) }}
    {% endif %}

  </div>
</div>

<script>
function updateParam(param, value, resetPageParam) {
  const url = new URL(window.location.href);
  url.searchParams.set(param, value);
  if (resetPageParam && param !== resetPageParam) url.searchParams.set(resetPageParam, 1);
  window.location.href = url.toString();
}
</script>
{% endblock %}
