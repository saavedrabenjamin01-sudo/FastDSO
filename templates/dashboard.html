{% extends 'base.html' %}
{% block content %}

{% macro pagination_controls(pag, page_param, size_param, search_param, search_val, size_val, table_id) %}
<div class="dash-pagination d-flex justify-content-between align-items-center flex-wrap gap-2 px-3 py-2">
  <div class="d-flex align-items-center gap-2">
    <small class="text-muted">{{ pag.total }} registros</small>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span class="text-muted small">Ant</span>
    <nav aria-label="Pagination">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if not pag.has_prev %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.prev_num or 1 }})"><i class="bi bi-chevron-left"></i></a>
        </li>
        {% for p in pag.iter_pages() %}
          {% if p %}
            <li class="page-item {% if p == pag.page %}active{% endif %}">
              <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ p }})">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pag.has_next %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.next_num or pag.pages }})"><i class="bi bi-chevron-right"></i></a>
        </li>
      </ul>
    </nav>
    <select class="form-select form-select-sm" style="width: 70px;" onchange="updateParam('{{ size_param }}', this.value, '{{ page_param }}')">
      <option value="10" {% if size_val == 10 %}selected{% endif %}>10</option>
      <option value="25" {% if size_val == 25 %}selected{% endif %}>25</option>
      <option value="50" {% if size_val == 50 %}selected{% endif %}>50</option>
    </select>
  </div>
</div>
{% endmacro %}

{% macro empty_state(icon, message, action_text, action_url) %}
<div class="text-center py-4">
  <div class="text-muted mb-2" style="font-size: 2rem;">{{ icon }}</div>
  <p class="text-muted mb-2">{{ message }}</p>
  {% if action_url %}
  <a href="{{ action_url }}" class="btn btn-sm btn-outline-primary">{{ action_text }}</a>
  {% endif %}
</div>
{% endmacro %}

<div class="dash-wrap">

  <div class="dash-topbar">
    <div class="dash-topbar-left">
      <div class="dash-topbar-icon">
        <i class="bi bi-grid-1x2-fill"></i>
      </div>
      <h1 class="dash-page-title">Panel</h1>
    </div>
    <div class="dash-topbar-right">
      <div class="dash-global-search">
        <i class="bi bi-search"></i>
        <input type="text" class="form-control form-control-sm" placeholder="Buscar (globalmente)" disabled>
      </div>
    </div>
  </div>

  {% if active_simulations %}
  <div class="alert alert-warning mb-0 dash-alert">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <i class="bi bi-lightning-charge me-2"></i>
        <strong>Simulaciones activas:</strong>
        {% for sim_type, sim_data in active_simulations.items() %}
          <span class="badge bg-warning text-dark me-1">
            {{ sim_type|capitalize }} ({{ sim_data.kpis.get('num_predictions', sim_data.kpis.get('num_moves', 0)) }} registros)
          </span>
        {% endfor %}
      </div>
      <div>
        <a href="{{ url_for('clear_simulation_route', sim_type='all', redirect='dashboard') }}" class="btn btn-sm btn-outline-warning">
          <i class="bi bi-x-circle me-1"></i>Limpiar todas
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="dash-filters-card">
    <form class="dash-filter-form" method="get" action="{{ url_for('dashboard') }}">
      
      <div class="dash-run-line">
        {% if runs and selected_run_id %}
        {% set current_run = runs|selectattr('run_id', 'equalto', selected_run_id)|first %}
        {% if current_run %}
        <span class="dash-run-folio">Folio: {{ current_run.folio or 'N/A' }}</span>
        <span class="dash-run-sep">|</span>
        <span class="dash-run-info">Repo {{ current_run.responsable or 'Sin responsable' }} - {{ current_run.created_at.strftime('%Y-%m-%d %H:%M') if current_run.created_at else '' }}</span>
        {% endif %}
        {% endif %}
      </div>

      <div class="dash-filter-row">
        <div class="dash-filter-item">
          <label class="dash-filter-label">Tiendas</label>
          <select class="form-select form-select-sm" id="store" name="store">
            <option value="">Todas</option>
            {% for s in stores %}
              <option value="{{ s.name }}" {% if selected_store == s.name %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="dash-filter-item dash-filter-grow">
          <label class="dash-filter-label">Buscar (texto o t√≠tulos al folio)</label>
          <div class="d-flex gap-2">
            <input type="text"
                   class="form-control form-control-sm"
                   id="folio"
                   name="folio"
                   value="{{ folio or '' }}"
                   placeholder="Ej: 300, Benjamin...">
            <input type="hidden" name="responsable" value="{{ responsable or '' }}">
            <input type="hidden" name="run_id" value="{{ selected_run_id or '' }}">
          </div>
        </div>

        <div class="dash-filter-actions">
          <button type="submit" class="btn btn-primary btn-sm">Aplicar filtros</button>
          <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Limpiar</a>
        </div>
      </div>
    </form>
  </div>

  <div class="dash-kpi-row">
    <div class="dash-kpi-tile">
      <div class="dash-kpi-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
      </div>
      <div class="dash-kpi-tile-content">
        <div class="dash-kpi-tile-label">Top productos vendidos</div>
        <div class="dash-kpi-tile-value">{{ "{:,}".format(kpi_skus_distintos) }}</div>
      </div>
    </div>

    <div class="dash-kpi-tile">
      <div class="dash-kpi-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
          <line x1="12" y1="22.08" x2="12" y2="12"/>
        </svg>
      </div>
      <div class="dash-kpi-tile-content">
        <div class="dash-kpi-tile-label">Stocked CD hoy</div>
        <div class="dash-kpi-tile-value">{{ "{:,}".format(kpi_stock_cd_total) }}</div>
      </div>
      {% if current_user.has_permission('admin:reset') %}
      <div class="dash-kpi-tile-menu">
        <div class="dropdown">
          <button class="btn btn-link btn-sm text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <form method="post" action="{{ url_for('reset_sales') }}" onsubmit="return confirm('¬øSeguro que deseas eliminar TODAS las ventas cargadas?')">
                <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash me-2"></i>Reset ventas</button>
              </form>
            </li>
            <li>
              <form method="post" action="{{ url_for('reset_predictions') }}" onsubmit="return confirm('¬øSeguro que deseas eliminar TODAS las distribuciones sugeridas?')">
                <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash me-2"></i>Reset distribuciones</button>
              </form>
            </li>
            <li>
              <form method="post" action="{{ url_for('reset_store_stock') }}" onsubmit="return confirm('¬øSeguro que deseas eliminar TODO el stock de tiendas?')">
                <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash me-2"></i>Reset stock tiendas</button>
              </form>
            </li>
            <li>
              <form method="post" action="{{ url_for('reset_stock_cd') }}" onsubmit="return confirm('¬øSeguro que deseas eliminar TODO el stock del CD?')">
                <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash me-2"></i>Reset stock CD</button>
              </form>
            </li>
          </ul>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="dash-main-table">
    <div class="dash-table-card">
      <div class="dash-table-header">
        <div class="dash-table-title">
          Distribuci√≥n sugerida
          {% if predictions %}
          <span class="dash-table-subtitle">‚Äî {{ predictions[0][0].model_name.split('‚Äî')[0] }}</span>
          {% endif %}
        </div>
        <div class="dash-table-actions">
          <input type="text" 
                 class="form-control form-control-sm dash-inline-search" 
                 placeholder="Buscar SKU" 
                 value="{{ pred_search }}"
                 onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('pred_search', this.value, 'pred_page');}">
          {% if selected_run_id %}
          <a class="btn btn-sm btn-primary" href="{{ url_for('export_predictions', run_id=selected_run_id) }}">Exportar</a>
          {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>Exportar</button>
          {% endif %}
        </div>
      </div>
      <div class="dash-table-body">
        <div class="table-responsive">
          <table class="table table-sm dash-table mb-0">
            <thead>
              <tr>
                <th>SKU#</th>
                <th>Tienda</th>
                <th>Tienda</th>
                <th class="text-end">Cant.</th>
                <th class="text-end">SKU1.</th>
              </tr>
            </thead>
            <tbody>
              {% if predictions %}
                {% for p, prod, st in predictions %}
                  <tr>
                    <td class="fw-medium">{{ prod.sku }}</td>
                    <td>{{ st.name }}</td>
                    <td>{{ st.name }}</td>
                    <td class="text-end">{{ "{:,}".format(p.quantity|int) }}</td>
                    <td class="text-end text-muted">{{ loop.index }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="5">{{ empty_state('üì¶', 'Sin predicciones para los filtros seleccionados.', 'Cargar ventas', url_for('upload')) }}</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      {% if pred_pagination %}
      {{ pagination_controls(pred_pagination, 'pred_page', 'pred_size', 'pred_search', pred_search, pred_size, 'pred') }}
      {% endif %}
    </div>
  </div>

  <div class="dash-remainder-section">
    <div class="dash-table-card">
      <div class="dash-table-header">
        <div class="dash-table-title">
          Remanente CD
          <span class="dash-table-subtitle">: saldo m√≠nimo CD pos distribuci√≥n seleccionada</span>
        </div>
        <div class="dash-table-actions">
          <input type="text" 
                 class="form-control form-control-sm dash-inline-search" 
                 placeholder="Buscar SKU..." 
                 value="{{ cd_search }}"
                 onkeydown="if(event.key==='Enter'){event.preventDefault();updateParam('cd_search', this.value, 'cd_page');}">
          {% if selected_run_id %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_cd_remanente', run_id=selected_run_id) }}">Exportar remanente</a>
          {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>Exportar remanente</button>
          {% endif %}
        </div>
      </div>
      <div class="dash-table-body">
        <div class="table-responsive">
          <table class="table table-sm dash-table mb-0">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th class="text-end">Stock CD disponible</th>
              </tr>
            </thead>
            <tbody>
              {% if stock_cd_filtered %}
                {% for cd, prod in stock_cd_filtered %}
                  <tr>
                    <td class="fw-medium">{{ prod.sku }}</td>
                    <td>{{ prod.name }}</td>
                    <td class="text-end fw-semibold">{{ "{:,}".format(cd.quantity|int) }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3">{{ empty_state('üè≠', 'Sin datos de Stock CD disponibles para los filtros seleccionados.', 'Cargar Stock CD', url_for('upload_stock_cd')) }}</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      {% if cd_pagination %}
      {{ pagination_controls(cd_pagination, 'cd_page', 'cd_size', 'cd_search', cd_search, cd_size, 'cd') }}
      {% endif %}
    </div>
  </div>

</div>

<script>
function updateParam(param, value, resetPageParam) {
  const url = new URL(window.location.href);
  url.searchParams.set(param, value);
  if (resetPageParam && param !== resetPageParam) {
    url.searchParams.set(resetPageParam, 1);
  }
  window.location.href = url.toString();
}
</script>

{% endblock %}
