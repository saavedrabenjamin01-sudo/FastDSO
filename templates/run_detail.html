{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h5 class="mb-0">
      {% if run.run_type == 'sales_upload' %}
        Detalle: Carga de Ventas
      {% elif run.run_type == 'distribution' %}
        Detalle: Distribucion Sugerida
      {% elif run.run_type == 'forecast_v2' %}
        Detalle: Forecast Compra V2
      {% else %}
        Detalle de Corrida
      {% endif %}
    </h5>
    <small class="text-muted">
      Run ID: {{ run.run_id[:8] }} | {{ run.created_at.strftime('%Y-%m-%d %H:%M') if run.created_at else '-' }}
    </small>
  </div>
  <a href="{{ url_for('runs') }}" class="btn btn-outline-secondary btn-sm">Volver</a>
</div>

<div class="card mb-3">
  <div class="card-header">Metadatos</div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3"><strong>Folio:</strong> {{ run.folio or '-' }}</div>
      <div class="col-md-3"><strong>Responsable:</strong> {{ run.responsable or '-' }}</div>
      <div class="col-md-3"><strong>Categoria:</strong> {{ run.categoria or '-' }}</div>
      <div class="col-md-3"><strong>Tienda:</strong> {{ run.store_filter or '-' }}</div>
    </div>
    <div class="row mt-2">
      <div class="col-md-6"><strong>Modo:</strong> {{ run.mode or '-' }}</div>
      <div class="col-md-6"><strong>Notas:</strong> {{ run.notes or '-' }}</div>
    </div>
  </div>
</div>

{% if run.run_type in ['distribution', 'forecast_v2'] %}
<div class="card mb-3 border-0" style="background:linear-gradient(135deg,#f0f4ff 0%,#e8eeff 100%);border-radius:12px;">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="d-flex align-items-center gap-2">
        <span style="font-size:1.3rem;">游뱄</span>
        <h6 class="mb-0 fw-semibold">GPT V1 Cross FastDSO</h6>
      </div>
      <span class="badge" id="aiStatusBadge" style="display:none;"></span>
    </div>

    <div id="aiDisabled" style="display:none;">
      <div class="text-muted small"><i class="bi bi-info-circle me-1"></i>AI est치 deshabilitado. Configure <code>AI_ENABLED=true</code> para activar.</div>
    </div>

    <div id="aiActions" style="display:none;">
      <div class="d-flex gap-2 flex-wrap mb-3">
        <button class="btn btn-sm btn-outline-primary" id="btnAiGenerate" onclick="aiGenerate()">
          <i class="bi bi-stars me-1"></i>Analizar corrida con AI
        </button>
      </div>
      <div id="aiLoading" style="display:none;" class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="ms-2 text-muted small">Consultando AI...</span>
      </div>
      <div id="aiError" style="display:none;" class="alert alert-danger py-2 small"></div>
      <div id="aiResult" style="display:none;">
        <ul class="nav nav-pills nav-fill mb-3" role="tablist" id="aiTabs">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#aiTabResumen" type="button" role="tab">
              <i class="bi bi-file-text me-1"></i>Resumen
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#aiTabAnomalias" type="button" role="tab">
              <i class="bi bi-exclamation-triangle me-1"></i>Anomal칤as
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#aiTabAcciones" type="button" role="tab">
              <i class="bi bi-lightning me-1"></i>Acciones
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#aiTabParams" type="button" role="tab">
              <i class="bi bi-sliders me-1"></i>Par치metros
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#aiTabSalud" type="button" role="tab">
              <i class="bi bi-heart-pulse me-1"></i>Salud
            </button>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="aiTabResumen" role="tabpanel">
            <div id="aiResumenContent" class="ai-md-content"></div>
          </div>
          <div class="tab-pane fade" id="aiTabAnomalias" role="tabpanel">
            <div id="aiAnomaliasContent"></div>
          </div>
          <div class="tab-pane fade" id="aiTabAcciones" role="tabpanel">
            <div id="aiAccionesContent"></div>
          </div>
          <div class="tab-pane fade" id="aiTabParams" role="tabpanel">
            <div id="aiParamsContent"></div>
          </div>
          <div class="tab-pane fade" id="aiTabSalud" role="tabpanel">
            <div id="aiSaludContent"></div>
          </div>
        </div>
        <div class="text-muted small mt-2" id="aiMeta"></div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if run.run_type == 'distribution' and predictions %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Distribuci칩n Sugerida (Top 100)</span>
    <span class="badge bg-light text-muted" style="font-size:0.7rem;"><i class="bi bi-funnel"></i> Solo qty &gt; 0</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th>Tienda</th>
            <th class="text-end">Cantidad</th>
          </tr>
        </thead>
        <tbody>
          {% for p, prod, store in predictions %}
          <tr>
            <td>{{ prod.sku }}</td>
            <td>{{ prod.name }}</td>
            <td>{{ store.name }}</td>
            <td class="text-end">{{ p.quantity }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if run.run_type == 'forecast_v2' and forecast_results %}
<div class="card">
  <div class="card-header">Forecast Compra V2 (Top 100)</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Demanda/sem</th>
            <th class="text-end">Stock CD</th>
            <th class="text-end">Requerido</th>
            <th class="text-end">Sugerido</th>
            <th>Campana</th>
          </tr>
        </thead>
        <tbody>
          {% for fr in forecast_results %}
          <tr>
            <td>{{ fr.sku }}</td>
            <td>{{ fr.name }}</td>
            <td class="text-end">{{ fr.demand_per_week }}</td>
            <td class="text-end">{{ fr.available_cd }}</td>
            <td class="text-end">{{ fr.required_units }}</td>
            <td class="text-end fw-semibold">{{ fr.suggested }}</td>
            <td>{{ fr.campaign_tag or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if run.run_type == 'sales_upload' and sales_summary %}
<div class="card">
  <div class="card-header">Resumen de Ventas (Top 50 SKUs)</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Total Unidades</th>
          </tr>
        </thead>
        <tbody>
          {% for sku, name, total_qty in sales_summary %}
          <tr>
            <td>{{ sku }}</td>
            <td>{{ name }}</td>
            <td class="text-end">{{ total_qty }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if run.run_type in ['distribution', 'forecast_v2'] %}
<style>
.ai-md-content { font-size: 0.9rem; line-height: 1.6; }
.ai-kpi-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; background: #e8eeff; font-size: 0.8rem; font-weight: 600; margin: 2px; }
.ai-kpi-chip .kpi-val { color: #2c3e50; }
.ai-kpi-chip .kpi-label { color: #6c757d; font-weight: 400; }
.ai-anomaly-card { border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #dee2e6; }
.ai-anomaly-high { border-left: 4px solid #dc3545; background: #fff5f5; }
.ai-anomaly-medium { border-left: 4px solid #ffc107; background: #fffdf0; }
.ai-anomaly-low { border-left: 4px solid #0d6efd; background: #f0f4ff; }
.ai-action-card { border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; border: 1px solid #dee2e6; background: #fff; }
.ai-scope-chip { display: inline-block; padding: 1px 6px; border-radius: 4px; background: #f1f3f5; font-size: 0.75rem; margin: 1px; color: #495057; }
.ai-health-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
.ai-health-high { background: #d4edda; color: #155724; }
.ai-health-medium { background: #fff3cd; color: #856404; }
.ai-health-low { background: #f8d7da; color: #721c24; }
.ai-param-table { width: 100%; font-size: 0.85rem; }
.ai-param-table th { font-weight: 600; color: #6c757d; padding: 6px 8px; border-bottom: 2px solid #dee2e6; }
.ai-param-table td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; }
</style>
<script>
var AI_ENABLED = {{ 'true' if ai_enabled else 'false' }};
var RUN_ID = '{{ run.run_id }}';

document.addEventListener('DOMContentLoaded', function() {
  if (!AI_ENABLED) {
    document.getElementById('aiDisabled').style.display = '';
    return;
  }
  document.getElementById('aiActions').style.display = '';
  loadExistingInsight();
});

function loadExistingInsight() {
  fetch('/ai/run/' + RUN_ID + '/view')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.found && d.status === 'ok') {
        renderAiResult(d);
      } else if (d.found && d.status === 'failed') {
        var errMsg = d.error_msg || 'El an치lisis anterior fall칩.';
        var rawText = d.raw_text || d.insights_md || '';
        if (rawText) {
          showAiError(errMsg + '<br><details><summary>Respuesta sin formato</summary><pre style="white-space:pre-wrap;font-size:0.8rem;max-height:300px;overflow:auto;">' + escHtml(rawText) + '</pre></details>');
        } else {
          showAiError(errMsg);
        }
      }
    })
    .catch(function() {});
}

function aiGenerate() {
  var btn = document.getElementById('btnAiGenerate');
  btn.disabled = true;
  document.getElementById('aiLoading').style.display = '';
  document.getElementById('aiError').style.display = 'none';
  document.getElementById('aiResult').style.display = 'none';

  fetch('/ai/run/' + RUN_ID + '/generate', { method: 'POST', headers: {'Content-Type': 'application/json'} })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
      document.getElementById('aiLoading').style.display = 'none';
      btn.disabled = false;
      if (!res.ok) {
        showAiError(res.data.error || 'Error desconocido');
        return;
      }
      loadExistingInsight();
    })
    .catch(function(e) {
      document.getElementById('aiLoading').style.display = 'none';
      btn.disabled = false;
      showAiError('Error de conexi칩n: ' + e.message);
    });
}

function showAiError(msg) {
  var el = document.getElementById('aiError');
  el.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>' + msg;
  el.style.display = '';
}

function renderAiResult(d) {
  if (typeof d !== 'object' || d === null) {
    document.getElementById('aiResult').style.display = '';
    document.getElementById('aiResumenContent').innerHTML = '<details><summary>Respuesta sin formato</summary><pre style="white-space:pre-wrap;font-size:0.8rem;">' + escHtml(String(d)) + '</pre></details>';
    return;
  }

  var exec = d.executive_summary || {};
  var health = d.health || {};
  var qs = d.quick_stats || {};
  var anomalies = d.anomalies || [];
  var actions = d.actions || [];
  var sugParams = d.suggested_parameters || [];
  var healthNotes = health.notes || [];

  if (!d.executive_summary && d.insights_md) {
    document.getElementById('aiResult').style.display = '';
    document.getElementById('aiResumenContent').innerHTML = simpleMarkdown(d.insights_md);

    var oldAnomalies = d.anomalies || [];
    var anomHtml = '';
    if (oldAnomalies.length === 0) {
      anomHtml = '<div class="text-muted small py-2"><i class="bi bi-check-circle me-1"></i>No se detectaron anomal칤as.</div>';
    } else {
      for (var oi = 0; oi < oldAnomalies.length; oi++) {
        var oa = oldAnomalies[oi];
        var osev = oa.severity || 'low';
        anomHtml += '<div class="ai-anomaly-card ai-anomaly-' + osev + '">';
        anomHtml += '<strong>' + escHtml(oa.title || oa.what || '') + '</strong>';
        if (oa.evidence) anomHtml += '<div class="small text-muted">' + escHtml(typeof oa.evidence === 'string' ? oa.evidence : JSON.stringify(oa.evidence)) + '</div>';
        anomHtml += '</div>';
      }
    }
    document.getElementById('aiAnomaliasContent').innerHTML = anomHtml;
    document.getElementById('aiAccionesContent').innerHTML = '<div class="text-muted small">No disponible en formato anterior.</div>';
    document.getElementById('aiParamsContent').innerHTML = '<div class="text-muted small">No disponible en formato anterior.</div>';
    document.getElementById('aiSaludContent').innerHTML = '<div class="text-muted small">No disponible en formato anterior.</div>';

    var metaEl = document.getElementById('aiMeta');
    metaEl.innerHTML = '<i class="bi bi-clock me-1"></i>' + escHtml(d.created_at || '') + ' | Modelo: ' + escHtml(d.model_version || '') + (d.tokens_used ? ' | Tokens: ' + d.tokens_used : '');
    return;
  }

  document.getElementById('aiResult').style.display = '';

  var resumenHtml = '';
  if (exec.title) {
    resumenHtml += '<h6 class="fw-semibold mb-2">' + escHtml(exec.title) + '</h6>';
  }
  var bullets = exec.bullets || [];
  if (bullets.length > 0) {
    resumenHtml += '<ul class="mb-3">';
    for (var bi = 0; bi < bullets.length; bi++) {
      resumenHtml += '<li>' + escHtml(bullets[bi]) + '</li>';
    }
    resumenHtml += '</ul>';
  }

  var kpiKeys = [
    {k: 'total_units', l: 'Unidades'},
    {k: 'distinct_skus', l: 'SKUs'},
    {k: 'distinct_stores', l: 'Tiendas'},
    {k: 'capped_rows', l: 'Filas cap.'},
    {k: 'max_row_qty', l: 'M치x qty'}
  ];
  var hasKpi = false;
  var kpiHtml = '<div class="mb-3">';
  for (var ki = 0; ki < kpiKeys.length; ki++) {
    var kv = qs[kpiKeys[ki].k];
    if (kv !== undefined && kv !== null) {
      hasKpi = true;
      kpiHtml += '<span class="ai-kpi-chip"><span class="kpi-val">' + escHtml(String(kv)) + '</span><span class="kpi-label">' + escHtml(kpiKeys[ki].l) + '</span></span>';
    }
  }
  kpiHtml += '</div>';
  if (hasKpi) resumenHtml += kpiHtml;

  if (health.data_quality || health.confidence) {
    resumenHtml += '<div class="mb-2">';
    if (health.data_quality) {
      resumenHtml += '<span class="ai-health-badge ai-health-' + escHtml(health.data_quality) + ' me-2">Calidad Datos: ' + escHtml(health.data_quality.toUpperCase()) + '</span>';
    }
    if (health.confidence) {
      resumenHtml += '<span class="ai-health-badge ai-health-' + escHtml(health.confidence) + '">Confianza: ' + escHtml(health.confidence.toUpperCase()) + '</span>';
    }
    resumenHtml += '</div>';
  }
  document.getElementById('aiResumenContent').innerHTML = resumenHtml;

  var anomHtml2 = '';
  if (anomalies.length === 0) {
    anomHtml2 = '<div class="text-muted small py-2"><i class="bi bi-check-circle me-1"></i>No se detectaron anomal칤as.</div>';
  } else {
    for (var ai2 = 0; ai2 < anomalies.length; ai2++) {
      var an = anomalies[ai2];
      var sev = an.severity || 'low';
      var sevClass = sev === 'high' ? 'high' : sev === 'medium' ? 'medium' : 'low';
      var sevBg = sev === 'high' ? 'danger' : sev === 'medium' ? 'warning text-dark' : 'primary';
      anomHtml2 += '<div class="ai-anomaly-card ai-anomaly-' + sevClass + '">';
      anomHtml2 += '<div class="d-flex justify-content-between align-items-center mb-1">';
      anomHtml2 += '<div><strong>' + escHtml(an.what || '') + '</strong>';
      if (an.code) anomHtml2 += ' <span class="badge bg-light text-dark ms-1" style="font-size:0.7rem;">' + escHtml(an.code) + '</span>';
      anomHtml2 += '</div>';
      anomHtml2 += '<span class="badge bg-' + sevBg + '">' + escHtml(sev.toUpperCase()) + '</span>';
      anomHtml2 += '</div>';
      var evArr = an.evidence || [];
      if (evArr.length > 0) {
        anomHtml2 += '<ul class="small text-muted mb-1" style="padding-left:1.2rem;">';
        for (var ei = 0; ei < evArr.length; ei++) {
          anomHtml2 += '<li>' + escHtml(evArr[ei]) + '</li>';
        }
        anomHtml2 += '</ul>';
      }
      if (an.impact) anomHtml2 += '<div class="small fst-italic text-muted"><i class="bi bi-arrow-right me-1"></i>' + escHtml(an.impact) + '</div>';
      anomHtml2 += '</div>';
    }
  }
  document.getElementById('aiAnomaliasContent').innerHTML = anomHtml2;

  var actHtml = '';
  if (actions.length === 0) {
    actHtml = '<div class="text-muted small py-2"><i class="bi bi-check-circle me-1"></i>No hay acciones sugeridas.</div>';
  } else {
    for (var ac = 0; ac < actions.length; ac++) {
      var act = actions[ac];
      var pri = act.priority || 'P2';
      var priBg = pri === 'P0' ? 'danger' : pri === 'P1' ? 'warning text-dark' : 'info';
      actHtml += '<div class="ai-action-card">';
      actHtml += '<div class="d-flex justify-content-between align-items-center mb-1">';
      actHtml += '<strong>' + escHtml(act.title || '') + '</strong>';
      actHtml += '<span class="badge bg-' + priBg + '">' + escHtml(pri) + '</span>';
      actHtml += '</div>';
      if (act.why) actHtml += '<div class="small fst-italic text-muted mb-1">' + escHtml(act.why) + '</div>';
      var howArr = act.how || [];
      if (howArr.length > 0) {
        actHtml += '<ol class="small mb-1" style="padding-left:1.2rem;">';
        for (var hi = 0; hi < howArr.length; hi++) {
          actHtml += '<li>' + escHtml(howArr[hi]) + '</li>';
        }
        actHtml += '</ol>';
      }
      var scope = act.scope || {};
      var scopeSkus = scope.skus || [];
      var scopeStores = scope.stores || [];
      if (scopeSkus.length > 0 || scopeStores.length > 0) {
        actHtml += '<div class="mb-1">';
        for (var si = 0; si < scopeSkus.length; si++) {
          actHtml += '<span class="ai-scope-chip">SKU: ' + escHtml(scopeSkus[si]) + '</span>';
        }
        for (var sti = 0; sti < scopeStores.length; sti++) {
          actHtml += '<span class="ai-scope-chip">Tienda: ' + escHtml(scopeStores[sti]) + '</span>';
        }
        actHtml += '</div>';
      }
      var cta = act.cta || {};
      if (cta.route) {
        var ctaRoute = cta.route;
        if (cta.params) {
          var sep = ctaRoute.indexOf('?') >= 0 ? '&' : '?';
          for (var pk in cta.params) {
            ctaRoute += sep + encodeURIComponent(pk) + '=' + encodeURIComponent(cta.params[pk]);
            sep = '&';
          }
        }
        actHtml += '<button class="btn btn-sm btn-outline-primary mt-1" onclick="window.location.href=\'' + escHtml(ctaRoute) + '\'">' + escHtml(cta.label || 'Ir') + '</button>';
      }
      actHtml += '</div>';
    }
  }
  document.getElementById('aiAccionesContent').innerHTML = actHtml;

  var paramHtml = '';
  if (sugParams.length === 0) {
    paramHtml = '<div class="text-muted small">Sin par치metros sugeridos.</div>';
  } else {
    paramHtml = '<table class="ai-param-table"><thead><tr><th>Par치metro</th><th>Valor</th><th>Raz칩n</th></tr></thead><tbody>';
    for (var pi = 0; pi < sugParams.length; pi++) {
      var sp = sugParams[pi];
      paramHtml += '<tr><td>' + escHtml(sp.name || '') + '</td><td><strong>' + escHtml(String(sp.value !== undefined ? sp.value : '')) + '</strong></td><td class="text-muted">' + escHtml(sp.reason || '') + '</td></tr>';
    }
    paramHtml += '</tbody></table>';
  }
  document.getElementById('aiParamsContent').innerHTML = paramHtml;

  var saludHtml = '<div class="mb-3">';
  if (health.data_quality) {
    saludHtml += '<span class="ai-health-badge ai-health-' + escHtml(health.data_quality) + ' me-2"><i class="bi bi-database me-1"></i>Calidad Datos: ' + escHtml(health.data_quality.toUpperCase()) + '</span>';
  }
  if (health.confidence) {
    saludHtml += '<span class="ai-health-badge ai-health-' + escHtml(health.confidence) + '"><i class="bi bi-graph-up me-1"></i>Confianza: ' + escHtml(health.confidence.toUpperCase()) + '</span>';
  }
  saludHtml += '</div>';
  if (healthNotes.length > 0) {
    saludHtml += '<ul class="small">';
    for (var ni = 0; ni < healthNotes.length; ni++) {
      saludHtml += '<li>' + escHtml(healthNotes[ni]) + '</li>';
    }
    saludHtml += '</ul>';
  } else {
    saludHtml += '<div class="text-muted small">Sin notas adicionales.</div>';
  }
  document.getElementById('aiSaludContent').innerHTML = saludHtml;

  var badge = document.getElementById('aiStatusBadge');
  var highCount = 0, medCount = 0;
  for (var bci = 0; bci < anomalies.length; bci++) {
    if (anomalies[bci].severity === 'high') highCount++;
    else if (anomalies[bci].severity === 'medium') medCount++;
  }
  if (highCount > 0) {
    badge.className = 'badge bg-danger';
    badge.textContent = anomalies.length + ' anomal칤a(s)';
  } else if (medCount > 0) {
    badge.className = 'badge bg-warning text-dark';
    badge.textContent = anomalies.length + ' anomal칤a(s)';
  } else if (anomalies.length > 0) {
    badge.className = 'badge bg-info';
    badge.textContent = anomalies.length + ' anomal칤a(s)';
  } else {
    badge.className = 'badge bg-success';
    badge.textContent = 'Sin anomal칤as';
  }
  badge.style.display = '';

  var metaEl = document.getElementById('aiMeta');
  metaEl.innerHTML = '<i class="bi bi-clock me-1"></i>' + escHtml(d.created_at || '') + ' | Modelo: ' + escHtml(d.model_version || '') + (d.tokens_used ? ' | Tokens: ' + d.tokens_used : '');
}

function simpleMarkdown(md) {
  if (!md) return '';
  var s = md
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
  return s;
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
{% endif %}

{% endblock %}
