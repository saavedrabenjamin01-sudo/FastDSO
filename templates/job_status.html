{% extends 'base.html' %}
{% block title %}Procesando - {{ job_label }}{% endblock %}
{% block content %}
<div class="row justify-content-center mt-5">
  <div class="col-md-6">
    <div class="card d-none" id="result-card">
      <div class="card-body text-center py-5">
        <div id="success-section" class="d-none">
          <div class="text-success mb-3">
            <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
          </div>
          <h4 class="mb-3">Proceso completado</h4>
          <p id="success-message" class="text-muted mb-4"></p>
          <a href="{{ redirect_url }}" class="btn btn-primary">
            <i class="bi bi-arrow-right me-2"></i>Continuar
          </a>
        </div>
        
        <div id="error-section" class="d-none">
          <div class="text-danger mb-3">
            <i class="bi bi-x-circle-fill" style="font-size: 4rem;"></i>
          </div>
          <h4 class="mb-3">Error en el proceso</h4>
          <p id="error-message" class="text-muted mb-4"></p>
          <a href="{{ redirect_url }}" class="btn btn-primary">
            <i class="bi bi-arrow-right me-2"></i>Continuar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const jobId = "{{ job.id }}";
  const pollInterval = 1500;
  const jobType = "{{ job.job_type }}";
  
  var iconVariant = 'generic';
  if (jobType === 'upload_stock_cd') iconVariant = 'warehouse';
  else if (jobType === 'upload_stock_store') iconVariant = 'store';
  else if (jobType === 'upload_sales') iconVariant = 'truck';
  
  if (window.showLoaderModal) {
    window.showLoaderModal('{{ job_label }}', '{{ job.message or "Procesando..." }}', iconVariant);
  }
  
  function updateUI(data) {
    if (window.updateLoaderProgress) {
      var progress = Math.min(data.progress, 95);
      window.updateLoaderProgress(progress);
    }
    
    if (data.status === 'done') {
      if (window.updateLoaderProgress) window.updateLoaderProgress(100);
      setTimeout(function() {
        if (window.hideLoaderModal) window.hideLoaderModal();
        document.getElementById('result-card').classList.remove('d-none');
        document.getElementById('success-section').classList.remove('d-none');
        document.getElementById('success-message').textContent = data.message || 'El proceso ha finalizado correctamente.';
      }, 500);
    } else if (data.status === 'error') {
      if (window.hideLoaderModal) window.hideLoaderModal();
      document.getElementById('result-card').classList.remove('d-none');
      document.getElementById('error-section').classList.remove('d-none');
      document.getElementById('error-message').textContent = data.message || 'Ocurri√≥ un error durante el proceso.';
    }
  }
  
  function poll() {
    fetch('/jobs/' + jobId)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        updateUI(data);
        if (data.status === 'queued' || data.status === 'running') {
          setTimeout(poll, pollInterval);
        }
      })
      .catch(function(err) {
        console.error('Poll error:', err);
        setTimeout(poll, pollInterval * 2);
      });
  }
  
  poll();
})();
</script>
{% endblock %}
