{% extends 'base.html' %}
{% block content %}

<div class="runs-wrap">
  <div class="runs-header">
    <div class="runs-header-text">
      <h1 class="runs-title">Centro de Corridas</h1>
      <p class="runs-subtitle">Historial de simulaciones, distribuciones y forecasts</p>
    </div>
  </div>

  <div class="runs-kpi-row">
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-blue"><i class="bi bi-layers"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{{ pagination.total }}</div>
        <div class="runs-kpi-label">Total corridas</div>
      </div>
    </div>
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-green"><i class="bi bi-check2-circle"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{{ runs|selectattr('status', 'equalto', 'completed')|list|length + runs|selectattr('status', 'equalto', 'EXECUTED')|list|length }}</div>
        <div class="runs-kpi-label">Completadas</div>
      </div>
    </div>
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-amber"><i class="bi bi-calendar3"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{% if runs %}{{ runs[0].created_at.strftime('%d/%m') if runs[0].created_at else '-' }}{% else %}-{% endif %}</div>
        <div class="runs-kpi-label">Última corrida</div>
      </div>
    </div>
  </div>

  <div class="runs-filters-card">
    <form method="get" action="{{ url_for('runs') }}" class="runs-filters">
      <div class="runs-filter-chips">
        <a href="{{ url_for('runs', search=search, per_page=per_page) }}" 
           class="runs-chip {% if not run_type_filter %}runs-chip-active{% endif %}">
          Todos
        </a>
        <a href="{{ url_for('runs', run_type='sales_upload', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-cyan {% if run_type_filter == 'sales_upload' %}runs-chip-active{% endif %}">
          Ventas
        </a>
        <a href="{{ url_for('runs', run_type='distribution', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-blue {% if run_type_filter == 'distribution' %}runs-chip-active{% endif %}">
          Distribución
        </a>
        <a href="{{ url_for('runs', run_type='forecast_v2', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-green {% if run_type_filter == 'forecast_v2' %}runs-chip-active{% endif %}">
          Forecast V2
        </a>
      </div>
      <div class="runs-search-group">
        <input type="text" 
               name="search" 
               class="form-control form-control-sm runs-search-input" 
               placeholder="Buscar folio, responsable..." 
               value="{{ search }}">
        <input type="hidden" name="run_type" value="{{ run_type_filter }}">
        <input type="hidden" name="per_page" value="{{ per_page }}">
        <button type="submit" class="btn btn-sm runs-btn-search">
          <i class="bi bi-search"></i>
        </button>
        {% if search %}
        <a href="{{ url_for('runs', run_type=run_type_filter, per_page=per_page) }}" class="btn btn-sm runs-btn-clear">
          <i class="bi bi-x-lg"></i>
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="runs-table-card">
    <div class="runs-table-wrap">
      <table class="runs-table">
        <thead>
          <tr>
            <th>Folio</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Activa</th>
            <th>Fecha</th>
            <th>Responsable</th>
            <th>Categoría</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if runs %}
            {% for r in runs %}
            <tr {% if r.is_active %}class="runs-row-active"{% endif %}>
              <td><strong class="runs-folio">{{ r.folio or '-' }}</strong></td>
              <td>
                {% if r.run_type == 'sales_upload' %}
                  <span class="runs-badge runs-badge-cyan">Ventas</span>
                {% elif r.run_type == 'distribution' %}
                  <span class="runs-badge runs-badge-blue">Distribución</span>
                {% elif r.run_type == 'forecast_v2' %}
                  <span class="runs-badge runs-badge-green">Forecast V2</span>
                {% else %}
                  <span class="runs-badge runs-badge-gray">{{ r.run_type }}</span>
                {% endif %}
              </td>
              <td>
                {% if r.status == 'completed' or r.status == 'EXECUTED' %}
                  <span class="runs-status runs-status-success">{{ r.status }}</span>
                {% elif r.status == 'failed' %}
                  <span class="runs-status runs-status-danger">{{ r.status }}</span>
                {% elif r.status == 'APPROVED' %}
                  <span class="runs-status runs-status-info">{{ r.status }}</span>
                {% elif r.status == 'SIMULATED' %}
                  <span class="runs-status runs-status-warning">{{ r.status }}</span>
                {% elif r.status == 'ARCHIVED' %}
                  <span class="runs-status runs-status-muted">{{ r.status }}</span>
                {% else %}
                  <span class="runs-status">{{ r.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if r.is_active %}
                  <span class="runs-active-badge"><i class="bi bi-star-fill"></i></span>
                {% else %}
                  <span class="runs-muted">-</span>
                {% endif %}
              </td>
              <td class="runs-muted">{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '-' }}</td>
              <td class="runs-muted">{{ r.responsable or '-' }}</td>
              <td class="runs-muted">{{ r.categoria or '-' }}</td>
              <td>
                <div class="runs-actions">
                  <a href="{{ url_for('view_run', run_id=r.run_id) }}" class="runs-action-btn" title="Ver detalles">
                    <i class="bi bi-eye"></i>
                  </a>
                  {% if r.run_type == 'distribution' %}
                    <a href="{{ url_for('dashboard', run_id=r.run_id) }}" class="runs-action-btn" title="Ver en Dashboard">
                      <i class="bi bi-graph-up"></i>
                    </a>
                    {% if current_user.role in ['Admin', 'Management'] and not r.is_active %}
                    <form method="post" action="{{ url_for('activate_run', run_id=r.run_id) }}" style="display:inline;">
                      <button type="submit" class="runs-action-btn runs-action-btn-success" title="Activar corrida">
                        <i class="bi bi-check-circle"></i>
                      </button>
                    </form>
                    {% endif %}
                  {% endif %}
                  {% if current_user.role in ['Admin', 'Management'] %}
                  <div class="dropdown">
                    <button class="runs-action-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Cambiar estado">
                      <i class="bi bi-flag"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      {% for status in ['DRAFT', 'SIMULATED', 'APPROVED', 'EXECUTED', 'ARCHIVED'] %}
                      <li>
                        <form method="post" action="{{ url_for('change_run_status', run_id=r.run_id) }}">
                          <input type="hidden" name="status" value="{{ status }}">
                          <button type="submit" class="dropdown-item {% if r.status == status %}active{% endif %}">{{ status }}</button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="runs-empty-cell">
                <div class="runs-empty">
                  <div class="runs-empty-icon"><i class="bi bi-inbox"></i></div>
                  <div class="runs-empty-title">No hay corridas disponibles</div>
                  <div class="runs-empty-hint">
                    {% if search or run_type_filter %}
                    No se encontraron corridas con los filtros actuales.
                    <a href="{{ url_for('runs') }}">Ver todas</a>
                    {% else %}
                    Carga datos de ventas para crear tu primera corrida.
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if pagination and pagination.total > 0 %}
    <div class="runs-pagination-bar">
      <div class="runs-pagination-info">
        <span>Mostrando {{ runs|length }} de {{ pagination.total }}</span>
        <select class="form-select form-select-sm runs-per-page" onchange="updatePerPage(this.value)">
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>
      </div>
      <nav class="runs-pagination-nav">
        <a href="{{ url_for('runs', page=pagination.prev_num or 1, per_page=per_page, search=search, run_type=run_type_filter) }}" 
           class="runs-page-btn {% if not pagination.has_prev %}disabled{% endif %}">
          <i class="bi bi-chevron-left"></i>
        </a>
        {% for p in pagination.iter_pages() %}
          {% if p %}
            <a href="{{ url_for('runs', page=p, per_page=per_page, search=search, run_type=run_type_filter) }}" 
               class="runs-page-btn {% if p == pagination.page %}active{% endif %}">{{ p }}</a>
          {% else %}
            <span class="runs-page-ellipsis">...</span>
          {% endif %}
        {% endfor %}
        <a href="{{ url_for('runs', page=pagination.next_num or pagination.pages, per_page=per_page, search=search, run_type=run_type_filter) }}" 
           class="runs-page-btn {% if not pagination.has_next %}disabled{% endif %}">
          <i class="bi bi-chevron-right"></i>
        </a>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<script>
function updatePerPage(value) {
  const url = new URL(window.location.href);
  url.searchParams.set('per_page', value);
  url.searchParams.set('page', 1);
  window.location.href = url.toString();
}
</script>

{% endblock %}
