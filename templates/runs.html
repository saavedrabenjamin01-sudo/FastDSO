{% extends 'base.html' %}
{% block content %}

<div class="runs-wrap">
  <div class="runs-header">
    <div class="runs-header-text">
      <h1 class="runs-title">Centro de Corridas</h1>
      <p class="runs-subtitle">Historial de simulaciones, distribuciones y forecasts</p>
    </div>
  </div>

  <div class="runs-kpi-row">
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-blue"><i class="bi bi-layers"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{{ pagination.total }}</div>
        <div class="runs-kpi-label">Total corridas</div>
      </div>
    </div>
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-green"><i class="bi bi-check2-circle"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{{ runs|selectattr('status', 'equalto', 'completed')|list|length + runs|selectattr('status', 'equalto', 'EXECUTED')|list|length }}</div>
        <div class="runs-kpi-label">Completadas</div>
      </div>
    </div>
    {% if pending_count > 0 %}
    <div class="runs-kpi runs-kpi-warning">
      <div class="runs-kpi-icon runs-kpi-icon-orange"><i class="bi bi-hourglass-split"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{{ pending_count }}</div>
        <div class="runs-kpi-label">Pendientes aprobación</div>
      </div>
    </div>
    {% endif %}
    <div class="runs-kpi">
      <div class="runs-kpi-icon runs-kpi-icon-amber"><i class="bi bi-calendar3"></i></div>
      <div class="runs-kpi-content">
        <div class="runs-kpi-value">{% if runs %}{{ runs[0].created_at.strftime('%d/%m') if runs[0].created_at else '-' }}{% else %}-{% endif %}</div>
        <div class="runs-kpi-label">Última corrida</div>
      </div>
    </div>
  </div>

  {% if can_approve and pending_approvals %}
  <div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <span class="fw-semibold"><i class="bi bi-hourglass-split"></i> Pendientes de Autorización</span>
      <span class="badge bg-dark">{{ pending_count }}</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Folio</th>
              <th>Urgencia</th>
              <th>Enviado por</th>
              <th>Fecha envío</th>
              <th>SKUs</th>
              <th>Nota</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in pending_approvals %}
            <tr>
              <td><strong>{{ r.folio or r.run_id[:8] }}</strong></td>
              <td>
                <span class="urgency-pill urgency-{{ r.urgency|lower if r.urgency else 'medium' }}">{{ r.urgency or 'MEDIUM' }}</span>
              </td>
              <td>{{ r.submitted_by.username if r.submitted_by else '-' }}</td>
              <td>{{ r.submitted_at.strftime('%d/%m %H:%M') if r.submitted_at else '-' }}</td>
              <td>{{ r.predictions_count or '-' }}</td>
              <td class="text-muted small" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">{{ r.submit_note or '-' }}</td>
              <td class="text-center">
                <form method="post" action="{{ url_for('approve_and_send', run_id=r.run_id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-xs btn-success" title="Aprobar y enviar a FastPlanner"><i class="bi bi-check-circle"></i> Aprobar</button>
                </form>
                <button type="button" class="btn btn-xs btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ r.id }}" title="Rechazar"><i class="bi bi-x-circle"></i></button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="runs-filters-card">
    <form method="get" action="{{ url_for('runs') }}" class="runs-filters">
      <div class="runs-filter-chips">
        <a href="{{ url_for('runs', search=search, per_page=per_page) }}" 
           class="runs-chip {% if not run_type_filter %}runs-chip-active{% endif %}">
          Todos
        </a>
        <a href="{{ url_for('runs', run_type='sales_upload', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-cyan {% if run_type_filter == 'sales_upload' %}runs-chip-active{% endif %}">
          Ventas
        </a>
        <a href="{{ url_for('runs', run_type='distribution', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-blue {% if run_type_filter == 'distribution' %}runs-chip-active{% endif %}">
          Distribución
        </a>
        <a href="{{ url_for('runs', run_type='forecast_v2', search=search, per_page=per_page) }}" 
           class="runs-chip runs-chip-green {% if run_type_filter == 'forecast_v2' %}runs-chip-active{% endif %}">
          Forecast V2
        </a>
      </div>
      <div class="runs-search-group">
        <input type="text" 
               name="search" 
               class="form-control form-control-sm runs-search-input" 
               placeholder="Buscar folio, responsable..." 
               value="{{ search }}">
        <input type="hidden" name="run_type" value="{{ run_type_filter }}">
        <input type="hidden" name="per_page" value="{{ per_page }}">
        <button type="submit" class="btn btn-sm runs-btn-search">
          <i class="bi bi-search"></i>
        </button>
        {% if search %}
        <a href="{{ url_for('runs', run_type=run_type_filter, per_page=per_page) }}" class="btn btn-sm runs-btn-clear">
          <i class="bi bi-x-lg"></i>
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="runs-table-card">
    <div class="runs-table-wrap">
      <table class="runs-table">
        <thead>
          <tr>
            <th>Folio</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Activa</th>
            <th>Fecha</th>
            <th>Responsable</th>
            <th>Categoría</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if runs %}
            {% for r in runs %}
            <tr {% if r.is_active %}class="runs-row-active"{% endif %}>
              <td><strong class="runs-folio">{{ r.folio or '-' }}</strong></td>
              <td>
                {% if r.run_type == 'sales_upload' %}
                  <span class="runs-badge runs-badge-cyan">Ventas</span>
                {% elif r.run_type == 'distribution' %}
                  <span class="runs-badge runs-badge-blue">Distribución</span>
                {% elif r.run_type == 'forecast_v2' %}
                  <span class="runs-badge runs-badge-green">Forecast V2</span>
                {% else %}
                  <span class="runs-badge runs-badge-gray">{{ r.run_type }}</span>
                {% endif %}
              </td>
              <td>
                {% if r.status == 'completed' or r.status == 'EXECUTED' %}
                  <span class="runs-status runs-status-success">{{ r.status }}</span>
                {% elif r.status == 'failed' or r.status == 'REJECTED' %}
                  <span class="runs-status runs-status-danger">{{ r.status }}</span>
                {% elif r.status == 'APPROVED' %}
                  <span class="runs-status runs-status-info">{{ r.status }}</span>
                {% elif r.status == 'SIMULATED' %}
                  <span class="runs-status runs-status-warning">{{ r.status }}</span>
                {% elif r.status == 'ARCHIVED' %}
                  <span class="runs-status runs-status-muted">{{ r.status }}</span>
                {% elif r.status == 'DRAFT' %}
                  <span class="runs-status runs-status-secondary">BORRADOR</span>
                {% elif r.status == 'PENDING_APPROVAL' %}
                  <span class="runs-status runs-status-pending">PENDIENTE</span>
                {% else %}
                  <span class="runs-status">{{ r.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if r.is_active %}
                  <span class="runs-active-badge"><i class="bi bi-star-fill"></i></span>
                {% else %}
                  <span class="runs-muted">-</span>
                {% endif %}
              </td>
              <td class="runs-muted">{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '-' }}</td>
              <td class="runs-muted">{{ r.responsable or '-' }}</td>
              <td class="runs-muted">{{ r.categoria or '-' }}</td>
              <td>
                <div class="runs-actions">
                  <a href="{{ url_for('view_run', run_id=r.run_id) }}" class="runs-action-btn" title="Ver detalles">
                    <i class="bi bi-eye"></i>
                  </a>
                  {% if r.run_type == 'distribution' %}
                    <a href="{{ url_for('dashboard', run_id=r.run_id) }}" class="runs-action-btn" title="Ver en Dashboard">
                      <i class="bi bi-graph-up"></i>
                    </a>
                    {% if can_submit and r.status in ['DRAFT', 'completed'] %}
                    <button type="button" class="runs-action-btn runs-action-btn-warning" data-bs-toggle="modal" data-bs-target="#submitModal{{ r.id }}" title="Enviar para autorización">
                      <i class="bi bi-send"></i>
                    </button>
                    {% endif %}
                    {% if current_user.role in ['Admin', 'Management'] and not r.is_active %}
                    <form method="post" action="{{ url_for('activate_run', run_id=r.run_id) }}" style="display:inline;">
                      <button type="submit" class="runs-action-btn runs-action-btn-success" title="Activar corrida">
                        <i class="bi bi-check-circle"></i>
                      </button>
                    </form>
                    {% endif %}
                  {% endif %}
                  {% if current_user.role in ['Admin', 'Management'] %}
                  <div class="dropdown">
                    <button class="runs-action-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Cambiar estado">
                      <i class="bi bi-flag"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      {% for status in ['DRAFT', 'SIMULATED', 'APPROVED', 'EXECUTED', 'ARCHIVED'] %}
                      <li>
                        <form method="post" action="{{ url_for('change_run_status', run_id=r.run_id) }}">
                          <input type="hidden" name="status" value="{{ status }}">
                          <button type="submit" class="dropdown-item {% if r.status == status %}active{% endif %}">{{ status }}</button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="runs-empty-cell">
                <div class="runs-empty">
                  <div class="runs-empty-icon"><i class="bi bi-inbox"></i></div>
                  <div class="runs-empty-title">No hay corridas disponibles</div>
                  <div class="runs-empty-hint">
                    {% if search or run_type_filter %}
                    No se encontraron corridas con los filtros actuales.
                    <a href="{{ url_for('runs') }}">Ver todas</a>
                    {% else %}
                    Carga datos de ventas para crear tu primera corrida.
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if pagination and pagination.total > 0 %}
    <div class="runs-pagination-bar">
      <div class="runs-pagination-info">
        <span>Mostrando {{ runs|length }} de {{ pagination.total }}</span>
        <select class="form-select form-select-sm runs-per-page" onchange="updatePerPage(this.value)">
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>
      </div>
      <nav class="runs-pagination-nav">
        <a href="{{ url_for('runs', page=pagination.prev_num or 1, per_page=per_page, search=search, run_type=run_type_filter) }}" 
           class="runs-page-btn {% if not pagination.has_prev %}disabled{% endif %}">
          <i class="bi bi-chevron-left"></i>
        </a>
        {% for p in pagination.iter_pages() %}
          {% if p %}
            <a href="{{ url_for('runs', page=p, per_page=per_page, search=search, run_type=run_type_filter) }}" 
               class="runs-page-btn {% if p == pagination.page %}active{% endif %}">{{ p }}</a>
          {% else %}
            <span class="runs-page-ellipsis">...</span>
          {% endif %}
        {% endfor %}
        <a href="{{ url_for('runs', page=pagination.next_num or pagination.pages, per_page=per_page, search=search, run_type=run_type_filter) }}" 
           class="runs-page-btn {% if not pagination.has_next %}disabled{% endif %}">
          <i class="bi bi-chevron-right"></i>
        </a>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

{% for r in runs %}
{% if r.run_type == 'distribution' and r.status in ['DRAFT', 'completed'] %}
<div class="modal fade" id="submitModal{{ r.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="bi bi-send"></i> Enviar para Autorización</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form method="post" action="{{ url_for('submit_for_approval', run_id=r.run_id) }}">
        <div class="modal-body">
          <p class="mb-3">Corrida: <strong>{{ r.folio or r.run_id[:8] }}</strong></p>
          <div class="mb-3">
            <label class="form-label fw-semibold">Urgencia</label>
            <select name="urgency" class="form-select">
              <option value="LOW">Baja</option>
              <option value="MEDIUM" selected>Media</option>
              <option value="URGENT">Urgente</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Observaciones (opcional)</label>
            <textarea name="submit_note" class="form-control" rows="3" placeholder="Notas para el aprobador..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning"><i class="bi bi-send"></i> Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endfor %}

{% if can_approve %}
{% for r in pending_approvals %}
<div class="modal fade" id="rejectModal{{ r.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-x-circle"></i> Rechazar Corrida</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form method="post" action="{{ url_for('reject_run', run_id=r.run_id) }}">
        <div class="modal-body">
          <p class="mb-3">Corrida: <strong>{{ r.folio or r.run_id[:8] }}</strong></p>
          <div class="mb-3">
            <label class="form-label fw-semibold">Motivo del rechazo *</label>
            <textarea name="reject_comment" class="form-control" rows="3" placeholder="Explica el motivo del rechazo..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger"><i class="bi bi-x-circle"></i> Rechazar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endif %}

{% if approval_modal_data %}
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%); color: white;">
        <h5 class="modal-title" id="approvalModalLabel"><i class="bi bi-send-check"></i> Enviar a Autorización</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="approvalForm" method="post" action="{{ url_for('submit_for_approval', run_id=approval_modal_data.run_id) }}">
        <div class="modal-body">
          <div class="approval-summary-card mb-4">
            <div class="approval-summary-header">
              <i class="bi bi-box-seam"></i> Resumen de Distribución
              <span class="approval-folio">{{ approval_modal_data.folio }}</span>
            </div>
            <div class="approval-summary-grid">
              <div class="approval-kpi">
                <div class="approval-kpi-value">{{ approval_modal_data.summary.sku_count }}</div>
                <div class="approval-kpi-label">SKUs</div>
              </div>
              <div class="approval-kpi">
                <div class="approval-kpi-value">{{ "{:,}".format(approval_modal_data.summary.total_units) }}</div>
                <div class="approval-kpi-label">Unidades</div>
              </div>
              <div class="approval-kpi">
                <div class="approval-kpi-value">{{ approval_modal_data.summary.stores_count }}</div>
                <div class="approval-kpi-label">Tiendas</div>
              </div>
              {% if approval_modal_data.summary.category %}
              <div class="approval-kpi">
                <div class="approval-kpi-value approval-kpi-cat">{{ approval_modal_data.summary.category }}</div>
                <div class="approval-kpi-label">Categoría</div>
              </div>
              {% endif %}
            </div>
            {% if approval_modal_data.summary.top_skus %}
            <div class="approval-top-skus">
              <div class="approval-top-title"><i class="bi bi-trophy"></i> Top 5 SKUs por cantidad</div>
              <table class="table table-sm table-borderless mb-0">
                <tbody>
                  {% for sku in approval_modal_data.summary.top_skus %}
                  <tr>
                    <td class="text-muted" style="width:30px;">{{ loop.index }}.</td>
                    <td><code>{{ sku.sku }}</code></td>
                    <td class="text-truncate" style="max-width:200px;">{{ sku.name }}</td>
                    <td class="text-end fw-semibold">{{ sku.qty }} u</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-semibold">Nivel de Urgencia</label>
            <div class="urgency-selector">
              <label class="urgency-option urgency-low">
                <input type="radio" name="urgency" value="LOW">
                <span class="urgency-label"><i class="bi bi-clock"></i> Bajo</span>
              </label>
              <label class="urgency-option urgency-medium">
                <input type="radio" name="urgency" value="MEDIUM" checked>
                <span class="urgency-label"><i class="bi bi-hourglass-split"></i> Medio</span>
              </label>
              <label class="urgency-option urgency-urgent">
                <input type="radio" name="urgency" value="URGENT">
                <span class="urgency-label"><i class="bi bi-exclamation-triangle"></i> Urgente</span>
              </label>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-semibold">Observaciones (opcional)</label>
            <textarea name="submit_note" class="form-control" rows="3" placeholder="Añade notas o comentarios para el autorizador..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cancelar</button>
          <button type="submit" class="btn btn-primary" id="submitApprovalBtn"><i class="bi bi-send-check"></i> Enviar a Autorización</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
function updatePerPage(value) {
  const url = new URL(window.location.href);
  url.searchParams.set('per_page', value);
  url.searchParams.set('page', 1);
  window.location.href = url.toString();
}

{% if approval_modal_data %}
document.addEventListener('DOMContentLoaded', function() {
  var approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
  approvalModal.show();
  
  var url = new URL(window.location.href);
  url.searchParams.delete('open_approval');
  url.searchParams.delete('run_id');
  window.history.replaceState({}, document.title, url.toString());
});
{% endif %}
</script>

<style>
.approval-summary-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1rem;
  border: 1px solid #e9ecef;
}
.approval-summary-header {
  font-weight: 600;
  font-size: 1rem;
  color: #495057;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.approval-folio {
  margin-left: auto;
  background: #0d6efd;
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 6px;
  font-size: 0.85rem;
}
.approval-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}
.approval-kpi {
  text-align: center;
  background: white;
  padding: 0.75rem;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}
.approval-kpi-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #0d6efd;
}
.approval-kpi-value.approval-kpi-cat {
  font-size: 0.9rem;
  color: #6c757d;
}
.approval-kpi-label {
  font-size: 0.75rem;
  color: #6c757d;
  text-transform: uppercase;
}
.approval-top-skus {
  background: white;
  border-radius: 8px;
  padding: 0.75rem;
  border: 1px solid #dee2e6;
}
.approval-top-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.5rem;
}
.urgency-selector {
  display: flex;
  gap: 0.75rem;
}
.urgency-option {
  flex: 1;
  cursor: pointer;
}
.urgency-option input {
  display: none;
}
.urgency-label {
  display: block;
  text-align: center;
  padding: 0.75rem;
  border-radius: 8px;
  border: 2px solid #dee2e6;
  transition: all 0.2s;
}
.urgency-low .urgency-label { border-color: #198754; color: #198754; }
.urgency-medium .urgency-label { border-color: #fd7e14; color: #fd7e14; }
.urgency-urgent .urgency-label { border-color: #dc3545; color: #dc3545; }
.urgency-option input:checked + .urgency-label {
  color: white;
  transform: scale(1.02);
}
.urgency-low input:checked + .urgency-label { background: #198754; }
.urgency-medium input:checked + .urgency-label { background: #fd7e14; }
.urgency-urgent input:checked + .urgency-label { background: #dc3545; }
</style>

{% endblock %}
