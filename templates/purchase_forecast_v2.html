{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Forecast de Compra (V2){% endblock %}
{% block content %}

<div class="fcv2-container">
  <div class="fcv2-header">
    <div class="fcv2-header-left">
      <h1 class="fcv2-title">Forecast de Compra (V2)</h1>
      <p class="fcv2-subtitle">Proyección basada en ventas macro, lead time y stock de seguridad</p>
    </div>
    <div class="fcv2-header-right">
      <div class="fcv2-status-badge fcv2-status-neutral" id="statusBadge">
        <i class="bi bi-dash-circle me-1"></i><span id="statusText">—</span>
      </div>
    </div>
  </div>

  <div class="fcv2-params-card">
    <div class="fcv2-params-header">
      <i class="bi bi-sliders2 me-2"></i>Parámetros del Forecast
    </div>
    <div class="fcv2-params-body">
      <div class="fcv2-params-grid">
        <div class="fcv2-field fcv2-field-lg">
          <label class="fcv2-label">SKU</label>
          <input type="text" id="skuInput" class="form-control fcv2-input" list="skuList" placeholder="Buscar SKU...">
          <datalist id="skuList">
            {% for p in products %}
            <option value="{{ p.sku }}">{{ p.name }}</option>
            {% endfor %}
          </datalist>
        </div>

        <div class="fcv2-field">
          <label class="fcv2-label">Tienda</label>
          <select id="storeSelect" class="form-select fcv2-input">
            <option value="">Todas las tiendas</option>
            {% for s in stores %}
            <option value="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="fcv2-field">
          <label class="fcv2-label">Horizonte (semanas)</label>
          <select id="horizonSelect" class="form-select fcv2-input">
            <option value="4">4 semanas</option>
            <option value="8" selected>8 semanas</option>
            <option value="12">12 semanas</option>
          </select>
        </div>

        <div class="fcv2-field">
          <label class="fcv2-label">Lead time (semanas)</label>
          <select id="leadTimeSelect" class="form-select fcv2-input">
            <option value="2">2 semanas</option>
            <option value="4" selected>4 semanas</option>
            <option value="6">6 semanas</option>
            <option value="8">8 semanas</option>
          </select>
        </div>

        <div class="fcv2-field">
          <label class="fcv2-label">Stock de seguridad: <span id="safetyLabel" class="fcv2-safety-val">10%</span></label>
          <input type="range" id="safetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
        </div>

        <div class="fcv2-field fcv2-field-btn">
          <button type="button" id="btnRunForecast" class="btn fcv2-btn-run">
            <i class="bi bi-play-fill me-1"></i>Ejecutar Forecast
          </button>
        </div>
      </div>
      <div class="fcv2-helper-strip" id="helperStrip">
        <i class="bi bi-database me-1"></i>Fuente: <strong>Ventas Macro (SalesWeeklyAgg)</strong> <span id="helperDate">—</span>
      </div>
    </div>
  </div>

  <div class="fcv2-warning-banner d-none" id="warningBanner">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span id="warningText">SKU con riesgo alto: revisar compra / liquidación</span>
  </div>

  <div class="fcv2-kpi-row" id="kpiCards">
    <div class="fcv2-kpi fcv2-kpi-blue">
      <div class="fcv2-kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
      <div class="fcv2-kpi-body">
        <div class="fcv2-kpi-value" id="kpiAvgLast4">—</div>
        <div class="fcv2-kpi-label">Demanda semanal</div>
        <div class="fcv2-kpi-hint">Promedio últimas 4 sem</div>
      </div>
    </div>

    <div class="fcv2-kpi fcv2-kpi-cyan">
      <div class="fcv2-kpi-icon"><i class="bi bi-calendar-week"></i></div>
      <div class="fcv2-kpi-body">
        <div class="fcv2-kpi-value" id="kpiForecastTotal">—</div>
        <div class="fcv2-kpi-label">Demanda horizonte</div>
        <div class="fcv2-kpi-hint">Unidades proyectadas</div>
      </div>
    </div>

    <div class="fcv2-kpi fcv2-kpi-green">
      <div class="fcv2-kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
      <div class="fcv2-kpi-body">
        <div class="fcv2-kpi-value" id="kpiStockCD">—</div>
        <div class="fcv2-kpi-label">Stock total</div>
        <div class="fcv2-kpi-hint">CD + Tiendas</div>
      </div>
    </div>

    <div class="fcv2-kpi fcv2-kpi-amber">
      <div class="fcv2-kpi-icon"><i class="bi bi-cart-plus-fill"></i></div>
      <div class="fcv2-kpi-body">
        <div class="fcv2-kpi-value" id="kpiSuggested">—</div>
        <div class="fcv2-kpi-label">Compra sugerida</div>
        <div class="fcv2-kpi-hint" id="purchaseHint">—</div>
      </div>
    </div>
  </div>

  <div class="fcv2-charts-row">
    <div class="fcv2-chart-card fcv2-chart-main">
      <div class="fcv2-chart-header">
        <i class="bi bi-activity me-2"></i>Historial + Forecast
      </div>
      <div class="fcv2-chart-body">
        <div id="salesChart" class="fcv2-chart-canvas"></div>
      </div>
    </div>

    <div class="fcv2-chart-card fcv2-chart-side">
      <div class="fcv2-chart-header">
        <i class="bi bi-bar-chart-fill me-2"></i>Demanda vs Stock vs Compra
      </div>
      <div class="fcv2-chart-body">
        <div id="purchaseChart" class="fcv2-chart-canvas"></div>
      </div>
    </div>
  </div>

  <div class="fcv2-explain-card" id="explainCard">
    <div class="fcv2-explain-header">
      <i class="bi bi-lightbulb-fill me-2"></i>¿Por qué esta recomendación?
    </div>
    <div class="fcv2-explain-body" id="explainBody">
      <ul class="fcv2-explain-list" id="explainList">
        <li class="fcv2-explain-empty">
          <i class="bi bi-info-circle me-2"></i>Ejecuta el forecast para ver el análisis detallado
        </li>
      </ul>
    </div>
  </div>

  <div class="fcv2-actions-bar">
    <a href="/export/purchase_forecast_v2" class="btn fcv2-btn-outline" id="btnExport">
      <i class="bi bi-file-earmark-excel me-1"></i>Exportar Forecast
    </a>
    <a href="/alerts" class="btn fcv2-btn-outline">
      <i class="bi bi-bell me-1"></i>Ver en Alertas
    </a>
    <a href="/slow_stock" class="btn fcv2-btn-outline">
      <i class="bi bi-clock-history me-1"></i>Ver Stock Lento
    </a>
    <button type="button" class="btn fcv2-btn-primary" id="btnAddToOrder" disabled>
      <i class="bi bi-plus-circle me-1"></i>Agregar a orden de compra
    </button>
  </div>

  <div id="emptyState" class="fcv2-empty-state">
    <div class="fcv2-empty-icon">
      <i class="bi bi-search"></i>
    </div>
    <div class="fcv2-empty-title">Selecciona un SKU para calcular forecast</div>
    <div class="fcv2-empty-hint">Ingresa un SKU y haz clic en "Ejecutar" para ver proyecciones</div>
  </div>

  <div id="noDataState" class="fcv2-empty-state fcv2-empty-warning d-none">
    <div class="fcv2-empty-icon">
      <i class="bi bi-exclamation-triangle"></i>
    </div>
    <div class="fcv2-empty-title">Sin historial de ventas</div>
    <div class="fcv2-empty-hint">No se encontró historial de ventas para este SKU / filtro</div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuInput');
  const storeSelect = document.getElementById('storeSelect');
  const horizonSelect = document.getElementById('horizonSelect');
  const leadTimeSelect = document.getElementById('leadTimeSelect');
  const safetySlider = document.getElementById('safetySlider');
  const safetyLabel = document.getElementById('safetyLabel');
  const btnRun = document.getElementById('btnRunForecast');

  const kpiAvgLast4 = document.getElementById('kpiAvgLast4');
  const kpiForecastTotal = document.getElementById('kpiForecastTotal');
  const kpiStockCD = document.getElementById('kpiStockCD');
  const kpiSuggested = document.getElementById('kpiSuggested');
  const purchaseHint = document.getElementById('purchaseHint');

  const salesChartEl = document.getElementById('salesChart');
  const purchaseChartEl = document.getElementById('purchaseChart');
  const emptyState = document.getElementById('emptyState');
  const noDataState = document.getElementById('noDataState');
  const kpiCards = document.getElementById('kpiCards');
  const chartsRow = document.querySelector('.fcv2-charts-row');
  const explainCard = document.getElementById('explainCard');
  const actionsBar = document.querySelector('.fcv2-actions-bar');
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  const warningBanner = document.getElementById('warningBanner');
  const warningText = document.getElementById('warningText');
  const explainList = document.getElementById('explainList');
  const helperDate = document.getElementById('helperDate');

  safetySlider.addEventListener('input', function() {
    safetyLabel.textContent = this.value + '%';
  });

  function clearCharts() {
    Plotly.purge(salesChartEl);
    Plotly.purge(purchaseChartEl);
    salesChartEl.innerHTML = '';
    purchaseChartEl.innerHTML = '';
  }

  function resetKPIs() {
    kpiAvgLast4.textContent = '—';
    kpiForecastTotal.textContent = '—';
    kpiStockCD.textContent = '—';
    kpiSuggested.textContent = '—';
    purchaseHint.textContent = '—';
  }

  function updateStatus(type, text) {
    statusBadge.className = 'fcv2-status-badge fcv2-status-' + type;
    const icons = {
      'buy': 'bi-cart-check-fill',
      'review': 'bi-exclamation-circle-fill',
      'nobuy': 'bi-check-circle-fill',
      'neutral': 'bi-dash-circle'
    };
    statusBadge.querySelector('i').className = 'bi ' + (icons[type] || icons.neutral) + ' me-1';
    statusText.textContent = text;
  }

  function showEmptyState() {
    emptyState.classList.remove('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function showNoDataState() {
    emptyState.classList.add('d-none');
    noDataState.classList.remove('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function hideStates() {
    emptyState.classList.add('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.remove('fcv2-hidden');
    chartsRow.classList.remove('fcv2-hidden');
    explainCard.classList.remove('fcv2-hidden');
    actionsBar.classList.remove('fcv2-hidden');
  }

  function runForecast() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      showEmptyState();
      clearCharts();
      resetKPIs();
      return;
    }

    hideStates();
    btnRun.disabled = true;
    btnRun.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Calculando...';

    const params = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });

    fetch('/api/forecast_v2?' + params.toString())
      .then(res => {
        if (!res.ok) {
          if (res.status === 404) {
            showNoDataState();
            clearCharts();
            resetKPIs();
            return null;
          }
          throw new Error('API error');
        }
        return res.json();
      })
      .then(data => {
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';

        if (!data) return;

        if (data.history.length === 0 && data.forecast.length === 0) {
          showNoDataState();
          clearCharts();
          resetKPIs();
          return;
        }

        hideStates();
        updateKPIs(data.kpis, data);
        renderSalesChart(data);
        renderPurchaseChart(data);
        updateExplainability(data);
        updateWarnings(data);
      })
      .catch(err => {
        console.error('Forecast error:', err);
        showNoDataState();
        clearCharts();
        resetKPIs();
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';
      });
  }

  function updateKPIs(kpis, data) {
    kpiAvgLast4.textContent = kpis.avg_last4.toLocaleString();
    kpiForecastTotal.textContent = kpis.forecast_total.toLocaleString();
    kpiStockCD.textContent = kpis.stock_cd.toLocaleString();
    kpiSuggested.textContent = kpis.suggested_purchase.toLocaleString();
    
    const buyNow = data.buy_now || false;
    const riskLevel = data.risk_level || 'LOW';
    
    if (buyNow || kpis.suggested_purchase > 0) {
      if (riskLevel === 'HIGH' || buyNow) {
        purchaseHint.textContent = 'Comprar ahora';
        purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-urgent';
        updateStatus('buy', 'Comprar ahora');
      } else if (riskLevel === 'MEDIUM') {
        purchaseHint.textContent = 'Revisar compra';
        purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-review';
        updateStatus('review', 'Revisar');
      } else {
        purchaseHint.textContent = 'Compra recomendada';
        purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-recommend';
        updateStatus('buy', 'Comprar');
      }
    } else {
      purchaseHint.textContent = 'Sin necesidad de compra';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-ok';
      updateStatus('nobuy', 'No comprar');
    }
  }

  function updateExplainability(data) {
    const bullets = [];
    const lifecycle = data.lifecycle_status || 'UNKNOWN';
    const model = data.model_used || 'SMA';
    const reasonCode = data.reason_code || '';
    const riskLevel = data.risk_level || 'LOW';
    
    bullets.push('<li><strong>Ciclo de vida:</strong> ' + lifecycle + ' — Modelo aplicado: ' + model + '</li>');
    
    if (lifecycle === 'ACTIVE') {
      bullets.push('<li><i class="bi bi-check-circle text-success me-1"></i>SKU activo con ventas en últimos 30 días</li>');
    } else if (lifecycle === 'SLOW') {
      bullets.push('<li><i class="bi bi-clock text-warning me-1"></i>SKU lento (31-90 días) — Penalización 50% aplicada</li>');
    } else if (lifecycle === 'DEAD') {
      bullets.push('<li><i class="bi bi-x-circle text-danger me-1"></i>SKU muerto (90+ días sin ventas) — Compra bloqueada</li>');
    } else if (lifecycle === 'NEW') {
      bullets.push('<li><i class="bi bi-star text-info me-1"></i>SKU nuevo — Usando promedio de categoría (cold start)</li>');
    }
    
    if (reasonCode.includes('PROJECTED_STOCKOUT')) {
      bullets.push('<li><i class="bi bi-exclamation-triangle text-danger me-1"></i>Alerta: Stockout proyectado — Compra urgente activada</li>');
    }
    if (reasonCode.includes('BROKEN_STOCK')) {
      bullets.push('<li><i class="bi bi-exclamation-circle text-danger me-1"></i>Alerta: Quiebre de stock detectado</li>');
    }
    if (reasonCode.includes('OVERSTOCK')) {
      bullets.push('<li><i class="bi bi-box text-warning me-1"></i>Alerta: Sobrestock — Compra bloqueada</li>');
    }
    if (reasonCode.includes('SLOW_STOCK_PENALTY')) {
      bullets.push('<li><i class="bi bi-clock-history text-warning me-1"></i>Stock lento flaggeado — Reducción 50% en cantidad</li>');
    }
    if (reasonCode.includes('SILENT_SKU')) {
      bullets.push('<li><i class="bi bi-volume-mute text-muted me-1"></i>SKU silencioso (sin ventas recientes)</li>');
    }
    
    const leadTime = parseInt(leadTimeSelect.value);
    const horizon = parseInt(horizonSelect.value);
    const safety = parseInt(safetySlider.value);
    bullets.push('<li><strong>Parámetros:</strong> Horizonte ' + horizon + ' sem, Lead time ' + leadTime + ' sem, Safety ' + safety + '%</li>');
    
    if (bullets.length > 0) {
      explainList.innerHTML = bullets.join('');
    } else {
      explainList.innerHTML = '<li class="fcv2-explain-empty"><i class="bi bi-info-circle me-2"></i>Sin información adicional</li>';
    }
  }

  function updateWarnings(data) {
    const lifecycle = data.lifecycle_status || '';
    const riskLevel = data.risk_level || 'LOW';
    const reasonCode = data.reason_code || '';
    
    if (lifecycle === 'DEAD' || lifecycle === 'SLOW' || reasonCode.includes('SLOW_STOCK')) {
      warningBanner.classList.remove('d-none');
      if (lifecycle === 'DEAD') {
        warningText.textContent = 'SKU muerto: considerar liquidación antes de nueva compra';
      } else if (reasonCode.includes('SLOW_STOCK')) {
        warningText.textContent = 'SKU con stock lento flaggeado: revisar antes de comprar';
      } else {
        warningText.textContent = 'SKU con riesgo alto: revisar compra / liquidación';
      }
    } else {
      warningBanner.classList.add('d-none');
    }
  }

  function renderSalesChart(data) {
    const historyWeeks = data.history.map(h => h.week);
    const historyUnits = data.history.map(h => h.units);
    const forecastWeeks = data.forecast.map(f => f.week);
    const forecastUnits = data.forecast.map(f => f.units);

    const traces = [];

    traces.push({
      x: historyWeeks,
      y: historyUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Histórico',
      line: { color: '#3b82f6', width: 2.5 },
      marker: { size: 7, color: '#3b82f6' }
    });

    traces.push({
      x: forecastWeeks,
      y: forecastUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Forecast',
      line: { color: '#f59e0b', width: 2.5, dash: 'dash' },
      marker: { size: 7, color: '#f59e0b' }
    });

    if (data.bands && data.bands.upper && data.bands.lower) {
      traces.push({
        x: forecastWeeks.concat(forecastWeeks.slice().reverse()),
        y: data.bands.upper.concat(data.bands.lower.slice().reverse()),
        fill: 'toself',
        fillcolor: 'rgba(245, 158, 11, 0.1)',
        line: { color: 'transparent' },
        name: 'Banda de confianza',
        showlegend: true,
        type: 'scatter'
      });
    }

    const layout = {
      margin: { t: 20, b: 50, l: 55, r: 20 },
      xaxis: { title: 'Semana', tickangle: -45, gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      legend: { orientation: 'h', y: -0.28, x: 0.5, xanchor: 'center' },
      hovermode: 'x unified',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 }
    };

    Plotly.newPlot(salesChartEl, traces, layout, { responsive: true, displayModeBar: false });
  }

  function renderPurchaseChart(data) {
    const kpis = data.kpis;
    const leadTime = parseInt(leadTimeSelect.value);
    const demandLeadTime = Math.round(kpis.avg_last4 * leadTime);

    const trace = {
      x: ['Demanda Lead Time', 'Stock Total', 'Compra Sugerida'],
      y: [demandLeadTime, kpis.stock_cd, kpis.suggested_purchase],
      type: 'bar',
      marker: {
        color: ['#06b6d4', '#22c55e', '#f59e0b'],
        line: { width: 0 }
      },
      text: [demandLeadTime.toLocaleString(), kpis.stock_cd.toLocaleString(), kpis.suggested_purchase.toLocaleString()],
      textposition: 'outside',
      textfont: { size: 13, weight: 600 }
    };

    const layout = {
      margin: { t: 30, b: 80, l: 55, r: 20 },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      xaxis: { tickangle: -15, linecolor: '#e2e8f0' },
      showlegend: false,
      hovermode: 'closest',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 },
      bargap: 0.4
    };

    Plotly.newPlot(purchaseChartEl, [trace], layout, { responsive: true, displayModeBar: false });
  }

  btnRun.addEventListener('click', runForecast);

  skuInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      runForecast();
    }
  });

  showEmptyState();
});
</script>

{% endblock %}