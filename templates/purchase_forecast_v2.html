{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Proyección de Compras V2{% endblock %}
{% block content %}

<div class="forecast-wrap">
  <div class="forecast-header">
    <h1 class="forecast-title">Proyección de Compras (Semanal)</h1>
    <p class="forecast-subtitle">Proyección de demanda basada en historial de ventas, lead time y stock de seguridad</p>
  </div>

  <div class="forecast-params-card">
    <div class="forecast-params-header">
      <i class="bi bi-sliders me-2"></i>Parámetros del Forecast
    </div>
    <div class="forecast-params-body">
      <div class="forecast-params-grid">
        <div class="forecast-field forecast-field-lg">
          <label class="forecast-label">SKU</label>
          <input type="text" id="skuInput" class="form-control" list="skuList" placeholder="Buscar SKU...">
          <datalist id="skuList">
            {% for p in products %}
            <option value="{{ p.sku }}">{{ p.name }}</option>
            {% endfor %}
          </datalist>
        </div>

        <div class="forecast-field">
          <label class="forecast-label">Tienda</label>
          <select id="storeSelect" class="form-select">
            <option value="">Todas las tiendas</option>
            {% for s in stores %}
            <option value="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="forecast-field">
          <label class="forecast-label">Horizonte (semanas)</label>
          <select id="horizonSelect" class="form-select">
            <option value="4">4 semanas</option>
            <option value="8" selected>8 semanas</option>
            <option value="12">12 semanas</option>
          </select>
        </div>

        <div class="forecast-field">
          <label class="forecast-label">Lead time (semanas)</label>
          <select id="leadTimeSelect" class="form-select">
            <option value="2">2 semanas</option>
            <option value="4" selected>4 semanas</option>
            <option value="6">6 semanas</option>
            <option value="8">8 semanas</option>
          </select>
        </div>

        <div class="forecast-field">
          <label class="forecast-label">Stock de seguridad: <span id="safetyLabel" class="forecast-safety-val">10%</span></label>
          <input type="range" id="safetySlider" class="form-range" min="0" max="30" value="10" step="1">
        </div>

        <div class="forecast-field forecast-field-btn">
          <button type="button" id="btnRunForecast" class="btn forecast-btn-run">
            <i class="bi bi-play-fill me-1"></i>Ejecutar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="forecast-kpi-row" id="kpiCards">
    <div class="forecast-kpi forecast-kpi-blue">
      <div class="forecast-kpi-badge"><i class="bi bi-graph-up"></i></div>
      <div class="forecast-kpi-content">
        <div class="forecast-kpi-value" id="kpiAvgLast4">-</div>
        <div class="forecast-kpi-label">Promedio semanal</div>
        <div class="forecast-kpi-hint">Últimas 4 semanas</div>
      </div>
      <div class="forecast-kpi-deco"></div>
    </div>

    <div class="forecast-kpi forecast-kpi-cyan">
      <div class="forecast-kpi-badge"><i class="bi bi-calendar3"></i></div>
      <div class="forecast-kpi-content">
        <div class="forecast-kpi-value" id="kpiForecastTotal">-</div>
        <div class="forecast-kpi-label">Forecast (horizonte)</div>
        <div class="forecast-kpi-hint">Unidades proyectadas</div>
      </div>
      <div class="forecast-kpi-deco"></div>
    </div>

    <div class="forecast-kpi forecast-kpi-green">
      <div class="forecast-kpi-badge"><i class="bi bi-box-seam"></i></div>
      <div class="forecast-kpi-content">
        <div class="forecast-kpi-value" id="kpiStockCD">-</div>
        <div class="forecast-kpi-label">Stock CD disponible</div>
        <div class="forecast-kpi-hint">Inventario actual</div>
      </div>
      <div class="forecast-kpi-deco"></div>
    </div>

    <div class="forecast-kpi forecast-kpi-amber">
      <div class="forecast-kpi-badge"><i class="bi bi-cart-plus"></i></div>
      <div class="forecast-kpi-content">
        <div class="forecast-kpi-value" id="kpiSuggested">-</div>
        <div class="forecast-kpi-label">Compra sugerida <button class="forecast-explain-btn" id="btnWhyPurchase" title="¿Por qué?"><i class="bi bi-question-circle"></i></button></div>
        <div class="forecast-kpi-hint" id="purchaseHint">-</div>
      </div>
      <div class="forecast-kpi-deco"></div>
    </div>
  </div>

  <div class="forecast-charts-row">
    <div class="forecast-chart-card forecast-chart-main">
      <div class="forecast-chart-header">
        <i class="bi bi-activity me-2"></i>Historial de Ventas + Forecast
      </div>
      <div class="forecast-chart-body">
        <div id="salesChart" style="height: 320px;"></div>
      </div>
    </div>

    <div class="forecast-chart-card forecast-chart-side">
      <div class="forecast-chart-header">
        <i class="bi bi-bar-chart me-2"></i>Demanda vs Stock vs Compra
      </div>
      <div class="forecast-chart-body">
        <div id="purchaseChart" style="height: 320px;"></div>
      </div>
    </div>
  </div>

  <div id="emptyState" class="forecast-alert forecast-alert-info d-none">
    <i class="bi bi-info-circle me-2"></i>Selecciona un SKU y haz clic en "Ejecutar" para generar proyecciones.
  </div>

  <div id="noDataState" class="forecast-alert forecast-alert-warning d-none">
    <i class="bi bi-exclamation-triangle me-2"></i>No se encontró historial de ventas para este SKU / filtro.
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuInput');
  const storeSelect = document.getElementById('storeSelect');
  const horizonSelect = document.getElementById('horizonSelect');
  const leadTimeSelect = document.getElementById('leadTimeSelect');
  const safetySlider = document.getElementById('safetySlider');
  const safetyLabel = document.getElementById('safetyLabel');
  const btnRun = document.getElementById('btnRunForecast');

  const kpiAvgLast4 = document.getElementById('kpiAvgLast4');
  const kpiForecastTotal = document.getElementById('kpiForecastTotal');
  const kpiStockCD = document.getElementById('kpiStockCD');
  const kpiSuggested = document.getElementById('kpiSuggested');
  const purchaseHint = document.getElementById('purchaseHint');

  const salesChartEl = document.getElementById('salesChart');
  const purchaseChartEl = document.getElementById('purchaseChart');
  const emptyState = document.getElementById('emptyState');
  const noDataState = document.getElementById('noDataState');

  safetySlider.addEventListener('input', function() {
    safetyLabel.textContent = this.value + '%';
  });

  function clearCharts() {
    Plotly.purge(salesChartEl);
    Plotly.purge(purchaseChartEl);
    salesChartEl.innerHTML = '';
    purchaseChartEl.innerHTML = '';
  }

  function resetKPIs() {
    kpiAvgLast4.textContent = '-';
    kpiForecastTotal.textContent = '-';
    kpiStockCD.textContent = '-';
    kpiSuggested.textContent = '-';
    purchaseHint.textContent = '-';
    purchaseHint.className = 'forecast-kpi-hint';
  }

  function showEmptyState() {
    emptyState.classList.remove('d-none');
    noDataState.classList.add('d-none');
  }

  function showNoDataState() {
    emptyState.classList.add('d-none');
    noDataState.classList.remove('d-none');
  }

  function hideStates() {
    emptyState.classList.add('d-none');
    noDataState.classList.add('d-none');
  }

  function runForecast() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      showEmptyState();
      clearCharts();
      resetKPIs();
      return;
    }

    hideStates();

    const params = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });

    fetch('/api/forecast_v2?' + params.toString())
      .then(res => {
        if (!res.ok) {
          if (res.status === 404) {
            showNoDataState();
            clearCharts();
            resetKPIs();
            return null;
          }
          throw new Error('API error');
        }
        return res.json();
      })
      .then(data => {
        if (!data) return;

        if (data.history.length === 0 && data.forecast.length === 0) {
          showNoDataState();
          clearCharts();
          resetKPIs();
          return;
        }

        hideStates();
        updateKPIs(data.kpis);
        renderSalesChart(data);
        renderPurchaseChart(data);
      })
      .catch(err => {
        console.error('Forecast error:', err);
        showNoDataState();
        clearCharts();
        resetKPIs();
      });
  }

  function updateKPIs(kpis) {
    kpiAvgLast4.textContent = kpis.avg_last4.toLocaleString();
    kpiForecastTotal.textContent = kpis.forecast_total.toLocaleString();
    kpiStockCD.textContent = kpis.stock_cd.toLocaleString();
    kpiSuggested.textContent = kpis.suggested_purchase.toLocaleString();
    
    if (kpis.suggested_purchase > 0) {
      purchaseHint.textContent = 'Compra recomendada';
      purchaseHint.className = 'forecast-kpi-hint forecast-hint-recommend';
    } else {
      purchaseHint.textContent = 'Sin necesidad de compra';
      purchaseHint.className = 'forecast-kpi-hint forecast-hint-ok';
    }
  }

  function renderSalesChart(data) {
    const historyWeeks = data.history.map(h => h.week);
    const historyUnits = data.history.map(h => h.units);
    const forecastWeeks = data.forecast.map(f => f.week);
    const forecastUnits = data.forecast.map(f => f.units);

    const traces = [];

    traces.push({
      x: historyWeeks,
      y: historyUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Histórico',
      line: { color: '#3b82f6', width: 2 },
      marker: { size: 6 }
    });

    traces.push({
      x: forecastWeeks,
      y: forecastUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Forecast',
      line: { color: '#f59e0b', width: 2, dash: 'dash' },
      marker: { size: 6 }
    });

    if (data.bands && data.bands.upper && data.bands.lower) {
      traces.push({
        x: forecastWeeks.concat(forecastWeeks.slice().reverse()),
        y: data.bands.upper.concat(data.bands.lower.slice().reverse()),
        fill: 'toself',
        fillcolor: 'rgba(245, 158, 11, 0.12)',
        line: { color: 'transparent' },
        name: 'Banda de confianza',
        showlegend: true,
        type: 'scatter'
      });
    }

    const layout = {
      margin: { t: 20, b: 50, l: 50, r: 20 },
      xaxis: { title: 'Semana', tickangle: -45, gridcolor: '#f1f5f9' },
      yaxis: { title: 'Unidades', gridcolor: '#f1f5f9' },
      legend: { orientation: 'h', y: -0.25 },
      hovermode: 'x unified',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent'
    };

    Plotly.newPlot(salesChartEl, traces, layout, { responsive: true });
  }

  function renderPurchaseChart(data) {
    const kpis = data.kpis;
    const leadTime = parseInt(leadTimeSelect.value);
    const demandLeadTime = Math.round(kpis.avg_last4 * leadTime);

    const trace = {
      x: ['Demanda Lead Time', 'Stock CD', 'Compra Sugerida'],
      y: [demandLeadTime, kpis.stock_cd, kpis.suggested_purchase],
      type: 'bar',
      marker: {
        color: ['#06b6d4', '#22c55e', '#f59e0b'],
        borderRadius: 4
      },
      text: [demandLeadTime.toLocaleString(), kpis.stock_cd.toLocaleString(), kpis.suggested_purchase.toLocaleString()],
      textposition: 'outside'
    };

    const layout = {
      margin: { t: 30, b: 80, l: 50, r: 20 },
      yaxis: { title: 'Unidades', gridcolor: '#f1f5f9' },
      xaxis: { tickangle: -15 },
      showlegend: false,
      hovermode: 'closest',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent'
    };

    Plotly.newPlot(purchaseChartEl, [trace], layout, { responsive: true });
  }

  btnRun.addEventListener('click', runForecast);

  skuInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      runForecast();
    }
  });

  const btnWhyPurchase = document.getElementById('btnWhyPurchase');
  let fcExplainModal = null;
  
  btnWhyPurchase.addEventListener('click', showForecastExplanation);

  async function showForecastExplanation() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      alert('Selecciona un SKU primero');
      return;
    }

    if (!fcExplainModal) {
      const modalEl = document.getElementById('forecastExplainModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        fcExplainModal = new bootstrap.Modal(modalEl);
      } else {
        alert('Error: No se puede mostrar la explicación');
        return;
      }
    }
    
    document.getElementById('fcExplainSku').textContent = 'Cargando...';
    document.getElementById('fcExplainProduct').textContent = '';
    document.getElementById('fcExplainBullets').innerHTML = '<li>Cargando explicación...</li>';
    fcExplainModal.show();

    try {
      const params = new URLSearchParams({
        sku: sku,
        horizon_weeks: horizonSelect.value,
        lead_time_weeks: leadTimeSelect.value,
        safety_pct: safetySlider.value / 100,
        store: storeSelect.value || ''
      });
      const resp = await fetch('/api/explain/forecast?' + params);
      const data = await resp.json();

      if (!resp.ok || data.error) {
        document.getElementById('fcExplainBullets').innerHTML = '<li>' + (data.error || 'Error al cargar explicación') + '</li>';
        return;
      }

      document.getElementById('fcExplainSku').textContent = 'SKU: ' + (data.sku || 'N/A');
      document.getElementById('fcExplainProduct').textContent = data.product_name || 'Producto desconocido';
      document.getElementById('fcExplainStore').textContent = 'Tienda: ' + (data.store || 'Todas');

      const bullets = data.bullets || [];
      const bulletsHtml = bullets.length > 0 
        ? bullets.map(b => '<li>' + b + '</li>').join('')
        : '<li>Sin información disponible</li>';
      document.getElementById('fcExplainBullets').innerHTML = bulletsHtml;
    } catch (err) {
      document.getElementById('fcExplainBullets').innerHTML = '<li>Error al cargar explicación: ' + err.message + '</li>';
    }
  }

  showEmptyState();
});
</script>

<div class="modal fade" id="forecastExplainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fc-explain-modal-content">
      <div class="modal-header fc-explain-modal-header">
        <h5 class="modal-title"><i class="bi bi-lightbulb me-2"></i>¿Por qué esta compra sugerida?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fc-explain-modal-body">
        <div class="fc-explain-header">
          <div class="fc-explain-sku" id="fcExplainSku"></div>
          <div class="fc-explain-product" id="fcExplainProduct"></div>
          <div class="fc-explain-store" id="fcExplainStore"></div>
        </div>
        <ul class="fc-explain-bullets" id="fcExplainBullets"></ul>
      </div>
    </div>
  </div>
</div>

<style>
.forecast-explain-btn {
  background: transparent;
  border: none;
  color: #f59e0b;
  cursor: pointer;
  padding: 2px 6px;
  margin-left: 4px;
  border-radius: 6px;
  transition: all 0.15s ease;
  font-size: 0.9rem;
}
.forecast-explain-btn:hover {
  background: rgba(245, 158, 11, 0.15);
  color: #d97706;
}
.fc-explain-modal-content {
  border-radius: 16px;
  border: none;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}
.fc-explain-modal-header {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: #fff;
  border-radius: 16px 16px 0 0;
  padding: 16px 20px;
}
.fc-explain-modal-header .btn-close {
  filter: brightness(0) invert(1);
}
.fc-explain-modal-body {
  padding: 20px;
}
.fc-explain-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e2e8f0;
}
.fc-explain-sku {
  font-family: 'SF Mono', 'Consolas', monospace;
  font-size: 0.875rem;
  color: #f59e0b;
  font-weight: 600;
}
.fc-explain-product {
  font-size: 1.1rem;
  font-weight: 600;
  color: #1e293b;
  margin-top: 4px;
}
.fc-explain-store {
  font-size: 0.875rem;
  color: #64748b;
  margin-top: 4px;
}
.fc-explain-bullets {
  list-style: none;
  padding: 0;
  margin: 0;
}
.fc-explain-bullets li {
  padding: 8px 0 8px 24px;
  position: relative;
  font-size: 0.875rem;
  color: #334155;
  border-bottom: 1px solid #f1f5f9;
}
.fc-explain-bullets li:last-child {
  border-bottom: none;
}
.fc-explain-bullets li::before {
  content: '•';
  position: absolute;
  left: 8px;
  color: #f59e0b;
  font-weight: bold;
}
</style>

{% endblock %}
