{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Proyeccion de Compras V2{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <h5 class="mb-0">Proyeccion de compras V2</h5>
    <small class="text-muted">
      Lead time + Safety stock + Coverage. Snapshot CD: <strong>{{ cd_snapshot_date }}</strong>
    </small>
  </div>
</div>

{% if not has_cd_stock %}
<div class="alert alert-warning mb-3" role="alert">
  <strong>Aviso:</strong> No hay snapshot de Stock CD cargado. El stock disponible se considera 0 para todos los SKUs.
</div>
{% endif %}

{% if not has_sales %}
<div class="alert alert-info mb-3" role="alert">
  <strong>Sin ventas:</strong> No se encontraron ventas en la ventana de analisis seleccionada. Intenta ajustar el metodo de demanda o cargar datos de ventas.
</div>
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    <form id="forecastForm" class="row g-3" method="post" action="{{ url_for('purchase_forecast_v2') }}">
      <div class="col-md-2">
        <label class="form-label fw-semibold">Lead time (dias)</label>
        <input type="number" name="lead_time_days" id="lead_time_days" min="0" class="form-control form-control-sm" value="{{ lead_time_days }}">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Cobertura (semanas)</label>
        <input type="number" step="0.5" min="0.5" name="coverage_weeks" id="coverage_weeks" class="form-control form-control-sm" value="{{ coverage_weeks }}">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Safety stock (semanas)</label>
        <input type="number" step="0.5" min="0" name="safety_weeks" id="safety_weeks" class="form-control form-control-sm" value="{{ safety_weeks }}">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Metodo demanda</label>
        <select name="demand_method" id="demand_method" class="form-select form-select-sm">
          <option value="sma3" {% if demand_method == 'sma3' %}selected{% endif %}>SMA 3 semanas</option>
          <option value="sma2" {% if demand_method == 'sma2' %}selected{% endif %}>SMA 2 semanas</option>
          <option value="last_week" {% if demand_method == 'last_week' %}selected{% endif %}>Ultima semana</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Tienda (opcional)</label>
        <select name="store_filter" id="store_filter" class="form-select form-select-sm">
          <option value="">Todas las tiendas</option>
          {% for s in stores %}
            <option value="{{ s.name }}" {% if store_filter == s.name %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Min semanas hist.</label>
        <input type="number" name="min_weeks_history" min="1" class="form-control form-control-sm" value="{{ min_weeks_history }}">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Etiqueta campana (opcional)</label>
        <input type="text" name="campaign_tag" class="form-control form-control-sm" value="{{ campaign_tag }}" placeholder="Ej: Verano 2025">
      </div>

      <div class="col-md-3 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary btn-sm">Calcular proyeccion</button>
        <button type="submit" formaction="{{ url_for('export_purchase_forecast_v2') }}" class="btn btn-outline-secondary btn-sm">Exportar Excel</button>
      </div>
    </form>
  </div>
</div>

<div class="row mb-3" id="kpiCards">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Compra Sugerida Total</div>
        <div class="fs-4 fw-bold text-primary" id="kpiTotalSuggested">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Demanda / Semana</div>
        <div class="fs-4 fw-bold text-info" id="kpiTotalDemand">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Stock CD Total</div>
        <div class="fs-4 fw-bold text-success" id="kpiTotalStockCD">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">SKUs con Compra</div>
        <div class="fs-4 fw-bold text-warning" id="kpiSkusWithPurchase">-</div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col-md-4">
        <label class="form-label fw-semibold mb-1">Filtrar SKU para graficos</label>
        <select id="skuSelect" class="form-select form-select-sm">
          <option value="">Todos los SKUs (Top 10)</option>
        </select>
      </div>
      <div class="col-md-8 text-end">
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnLoadCharts">
          <i class="bi bi-graph-up"></i> Cargar graficos
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-center mb-2">Historial de Ventas por Semana</h6>
        <div id="chartHistory" style="height: 320px;"></div>
      </div>
      <div class="col-md-6">
        <h6 class="text-center mb-2">Demanda vs Stock CD vs Compra Sugerida</h6>
        <div id="chartComparison" style="height: 320px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Top 50 SKUs por compra sugerida</span>
    {% if rows %}
    <span class="badge-soft">{{ rows|length }} de {{ total_skus }} SKUs</span>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Demanda/sem</th>
            <th class="text-end">Stock CD</th>
            <th class="text-end">Requerido</th>
            <th class="text-end">Sugerido compra</th>
            <th>Campana</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
            <tr>
              <td>{{ r.sku }}</td>
              <td>{{ r.name }}</td>
              <td class="text-end">{{ r.demand_per_week }}</td>
              <td class="text-end">{{ r.available_cd }}</td>
              <td class="text-end">{{ r.required_units }}</td>
              <td class="text-end fw-semibold">
                {% if r.suggested > 0 %}
                  {{ r.suggested }}
                {% else %}
                  <span class="text-muted">0</span>
                {% endif %}
              </td>
              <td>{{ r.campaign_tag or '-' }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-muted p-3">
                No se encontraron SKUs con ventas en la ventana seleccionada. Ajusta los parametros o carga datos de ventas.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let chartData = null;

  function getParams() {
    return {
      lead_time_days: document.getElementById('lead_time_days').value || 14,
      coverage_weeks: document.getElementById('coverage_weeks').value || 4,
      safety_weeks: document.getElementById('safety_weeks').value || 1,
      demand_method: document.getElementById('demand_method').value || 'sma3',
      store_filter: document.getElementById('store_filter').value || '',
      sku: document.getElementById('skuSelect').value || ''
    };
  }

  function fetchChartData() {
    const params = getParams();
    const qs = new URLSearchParams(params).toString();

    fetch('/api/forecast_v2/chart_data?' + qs)
      .then(res => res.json())
      .then(data => {
        chartData = data;
        populateSkuDropdown(data.all_skus);
        updateKPIs(data.kpis);
        renderCharts(data.forecast, params.sku);
      })
      .catch(err => {
        console.error('Error fetching chart data:', err);
      });
  }

  function populateSkuDropdown(skus) {
    const select = document.getElementById('skuSelect');
    const currentVal = select.value;
    select.innerHTML = '<option value="">Todos los SKUs (Top 10)</option>';
    skus.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.sku;
      opt.textContent = s.sku + ' - ' + s.name;
      select.appendChild(opt);
    });
    if (currentVal) {
      select.value = currentVal;
    }
  }

  function updateKPIs(kpis) {
    document.getElementById('kpiTotalSuggested').textContent = kpis.total_suggested.toLocaleString();
    document.getElementById('kpiTotalDemand').textContent = kpis.total_demand_per_week.toLocaleString();
    document.getElementById('kpiTotalStockCD').textContent = kpis.total_stock_cd.toLocaleString();
    document.getElementById('kpiSkusWithPurchase').textContent = kpis.skus_with_purchase + ' / ' + kpis.total_skus;
  }

  function renderCharts(forecast, skuFilter) {
    renderHistoryChart(forecast, skuFilter);
    renderComparisonChart(forecast, skuFilter);
  }

  function renderHistoryChart(forecast, skuFilter) {
    const container = document.getElementById('chartHistory');
    let dataToPlot = [];

    if (skuFilter) {
      const item = forecast.find(f => f.sku === skuFilter);
      if (item && item.history_weeks.length > 0) {
        dataToPlot.push({
          x: item.history_weeks,
          y: item.history_quantities,
          type: 'scatter',
          mode: 'lines+markers',
          name: item.sku,
          line: { width: 2 }
        });

        const avgDemand = item.demand_per_week;
        dataToPlot.push({
          x: item.history_weeks,
          y: item.history_weeks.map(() => avgDemand),
          type: 'scatter',
          mode: 'lines',
          name: 'Demanda promedio',
          line: { dash: 'dash', width: 1, color: '#ff7f0e' }
        });
      }
    } else {
      const top10 = forecast.slice(0, 10);
      top10.forEach((item, idx) => {
        if (item.history_weeks.length > 0) {
          dataToPlot.push({
            x: item.history_weeks,
            y: item.history_quantities,
            type: 'scatter',
            mode: 'lines+markers',
            name: item.sku
          });
        }
      });
    }

    if (dataToPlot.length === 0) {
      container.innerHTML = '<div class="text-center text-muted py-5">Sin datos de historial</div>';
      return;
    }

    const layout = {
      margin: { t: 20, b: 50, l: 50, r: 20 },
      xaxis: { title: 'Semana' },
      yaxis: { title: 'Unidades vendidas' },
      legend: { orientation: 'h', y: -0.2 },
      hovermode: 'closest'
    };

    Plotly.newPlot(container, dataToPlot, layout, { responsive: true });
  }

  function renderComparisonChart(forecast, skuFilter) {
    const container = document.getElementById('chartComparison');
    let items = [];

    if (skuFilter) {
      const item = forecast.find(f => f.sku === skuFilter);
      if (item) items = [item];
    } else {
      items = forecast.slice(0, 10);
    }

    if (items.length === 0) {
      container.innerHTML = '<div class="text-center text-muted py-5">Sin datos</div>';
      return;
    }

    const skus = items.map(i => i.sku);
    const demandData = items.map(i => i.demand_per_week);
    const stockData = items.map(i => i.available_cd);
    const suggestedData = items.map(i => i.suggested);

    const traces = [
      {
        x: skus,
        y: demandData,
        type: 'bar',
        name: 'Demanda/sem',
        marker: { color: '#17a2b8' }
      },
      {
        x: skus,
        y: stockData,
        type: 'bar',
        name: 'Stock CD',
        marker: { color: '#28a745' }
      },
      {
        x: skus,
        y: suggestedData,
        type: 'bar',
        name: 'Compra Sugerida',
        marker: { color: '#fd7e14' }
      }
    ];

    const layout = {
      margin: { t: 20, b: 80, l: 50, r: 20 },
      barmode: 'group',
      xaxis: { title: 'SKU', tickangle: -45 },
      yaxis: { title: 'Unidades' },
      legend: { orientation: 'h', y: -0.35 },
      hovermode: 'closest'
    };

    Plotly.newPlot(container, traces, layout, { responsive: true });
  }

  document.getElementById('btnLoadCharts').addEventListener('click', fetchChartData);

  document.getElementById('skuSelect').addEventListener('change', function() {
    if (chartData) {
      renderCharts(chartData.forecast, this.value);
    }
  });

  fetchChartData();
});
</script>

{% endblock %}
