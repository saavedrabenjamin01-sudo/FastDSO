{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Forecast de Compra (V2){% endblock %}
{% block content %}

<div class="fcv2-container">
  <div class="fcv2-header">
    <div class="fcv2-header-left">
      <h1 class="fcv2-title">Forecast de Compra (V2)</h1>
      <p class="fcv2-subtitle">Proyección basada en ventas macro, lead time y stock de seguridad</p>
    </div>
    <div class="fcv2-header-right">
      <div class="fcv2-status-badge fcv2-status-neutral" id="statusBadge">
        <i class="bi bi-dash-circle me-1"></i><span id="statusText">—</span>
      </div>
    </div>
  </div>

  <div class="fcv2-tabs">
    <button class="fcv2-tab active" data-tab="single" id="tabSingle">
      <i class="bi bi-box me-1"></i>Forecast (SKU)
    </button>
    <button class="fcv2-tab" data-tab="batch" id="tabBatch">
      <i class="bi bi-boxes me-1"></i>Forecast Masivo
    </button>
    <button class="fcv2-tab" data-tab="category" id="tabCategory">
      <i class="bi bi-folder me-1"></i>Forecast por Categoría
    </button>
  </div>

  <div id="singleMode">
    <div class="fcv2-params-card">
      <div class="fcv2-params-header">
        <i class="bi bi-sliders2 me-2"></i>Parámetros del Forecast
      </div>
      <div class="fcv2-params-body">
        <div class="fcv2-params-grid">
          <div class="fcv2-field fcv2-field-lg">
            <label class="fcv2-label">SKU</label>
            <input type="text" id="skuInput" class="form-control fcv2-input" list="skuList" placeholder="Buscar SKU...">
            <datalist id="skuList">
              {% for p in products %}
              <option value="{{ p.sku }}">{{ p.name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Tienda</label>
            <select id="storeSelect" class="form-select fcv2-input">
              <option value="">Todas las tiendas</option>
              {% for s in stores %}
              <option value="{{ s.name }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Horizonte (semanas)</label>
            <select id="horizonSelect" class="form-select fcv2-input">
              <option value="4">4 semanas</option>
              <option value="8" selected>8 semanas</option>
              <option value="12">12 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Lead time (semanas)</label>
            <select id="leadTimeSelect" class="form-select fcv2-input">
              <option value="2">2 semanas</option>
              <option value="4" selected>4 semanas</option>
              <option value="6">6 semanas</option>
              <option value="8">8 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Stock de seguridad: <span id="safetyLabel" class="fcv2-safety-val">10%</span></label>
            <input type="range" id="safetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
          </div>
          <div class="fcv2-field fcv2-field-btn">
            <button type="button" id="btnRunForecast" class="btn fcv2-btn-run">
              <i class="bi bi-play-fill me-1"></i>Ejecutar Forecast
            </button>
          </div>
        </div>
        <div class="fcv2-helper-strip" id="helperStrip">
          <i class="bi bi-database me-1"></i>Fuente: <strong>Ventas Macro (SalesWeeklyAgg)</strong>
        </div>
      </div>
    </div>

    <div class="fcv2-warning-banner d-none" id="warningBanner">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <span id="warningText">SKU con riesgo alto: revisar compra / liquidación</span>
    </div>

    <div class="fcv2-kpi-row fcv2-hidden" id="kpiCards">
      <div class="fcv2-kpi fcv2-kpi-blue">
        <div class="fcv2-kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiAvgLast4">—</div>
          <div class="fcv2-kpi-label">Demanda semanal</div>
          <div class="fcv2-kpi-hint">Promedio últimas 4 sem</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-cyan">
        <div class="fcv2-kpi-icon"><i class="bi bi-calendar-week"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiForecastTotal">—</div>
          <div class="fcv2-kpi-label">Demanda horizonte</div>
          <div class="fcv2-kpi-hint">Unidades proyectadas</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-green">
        <div class="fcv2-kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiStockCD">—</div>
          <div class="fcv2-kpi-label">Stock total</div>
          <div class="fcv2-kpi-hint">CD + Tiendas</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-amber">
        <div class="fcv2-kpi-icon"><i class="bi bi-cart-plus-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiSuggested">—</div>
          <div class="fcv2-kpi-label">Compra sugerida</div>
          <div class="fcv2-kpi-hint" id="purchaseHint">—</div>
        </div>
      </div>
    </div>

    <div class="fcv2-charts-row fcv2-hidden" id="chartsRow">
      <div class="fcv2-chart-card fcv2-chart-main">
        <div class="fcv2-chart-header">
          <i class="bi bi-activity me-2"></i>Historial + Forecast
        </div>
        <div class="fcv2-chart-body">
          <div id="salesChart" class="fcv2-chart-canvas"></div>
        </div>
      </div>
      <div class="fcv2-chart-card fcv2-chart-side">
        <div class="fcv2-chart-header">
          <i class="bi bi-bar-chart-fill me-2"></i>Demanda vs Stock vs Compra
        </div>
        <div class="fcv2-chart-body">
          <div id="purchaseChart" class="fcv2-chart-canvas"></div>
        </div>
      </div>
    </div>

    <div class="fcv2-explain-card fcv2-hidden" id="explainCard">
      <div class="fcv2-explain-header">
        <i class="bi bi-lightbulb-fill me-2"></i>¿Por qué esta recomendación?
      </div>
      <div class="fcv2-explain-body" id="explainBody">
        <ul class="fcv2-explain-list" id="explainList"></ul>
      </div>
    </div>

    <div class="fcv2-actions-bar fcv2-hidden" id="actionsBar">
      <a href="#" class="btn fcv2-btn-outline" id="btnExport">
        <i class="bi bi-file-earmark-excel me-1"></i>Exportar Forecast
      </a>
      <a href="/alerts" class="btn fcv2-btn-outline" id="btnAlerts">
        <i class="bi bi-bell me-1"></i>Ver en Alertas
      </a>
      <a href="/slow_stock" class="btn fcv2-btn-outline" id="btnSlowStock">
        <i class="bi bi-clock-history me-1"></i>Ver Stock Lento
      </a>
      <a href="/dashboard_category" class="btn fcv2-btn-outline d-none" id="btnCategoryDash">
        <i class="bi bi-folder me-1"></i>Ver en Dashboard Categoría
      </a>
      <a href="/rebalancing" class="btn fcv2-btn-warning d-none" id="btnRebalance">
        <i class="bi bi-arrow-left-right me-1"></i>Redistribuir SKU
      </a>
    </div>

    <div id="emptyState" class="fcv2-empty-state">
      <div class="fcv2-empty-icon">
        <i class="bi bi-search"></i>
      </div>
      <div class="fcv2-empty-title">Selecciona un SKU para calcular forecast</div>
      <div class="fcv2-empty-hint">Ingresa un SKU y haz clic en "Ejecutar" para ver proyecciones</div>
    </div>

    <div id="noDataState" class="fcv2-empty-state fcv2-empty-warning d-none">
      <div class="fcv2-empty-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <div class="fcv2-empty-title">Sin historial de ventas</div>
      <div class="fcv2-empty-hint">No se encontró historial de ventas para este SKU / filtro</div>
    </div>
  </div>

  <div id="batchMode" class="d-none">
    <div class="fcv2-params-card">
      <div class="fcv2-params-header">
        <i class="bi bi-boxes me-2"></i>Forecast Masivo
      </div>
      <div class="fcv2-params-body">
        <div class="fcv2-batch-intro">
          <p>Carga un archivo CSV/XLSX con una columna <strong>SKU</strong> o pega SKUs directamente.</p>
        </div>
        <div class="fcv2-batch-grid">
          <div class="fcv2-field">
            <label class="fcv2-label">Archivo (CSV/XLSX)</label>
            <input type="file" id="batchFile" class="form-control fcv2-input" accept=".csv,.xlsx,.xls">
          </div>
          <div class="fcv2-field fcv2-field-lg">
            <label class="fcv2-label">O pegar SKUs (uno por línea)</label>
            <textarea id="batchSkuText" class="form-control fcv2-input" rows="3" placeholder="SKU001&#10;SKU002&#10;SKU003"></textarea>
          </div>
        </div>
        <div class="fcv2-params-grid mt-3">
          <div class="fcv2-field">
            <label class="fcv2-label">Horizonte (semanas)</label>
            <select id="batchHorizon" class="form-select fcv2-input">
              <option value="4">4 semanas</option>
              <option value="8" selected>8 semanas</option>
              <option value="12">12 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Lead time (semanas)</label>
            <select id="batchLeadTime" class="form-select fcv2-input">
              <option value="2">2 semanas</option>
              <option value="4" selected>4 semanas</option>
              <option value="6">6 semanas</option>
              <option value="8">8 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Safety %: <span id="batchSafetyLabel">10%</span></label>
            <input type="range" id="batchSafetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
          </div>
          <div class="fcv2-field fcv2-field-btn">
            <button type="button" id="btnRunBatch" class="btn fcv2-btn-run">
              <i class="bi bi-play-fill me-1"></i>Generar Batch Forecast
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="fcv2-kpi-row fcv2-hidden" id="batchKpiCards">
      <div class="fcv2-kpi fcv2-kpi-blue">
        <div class="fcv2-kpi-icon"><i class="bi bi-boxes"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiTotal">—</div>
          <div class="fcv2-kpi-label">SKUs Procesados</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-red">
        <div class="fcv2-kpi-icon"><i class="bi bi-cart-check-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiBuyNow">—</div>
          <div class="fcv2-kpi-label">Comprar Ahora</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-amber">
        <div class="fcv2-kpi-icon"><i class="bi bi-exclamation-circle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiReview">—</div>
          <div class="fcv2-kpi-label">Revisar</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-green">
        <div class="fcv2-kpi-icon"><i class="bi bi-x-circle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiDoNotBuy">—</div>
          <div class="fcv2-kpi-label">No Comprar</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-hidden" id="batchKpiErrorCard" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
        <div class="fcv2-kpi-icon"><i class="bi bi-question-circle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiError">—</div>
          <div class="fcv2-kpi-label">No Encontrados</div>
        </div>
      </div>
    </div>

    <div class="fcv2-results-card fcv2-hidden" id="batchResultsCard">
      <div class="fcv2-results-header">
        <span><i class="bi bi-table me-2"></i>Resultados del Batch</span>
        <div class="fcv2-results-actions">
          <input type="text" id="batchSearchInput" class="form-control form-control-sm" placeholder="Buscar SKU o producto..." style="width: 200px; display: inline-block;">
          <a href="#" class="btn fcv2-btn-outline-sm ms-2" id="btnBatchExport">
            <i class="bi bi-download me-1"></i>Exportar
          </a>
        </div>
      </div>
      <div class="fcv2-results-body">
        <table class="fcv2-table" id="batchTable">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Ciclo</th>
              <th>Dem. Sem.</th>
              <th>Stock</th>
              <th>Compra Sug.</th>
              <th>Decisión</th>
              <th>Razón</th>
            </tr>
          </thead>
          <tbody id="batchTableBody"></tbody>
        </table>
        <div class="fcv2-pagination" id="batchPagination"></div>
      </div>
    </div>

    <div id="batchEmptyState" class="fcv2-empty-state">
      <div class="fcv2-empty-icon">
        <i class="bi bi-file-earmark-arrow-up"></i>
      </div>
      <div class="fcv2-empty-title">Carga SKUs para generar forecast masivo</div>
      <div class="fcv2-empty-hint">Sube un archivo o pega los SKUs en el campo de texto</div>
    </div>
  </div>

  <div id="categoryMode" class="d-none">
    <div class="fcv2-params-card">
      <div class="fcv2-params-header">
        <i class="bi bi-folder me-2"></i>Forecast por Categoría
      </div>
      <div class="fcv2-params-body">
        <div class="fcv2-batch-intro">
          <p>Proyección agregada a nivel de categoría para decisiones de compra macro.</p>
        </div>
        <div class="fcv2-params-grid">
          <div class="fcv2-field fcv2-field-lg">
            <label class="fcv2-label">Categoría</label>
            <select id="catCategorySelect" class="form-select fcv2-input" required>
              <option value="">Selecciona una categoría...</option>
              {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Tienda (opcional)</label>
            <select id="catStoreSelect" class="form-select fcv2-input">
              <option value="">Todas las tiendas</option>
              {% for s in stores %}
              <option value="{{ s.name }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Horizonte (semanas)</label>
            <select id="catHorizon" class="form-select fcv2-input">
              <option value="4">4 semanas</option>
              <option value="8" selected>8 semanas</option>
              <option value="12">12 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Lead time (semanas)</label>
            <select id="catLeadTime" class="form-select fcv2-input">
              <option value="2">2 semanas</option>
              <option value="4" selected>4 semanas</option>
              <option value="6">6 semanas</option>
              <option value="8">8 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Safety %: <span id="catSafetyLabel">10%</span></label>
            <input type="range" id="catSafetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
          </div>
          <div class="fcv2-field fcv2-field-btn">
            <button type="button" id="btnRunCategoryForecast" class="btn fcv2-btn-run">
              <i class="bi bi-play-fill me-1"></i>Calcular Forecast Categoría
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="fcv2-kpi-row fcv2-hidden" id="catKpiCards">
      <div class="fcv2-kpi fcv2-kpi-blue">
        <div class="fcv2-kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="catKpiWeeklyDemand">—</div>
          <div class="fcv2-kpi-label">Demanda semanal</div>
          <div class="fcv2-kpi-hint">Unidades/semana</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-cyan">
        <div class="fcv2-kpi-icon"><i class="bi bi-calendar-week"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="catKpiHorizonDemand">—</div>
          <div class="fcv2-kpi-label">Demanda horizonte</div>
          <div class="fcv2-kpi-hint" id="catKpiHorizonHint">—</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-green">
        <div class="fcv2-kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="catKpiTotalStock">—</div>
          <div class="fcv2-kpi-label">Stock total</div>
          <div class="fcv2-kpi-hint" id="catKpiStockHint">—</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-amber">
        <div class="fcv2-kpi-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="catKpiDeficit">—</div>
          <div class="fcv2-kpi-label">Déficit proyectado</div>
          <div class="fcv2-kpi-hint">Unidades faltantes</div>
        </div>
      </div>
    </div>

    <div class="fcv2-decision-card fcv2-hidden" id="catDecisionCard">
      <div class="fcv2-decision-header">
        <div class="fcv2-decision-badge" id="catDecisionBadge">
          <i class="bi bi-dash-circle me-1"></i><span id="catDecisionText">—</span>
        </div>
        <div class="fcv2-decision-coverage" id="catCoverageInfo">—</div>
      </div>
      <div class="fcv2-decision-body">
        <div class="fcv2-action-split">
          <div class="fcv2-action-item fcv2-action-redistribute">
            <div class="fcv2-action-icon"><i class="bi bi-arrow-left-right"></i></div>
            <div class="fcv2-action-body">
              <div class="fcv2-action-label">Redistribuir primero</div>
              <div class="fcv2-action-value" id="catRedistributePotential">—</div>
            </div>
          </div>
          <div class="fcv2-action-item fcv2-action-purchase">
            <div class="fcv2-action-icon"><i class="bi bi-cart-plus-fill"></i></div>
            <div class="fcv2-action-body">
              <div class="fcv2-action-label">Compra requerida</div>
              <div class="fcv2-action-value" id="catPurchaseRequired">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fcv2-explain-card fcv2-hidden" id="catExplainCard">
      <div class="fcv2-explain-header">
        <i class="bi bi-lightbulb-fill me-2"></i>¿Por qué esta recomendación?
      </div>
      <div class="fcv2-explain-body">
        <ul class="fcv2-explain-list" id="catExplainList"></ul>
      </div>
    </div>

    <div class="fcv2-actions-bar fcv2-hidden" id="catActionsBar">
      <a href="#" class="btn fcv2-btn-outline" id="catBtnDashboard">
        <i class="bi bi-grid me-1"></i>Ver Dashboard Categoría
      </a>
      <a href="#" class="btn fcv2-btn-outline" id="catBtnSlowStock">
        <i class="bi bi-clock-history me-1"></i>Ver Stock Lento
      </a>
      <a href="#" class="btn fcv2-btn-outline" id="catBtnAlerts">
        <i class="bi bi-bell me-1"></i>Ver Alertas
      </a>
      <a href="#" class="btn fcv2-btn-warning" id="catBtnRebalance">
        <i class="bi bi-arrow-left-right me-1"></i>Redistribuir Categoría
      </a>
    </div>

    <div class="fcv2-results-card fcv2-hidden" id="catTopShortageSKUs">
      <div class="fcv2-results-header">
        <span><i class="bi bi-exclamation-triangle me-2"></i>Top 10 SKUs con Mayor Riesgo de Quiebre</span>
      </div>
      <div class="fcv2-results-body">
        <table class="fcv2-table" id="catShortageTable">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Dem. Sem.</th>
              <th>Stock Total</th>
              <th>WOC</th>
              <th>Quiebre</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="catShortageTableBody"></tbody>
        </table>
        <div class="fcv2-shortage-empty d-none" id="catShortageEmpty">
          <i class="bi bi-check-circle text-success me-2"></i>No hay SKUs con riesgo crítico en esta categoría
        </div>
      </div>
    </div>

    <div id="catEmptyState" class="fcv2-empty-state">
      <div class="fcv2-empty-icon">
        <i class="bi bi-folder2-open"></i>
      </div>
      <div class="fcv2-empty-title">Selecciona una categoría para calcular forecast</div>
      <div class="fcv2-empty-hint">El forecast de categoría ofrece una visión agregada para decisiones de compra macro</div>
    </div>
  </div>
</div>

<div class="modal fade" id="explainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header fcv2-modal-header">
        <h5 class="modal-title"><i class="bi bi-lightbulb me-2"></i>Detalle de Recomendación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <div class="fcv2-modal-sku" id="modalSku"></div>
        <div class="fcv2-modal-product" id="modalProduct"></div>
        <ul class="fcv2-explain-list" id="modalExplainList"></ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="brokenStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Quiebres detectados en tiendas</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <p>Este SKU tiene tiendas quebradas con demanda reciente. Se recomienda redistribuir antes de comprar.</p>
        <p class="text-muted small">Puedes generar redistribución desde este panel para balancear el stock antes de realizar una nueva compra.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="#" class="btn btn-warning" id="brokenStockModalBtn">
          <i class="bi bi-arrow-left-right me-1"></i>Generar redistribución
        </a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="batchBrokenStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>SKUs con quiebres detectados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <p>Se detectaron <strong id="batchBrokenCount">0</strong> SKUs con tiendas quebradas y demanda reciente.</p>
        <p class="text-muted small">Recomendación: revisar redistribución antes de compra.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-warning" id="filterBrokenBtn">
          <i class="bi bi-funnel me-1"></i>Ver solo SKUs con quiebre
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuInput');
  const storeSelect = document.getElementById('storeSelect');
  const horizonSelect = document.getElementById('horizonSelect');
  const leadTimeSelect = document.getElementById('leadTimeSelect');
  const safetySlider = document.getElementById('safetySlider');
  const safetyLabel = document.getElementById('safetyLabel');
  const btnRun = document.getElementById('btnRunForecast');

  const kpiAvgLast4 = document.getElementById('kpiAvgLast4');
  const kpiForecastTotal = document.getElementById('kpiForecastTotal');
  const kpiStockCD = document.getElementById('kpiStockCD');
  const kpiSuggested = document.getElementById('kpiSuggested');
  const purchaseHint = document.getElementById('purchaseHint');

  const salesChartEl = document.getElementById('salesChart');
  const purchaseChartEl = document.getElementById('purchaseChart');
  const emptyState = document.getElementById('emptyState');
  const noDataState = document.getElementById('noDataState');
  const kpiCards = document.getElementById('kpiCards');
  const chartsRow = document.getElementById('chartsRow');
  const explainCard = document.getElementById('explainCard');
  const actionsBar = document.getElementById('actionsBar');
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  const warningBanner = document.getElementById('warningBanner');
  const warningText = document.getElementById('warningText');
  const explainList = document.getElementById('explainList');

  const tabSingle = document.getElementById('tabSingle');
  const tabBatch = document.getElementById('tabBatch');
  const tabCategory = document.getElementById('tabCategory');
  const singleMode = document.getElementById('singleMode');
  const batchMode = document.getElementById('batchMode');
  const categoryMode = document.getElementById('categoryMode');

  let currentSku = '';
  let currentBatchId = '';
  let currentCategory = '';

  tabSingle.addEventListener('click', () => switchTab('single'));
  tabBatch.addEventListener('click', () => switchTab('batch'));
  tabCategory.addEventListener('click', () => switchTab('category'));

  function switchTab(tab) {
    tabSingle.classList.remove('active');
    tabBatch.classList.remove('active');
    tabCategory.classList.remove('active');
    singleMode.classList.add('d-none');
    batchMode.classList.add('d-none');
    categoryMode.classList.add('d-none');
    
    if (tab === 'single') {
      tabSingle.classList.add('active');
      singleMode.classList.remove('d-none');
    } else if (tab === 'batch') {
      tabBatch.classList.add('active');
      batchMode.classList.remove('d-none');
    } else if (tab === 'category') {
      tabCategory.classList.add('active');
      categoryMode.classList.remove('d-none');
    }
  }

  safetySlider.addEventListener('input', function() {
    safetyLabel.textContent = this.value + '%';
  });
  
  const catSafetySlider = document.getElementById('catSafetySlider');
  const catSafetyLabel = document.getElementById('catSafetyLabel');
  if (catSafetySlider) {
    catSafetySlider.addEventListener('input', function() {
      catSafetyLabel.textContent = this.value + '%';
    });
  }

  function clearCharts() {
    Plotly.purge(salesChartEl);
    Plotly.purge(purchaseChartEl);
    salesChartEl.innerHTML = '';
    purchaseChartEl.innerHTML = '';
  }

  function resetKPIs() {
    kpiAvgLast4.textContent = '—';
    kpiForecastTotal.textContent = '—';
    kpiStockCD.textContent = '—';
    kpiSuggested.textContent = '—';
    purchaseHint.textContent = '—';
  }

  function updateStatus(type, text) {
    statusBadge.className = 'fcv2-status-badge fcv2-status-' + type;
    const icons = {
      'buy': 'bi-cart-check-fill',
      'review': 'bi-exclamation-circle-fill',
      'nobuy': 'bi-check-circle-fill',
      'neutral': 'bi-dash-circle'
    };
    statusBadge.querySelector('i').className = 'bi ' + (icons[type] || icons.neutral) + ' me-1';
    statusText.textContent = text;
  }

  function showEmptyState() {
    emptyState.classList.remove('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function showNoDataState() {
    emptyState.classList.add('d-none');
    noDataState.classList.remove('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function hideStates() {
    emptyState.classList.add('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.remove('fcv2-hidden');
    chartsRow.classList.remove('fcv2-hidden');
    explainCard.classList.remove('fcv2-hidden');
    actionsBar.classList.remove('fcv2-hidden');
  }

  function runForecast() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      showEmptyState();
      clearCharts();
      resetKPIs();
      return;
    }
    currentSku = sku;

    hideStates();
    btnRun.disabled = true;
    btnRun.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Calculando...';

    const params = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });

    fetch('/api/forecast_v2?' + params.toString())
      .then(res => {
        if (!res.ok) {
          if (res.status === 404) {
            showNoDataState();
            clearCharts();
            resetKPIs();
            return null;
          }
          throw new Error('API error');
        }
        return res.json();
      })
      .then(data => {
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';

        if (!data) return;

        if (data.history.length === 0 && data.forecast.length === 0) {
          showNoDataState();
          clearCharts();
          resetKPIs();
          return;
        }

        hideStates();
        updateKPIs(data.kpis, data);
        renderSalesChart(data);
        renderPurchaseChart(data);
        updateExplainability(data);
        updateWarnings(data);
        updateActionButtons(sku, data);
        
        checkBrokenStockPopup(data);
      })
      .catch(err => {
        console.error('Forecast error:', err);
        showNoDataState();
        clearCharts();
        resetKPIs();
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';
      });
  }

  function updateKPIs(kpis, data) {
    kpiAvgLast4.textContent = kpis.avg_last4.toLocaleString();
    kpiForecastTotal.textContent = kpis.forecast_total.toLocaleString();
    kpiStockCD.textContent = kpis.stock_cd.toLocaleString();
    
    const suggestedPurchase = kpis.suggested_purchase || 0;
    kpiSuggested.textContent = Math.max(0, suggestedPurchase).toLocaleString();
    
    let decision = data.decision || 'REVIEW';
    
    if (suggestedPurchase <= 0 && decision === 'BUY_NOW') {
      decision = 'DO_NOT_BUY';
    }
    
    if (decision === 'BUY_NOW') {
      purchaseHint.textContent = 'Comprar ahora';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-urgent';
      updateStatus('buy', 'Comprar ahora');
    } else if (decision === 'REVIEW') {
      purchaseHint.textContent = 'Revisar compra';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-review';
      updateStatus('review', 'Revisar');
    } else {
      purchaseHint.textContent = 'No comprar';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-ok';
      updateStatus('nobuy', 'No comprar');
    }
  }

  function formatExplanationPills(text) {
    const pillMap = {
      '[MACRO]': '<span class="explain-pill explain-pill-source">MACRO</span>',
      '[CATEGORY_FALLBACK]': '<span class="explain-pill explain-pill-source">CATEGORÍA</span>',
      '[OK]': '<span class="explain-pill explain-pill-ok">OK</span>',
      '[CRÍTICO]': '<span class="explain-pill explain-pill-critical">CRÍTICO</span>',
      '[BAJO]': '<span class="explain-pill explain-pill-low">BAJO</span>',
      '[ALTO]': '<span class="explain-pill explain-pill-high">ALTO</span>',
      '[COMPRAR]': '<span class="explain-pill explain-pill-buy">COMPRAR</span>',
      '[REDISTRIBUIR]': '<span class="explain-pill explain-pill-redistribute">REDISTRIBUIR</span>',
      '[NO_COMPRAR]': '<span class="explain-pill explain-pill-nobuy">NO COMPRAR</span>',
      '[ERROR]': '<span class="explain-pill explain-pill-error">ERROR</span>'
    };
    let result = text;
    for (const [bracket, pill] of Object.entries(pillMap)) {
      result = result.replace(bracket, pill);
    }
    return result;
  }

  function updateExplainability(data) {
    const bullets = data.explain_bullets || [];
    if (bullets.length > 0) {
      explainList.innerHTML = bullets.map(b => '<li>' + formatExplanationPills(b) + '</li>').join('');
    } else {
      explainList.innerHTML = '<li class="fcv2-explain-empty"><i class="bi bi-info-circle me-2"></i>Sin información adicional</li>';
    }
  }

  function updateWarnings(data) {
    const lifecycle = data.lifecycle_status || '';
    const reasonCode = data.reason_code || '';
    
    if (lifecycle === 'DEAD' || lifecycle === 'SLOW' || reasonCode.includes('SLOW_STOCK')) {
      warningBanner.classList.remove('d-none');
      if (lifecycle === 'DEAD') {
        warningText.textContent = 'SKU muerto: considerar liquidación antes de nueva compra';
      } else if (reasonCode.includes('SLOW_STOCK')) {
        warningText.textContent = 'SKU con stock lento flaggeado: revisar antes de comprar';
      } else {
        warningText.textContent = 'SKU con riesgo alto: revisar compra / liquidación';
      }
    } else {
      warningBanner.classList.add('d-none');
    }
  }

  function updateActionButtons(sku, data) {
    const encodedSku = encodeURIComponent(sku);
    const category = data && data.category ? encodeURIComponent(data.category) : '';
    const exportParams = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });
    
    document.getElementById('btnExport').href = '/forecast/export?' + exportParams.toString();
    
    let alertsUrl = '/alerts?sku=' + encodedSku;
    if (category) alertsUrl += '&category=' + category;
    document.getElementById('btnAlerts').href = alertsUrl;
    
    let slowStockUrl = '/slow_stock?sku_search=' + encodedSku;
    if (category) slowStockUrl += '&category=' + category;
    document.getElementById('btnSlowStock').href = slowStockUrl;
    
    const btnCategoryDash = document.getElementById('btnCategoryDash');
    if (btnCategoryDash) {
      if (category) {
        btnCategoryDash.classList.remove('d-none');
        btnCategoryDash.href = '/dashboard_category?category=' + category + '&sku_highlight=' + encodedSku;
      } else {
        btnCategoryDash.classList.add('d-none');
      }
    }
    
    const btnRebalance = document.getElementById('btnRebalance');
    const brokenStockFlag = data && data.broken_stock_flag;
    const reasonCode = data && data.reason_code || '';
    
    if (brokenStockFlag || reasonCode.includes('BROKEN_STOCK')) {
      btnRebalance.classList.remove('d-none');
      btnRebalance.href = '/rebalancing?sku=' + encodedSku;
    } else {
      btnRebalance.classList.add('d-none');
    }
  }

  function checkBrokenStockPopup(data) {
    const brokenStockFlag = data && data.broken_stock_flag;
    const reasonCode = data && data.reason_code || '';
    const decision = data && data.decision || '';
    
    if ((brokenStockFlag || reasonCode.includes('BROKEN_STOCK') || reasonCode.includes('BROKEN_STOCK_REBALANCE')) && decision === 'REVIEW') {
      const encodedSku = encodeURIComponent(data.sku);
      document.getElementById('brokenStockModalBtn').href = '/rebalancing?sku=' + encodedSku;
      const modal = new bootstrap.Modal(document.getElementById('brokenStockModal'));
      modal.show();
    }
  }

  let allBatchResults = [];
  let showOnlyBroken = false;

  function checkBatchBrokenStockPopup(results, brokenCount) {
    if (brokenCount > 0) {
      document.getElementById('batchBrokenCount').textContent = brokenCount;
      const modal = new bootstrap.Modal(document.getElementById('batchBrokenStockModal'));
      modal.show();
    }
  }

  document.getElementById('filterBrokenBtn').addEventListener('click', function() {
    showOnlyBroken = !showOnlyBroken;
    const filteredResults = showOnlyBroken ? allBatchResults.filter(r => r.broken_stock_flag) : allBatchResults;
    renderBatchTable(filteredResults);
    bootstrap.Modal.getInstance(document.getElementById('batchBrokenStockModal')).hide();
    this.innerHTML = showOnlyBroken ? '<i class="bi bi-list me-1"></i>Ver todos' : '<i class="bi bi-funnel me-1"></i>Ver solo SKUs con quiebre';
  });

  function renderSalesChart(data) {
    const historyWeeks = data.history.map(h => h.week);
    const historyUnits = data.history.map(h => h.units);
    const forecastWeeks = data.forecast.map(f => f.week);
    const forecastUnits = data.forecast.map(f => f.units);

    const traces = [];
    traces.push({
      x: historyWeeks,
      y: historyUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Histórico',
      line: { color: '#3b82f6', width: 2.5 },
      marker: { size: 7, color: '#3b82f6' }
    });
    traces.push({
      x: forecastWeeks,
      y: forecastUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Forecast',
      line: { color: '#f59e0b', width: 2.5, dash: 'dash' },
      marker: { size: 7, color: '#f59e0b' }
    });

    if (data.bands && data.bands.upper && data.bands.lower) {
      traces.push({
        x: forecastWeeks.concat(forecastWeeks.slice().reverse()),
        y: data.bands.upper.concat(data.bands.lower.slice().reverse()),
        fill: 'toself',
        fillcolor: 'rgba(245, 158, 11, 0.1)',
        line: { color: 'transparent' },
        name: 'Banda de confianza',
        showlegend: true,
        type: 'scatter'
      });
    }

    const layout = {
      margin: { t: 20, b: 50, l: 55, r: 20 },
      xaxis: { title: 'Semana', tickangle: -45, gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      legend: { orientation: 'h', y: -0.28, x: 0.5, xanchor: 'center' },
      hovermode: 'x unified',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 }
    };

    Plotly.newPlot(salesChartEl, traces, layout, { responsive: true, displayModeBar: false });
  }

  function renderPurchaseChart(data) {
    const kpis = data.kpis;
    const leadTime = parseInt(leadTimeSelect.value);
    const demandLeadTime = Math.round(kpis.avg_last4 * leadTime);

    const trace = {
      x: ['Demanda Lead Time', 'Stock Total', 'Compra Sugerida'],
      y: [demandLeadTime, kpis.stock_cd, kpis.suggested_purchase],
      type: 'bar',
      marker: { color: ['#06b6d4', '#22c55e', '#f59e0b'], line: { width: 0 } },
      text: [demandLeadTime.toLocaleString(), kpis.stock_cd.toLocaleString(), kpis.suggested_purchase.toLocaleString()],
      textposition: 'outside',
      textfont: { size: 13, weight: 600 }
    };

    const layout = {
      margin: { t: 30, b: 80, l: 55, r: 20 },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      xaxis: { tickangle: -15, linecolor: '#e2e8f0' },
      showlegend: false,
      hovermode: 'closest',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 },
      bargap: 0.4
    };

    Plotly.newPlot(purchaseChartEl, [trace], layout, { responsive: true, displayModeBar: false });
  }

  btnRun.addEventListener('click', runForecast);
  skuInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') runForecast();
  });

  const batchSafetySlider = document.getElementById('batchSafetySlider');
  const batchSafetyLabel = document.getElementById('batchSafetyLabel');
  const btnRunBatch = document.getElementById('btnRunBatch');
  const batchKpiCards = document.getElementById('batchKpiCards');
  const batchResultsCard = document.getElementById('batchResultsCard');
  const batchEmptyState = document.getElementById('batchEmptyState');
  const batchTableBody = document.getElementById('batchTableBody');
  const batchPagination = document.getElementById('batchPagination');

  batchSafetySlider.addEventListener('input', function() {
    batchSafetyLabel.textContent = this.value + '%';
  });

  btnRunBatch.addEventListener('click', runBatchForecast);
  
  const batchSearchInput = document.getElementById('batchSearchInput');
  batchSearchInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    if (!allBatchResults.length) return;
    
    if (!query) {
      renderBatchTable(showOnlyBroken ? allBatchResults.filter(r => r.broken_stock_flag) : allBatchResults);
      return;
    }
    
    const filtered = allBatchResults.filter(r => {
      const matchSku = (r.sku || '').toLowerCase().includes(query);
      const matchName = (r.product_name || '').toLowerCase().includes(query);
      return matchSku || matchName;
    });
    renderBatchTable(showOnlyBroken ? filtered.filter(r => r.broken_stock_flag) : filtered);
  });

  function runBatchForecast() {
    const formData = new FormData();
    const fileInput = document.getElementById('batchFile');
    const skuText = document.getElementById('batchSkuText').value.trim();
    
    if (fileInput.files.length > 0) {
      formData.append('file', fileInput.files[0]);
    } else if (skuText) {
      formData.append('sku_list', skuText);
    } else {
      alert('Por favor carga un archivo o ingresa SKUs');
      return;
    }
    
    formData.append('horizon_weeks', document.getElementById('batchHorizon').value);
    formData.append('lead_time_weeks', document.getElementById('batchLeadTime').value);
    formData.append('safety_pct', (parseInt(batchSafetySlider.value) / 100).toFixed(2));

    btnRunBatch.disabled = true;
    btnRunBatch.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando...';

    fetch('/api/forecast/batch', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      btnRunBatch.disabled = false;
      btnRunBatch.innerHTML = '<i class="bi bi-play-fill me-1"></i>Generar Batch Forecast';

      if (data.error) {
        alert(data.error);
        return;
      }

      currentBatchId = data.batch_id;
      batchEmptyState.classList.add('d-none');
      batchKpiCards.classList.remove('fcv2-hidden');
      batchResultsCard.classList.remove('fcv2-hidden');

      document.getElementById('batchKpiTotal').textContent = data.total_skus;
      document.getElementById('batchKpiBuyNow').textContent = data.buy_now_count;
      document.getElementById('batchKpiReview').textContent = data.review_count;
      document.getElementById('batchKpiDoNotBuy').textContent = data.do_not_buy_count;
      
      const errorCount = data.error_count || 0;
      const errorCard = document.getElementById('batchKpiErrorCard');
      if (errorCount > 0) {
        document.getElementById('batchKpiError').textContent = errorCount;
        errorCard.classList.remove('fcv2-hidden');
      } else {
        errorCard.classList.add('fcv2-hidden');
      }

      document.getElementById('btnBatchExport').href = '/forecast/batch/export/' + data.batch_id;

      allBatchResults = data.results;
      showOnlyBroken = false;

      if (data.total_skus > 10) {
        loadBatchPage(data.batch_id, 1);
      } else {
        renderBatchTable(data.results);
        batchPagination.innerHTML = '';
      }

      const brokenCount = data.broken_stock_count || 0;
      if (brokenCount > 0) {
        checkBatchBrokenStockPopup(data.results, brokenCount);
      }
    })
    .catch(err => {
      console.error('Batch error:', err);
      btnRunBatch.disabled = false;
      btnRunBatch.innerHTML = '<i class="bi bi-play-fill me-1"></i>Generar Batch Forecast';
      alert('Error al procesar batch');
    });
  }

  function renderBatchTable(results) {
    batchTableBody.innerHTML = '';
    results.forEach(r => {
      const decisionClass = r.decision === 'BUY_NOW' ? 'fcv2-badge-buy' : 
                            r.decision === 'REVIEW' ? 'fcv2-badge-review' : 
                            r.decision === 'ERROR' ? 'fcv2-badge-error' : 'fcv2-badge-nobuy';
      const decisionLabel = r.decision === 'BUY_NOW' ? 'Comprar' : 
                            r.decision === 'REVIEW' ? 'Revisar' : 
                            r.decision === 'ERROR' ? 'Error' : 'No Comprar';
      
      const brokenBadge = r.broken_stock_flag ? 
        '<span class="badge bg-warning text-dark ms-1" title="Tiendas con quiebre"><i class="bi bi-exclamation-triangle-fill"></i></span>' : '';
      
      const redistributeLink = r.broken_stock_flag ? 
        '<a href="/rebalancing?sku=' + encodeURIComponent(r.sku) + '" class="btn btn-sm btn-outline-warning ms-1" title="Redistribuir" onclick="event.stopPropagation();"><i class="bi bi-arrow-left-right"></i></a>' : '';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><code>${r.sku}</code>${brokenBadge}</td>
        <td>${r.product_name}</td>
        <td>${r.category}</td>
        <td><span class="fcv2-lifecycle-badge">${r.lifecycle_status}</span></td>
        <td>${r.weekly_demand.toLocaleString()}</td>
        <td>${r.total_stock.toLocaleString()}</td>
        <td><strong>${r.suggested_purchase.toLocaleString()}</strong></td>
        <td><span class="fcv2-decision-badge ${decisionClass}">${decisionLabel}</span></td>
        <td><span class="fcv2-reason-text">${r.reason_summary}</span>${redistributeLink}</td>
      `;
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => showExplainModal(r));
      batchTableBody.appendChild(row);
    });
  }

  function showExplainModal(item) {
    document.getElementById('modalSku').textContent = 'SKU: ' + item.sku;
    document.getElementById('modalProduct').textContent = item.product_name;
    const bullets = item.explain_bullets || [];
    document.getElementById('modalExplainList').innerHTML = bullets.map(b => '<li>' + formatExplanationPills(b) + '</li>').join('');
    
    const modal = new bootstrap.Modal(document.getElementById('explainModal'));
    modal.show();
  }

  function loadBatchPage(batchId, page) {
    fetch('/api/forecast/batch/' + batchId + '?page=' + page)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          console.error(data.error);
          return;
        }
        renderBatchTable(data.results);
        renderPagination(batchId, data.page, data.total_pages);
        
        const errorCount = data.error_count || 0;
        const errorCard = document.getElementById('batchKpiErrorCard');
        if (errorCount > 0) {
          document.getElementById('batchKpiError').textContent = errorCount;
          errorCard.classList.remove('fcv2-hidden');
        } else {
          errorCard.classList.add('fcv2-hidden');
        }
      })
      .catch(err => console.error('Pagination error:', err));
  }

  function renderPagination(batchId, currentPage, totalPages) {
    if (totalPages <= 1) {
      batchPagination.innerHTML = '';
      return;
    }
    let html = '';
    
    if (currentPage > 1) {
      html += '<button class="fcv2-page-btn" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + (currentPage-1) + ')">&laquo;</button>';
    }
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
      const active = i === currentPage ? ' active' : '';
      html += '<button class="fcv2-page-btn' + active + '" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + i + ')">' + i + '</button>';
    }
    
    if (currentPage < totalPages) {
      html += '<button class="fcv2-page-btn" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + (currentPage+1) + ')">&raquo;</button>';
    }
    
    batchPagination.innerHTML = html;
  }

  window.loadBatchPageGlobal = function(batchId, page) {
    loadBatchPage(batchId, page);
  };

  // ===== CATEGORY FORECAST =====
  const catCategorySelect = document.getElementById('catCategorySelect');
  const catStoreSelect = document.getElementById('catStoreSelect');
  const catHorizon = document.getElementById('catHorizon');
  const catLeadTime = document.getElementById('catLeadTime');
  const btnRunCat = document.getElementById('btnRunCategoryForecast');
  
  const catKpiCards = document.getElementById('catKpiCards');
  const catDecisionCard = document.getElementById('catDecisionCard');
  const catExplainCard = document.getElementById('catExplainCard');
  const catActionsBar = document.getElementById('catActionsBar');
  const catEmptyState = document.getElementById('catEmptyState');
  
  if (btnRunCat) {
    btnRunCat.addEventListener('click', runCategoryForecast);
  }
  
  function runCategoryForecast() {
    const category = catCategorySelect.value;
    if (!category) {
      alert('Por favor selecciona una categoría');
      return;
    }
    currentCategory = category;
    
    btnRunCat.disabled = true;
    btnRunCat.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Calculando...';
    
    const params = new URLSearchParams({
      category: category,
      store: catStoreSelect.value,
      horizon_weeks: catHorizon.value,
      lead_time_weeks: catLeadTime.value,
      safety_pct: (catSafetySlider.value / 100).toFixed(2)
    });
    
    fetch('/api/forecast/category?' + params.toString())
      .then(r => r.json())
      .then(data => {
        btnRunCat.disabled = false;
        btnRunCat.innerHTML = '<i class="bi bi-play-fill me-1"></i>Calcular Forecast Categoría';
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        // Show results
        catEmptyState.classList.add('d-none');
        catKpiCards.classList.remove('fcv2-hidden');
        catDecisionCard.classList.remove('fcv2-hidden');
        catExplainCard.classList.remove('fcv2-hidden');
        catActionsBar.classList.remove('fcv2-hidden');
        
        // Update KPIs
        document.getElementById('catKpiWeeklyDemand').textContent = data.weekly_demand.toLocaleString();
        document.getElementById('catKpiHorizonDemand').textContent = data.horizon_demand.toLocaleString();
        document.getElementById('catKpiHorizonHint').textContent = data.horizon_weeks + ' semanas';
        document.getElementById('catKpiTotalStock').textContent = data.total_stock.toLocaleString();
        document.getElementById('catKpiStockHint').textContent = 'CD: ' + data.stock_cd.toLocaleString() + ' + Tiendas: ' + data.stock_stores.toLocaleString();
        document.getElementById('catKpiDeficit').textContent = data.deficit.toLocaleString();
        
        // Update decision badge
        const decisionBadge = document.getElementById('catDecisionBadge');
        const decisionText = document.getElementById('catDecisionText');
        decisionBadge.className = 'fcv2-decision-badge';
        
        if (data.decision === 'BUY_NOW') {
          decisionBadge.classList.add('fcv2-decision-buy');
          decisionText.innerHTML = '<i class="bi bi-cart-check-fill me-1"></i>COMPRAR AHORA';
        } else if (data.decision === 'REVIEW') {
          decisionBadge.classList.add('fcv2-decision-review');
          decisionText.innerHTML = '<i class="bi bi-exclamation-circle-fill me-1"></i>REVISAR';
        } else {
          decisionBadge.classList.add('fcv2-decision-nobuy');
          decisionText.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>NO COMPRAR';
        }
        
        document.getElementById('catCoverageInfo').textContent = 'Cobertura: ' + data.coverage_weeks + ' semanas';
        
        // Update action split
        document.getElementById('catRedistributePotential').textContent = data.redistribute_potential.toLocaleString() + ' u';
        document.getElementById('catPurchaseRequired').textContent = data.purchase_required.toLocaleString() + ' u';
        
        // Update explanation
        const catExplainList = document.getElementById('catExplainList');
        catExplainList.innerHTML = '';
        data.explain_bullets.forEach(bullet => {
          const li = document.createElement('li');
          li.innerHTML = formatExplanationPills(bullet);
          catExplainList.appendChild(li);
        });
        
        // Update action links
        document.getElementById('catBtnDashboard').href = '/dashboard_category?category=' + encodeURIComponent(category);
        document.getElementById('catBtnSlowStock').href = '/slow_stock?category=' + encodeURIComponent(category);
        document.getElementById('catBtnAlerts').href = '/alerts?category=' + encodeURIComponent(category);
        document.getElementById('catBtnRebalance').href = '/rebalancing?category=' + encodeURIComponent(category);
        
        // Render Top 10 Shortage SKUs
        const shortageCard = document.getElementById('catTopShortageSKUs');
        const shortageTableBody = document.getElementById('catShortageTableBody');
        const shortageEmpty = document.getElementById('catShortageEmpty');
        const shortageTable = document.getElementById('catShortageTable');
        
        if (data.top_shortage_skus && data.top_shortage_skus.length > 0) {
          shortageCard.classList.remove('fcv2-hidden');
          shortageTable.classList.remove('d-none');
          shortageEmpty.classList.add('d-none');
          shortageTableBody.innerHTML = '';
          
          data.top_shortage_skus.forEach(sku => {
            const tr = document.createElement('tr');
            const breakageBadge = sku.has_breakage ? '<span class="badge bg-danger ms-1">QUIEBRE</span>' : '';
            const wocClass = sku.woc < 2 ? 'text-danger fw-bold' : (sku.woc < 4 ? 'text-warning' : '');
            tr.innerHTML = `
              <td><strong>${sku.sku}</strong></td>
              <td>${sku.product_name}</td>
              <td>${sku.weekly_demand.toLocaleString()}</td>
              <td>${sku.total_stock.toLocaleString()}</td>
              <td class="${wocClass}">${sku.woc}</td>
              <td>${breakageBadge || '<span class="text-muted">—</span>'}</td>
              <td>
                <a href="/purchase_forecast_v2?sku=${encodeURIComponent(sku.sku)}" class="btn btn-sm fcv2-btn-outline-sm me-1" title="Abrir Forecast SKU">
                  <i class="bi bi-box"></i>
                </a>
                <a href="/alerts?sku=${encodeURIComponent(sku.sku)}" class="btn btn-sm fcv2-btn-outline-sm me-1" title="Ver Alertas">
                  <i class="bi bi-bell"></i>
                </a>
                <a href="/slow_stock?sku_search=${encodeURIComponent(sku.sku)}" class="btn btn-sm fcv2-btn-outline-sm" title="Ver en Stock Lento">
                  <i class="bi bi-clock-history"></i>
                </a>
              </td>
            `;
            shortageTableBody.appendChild(tr);
          });
        } else {
          shortageCard.classList.remove('fcv2-hidden');
          shortageTable.classList.add('d-none');
          shortageEmpty.classList.remove('d-none');
        }
      })
      .catch(err => {
        btnRunCat.disabled = false;
        btnRunCat.innerHTML = '<i class="bi bi-play-fill me-1"></i>Calcular Forecast Categoría';
        console.error('Error:', err);
        alert('Error al calcular forecast: ' + err.message);
      });
  }

  showEmptyState();
});
</script>

{% endblock %}