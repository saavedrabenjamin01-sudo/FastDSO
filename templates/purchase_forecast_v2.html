{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Proyeccion de Compras V2{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h5 class="mb-0">Forecast Compra V2</h5>
    <small class="text-muted">Proyeccion de compras con lead time, safety stock y cobertura</small>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold">SKU</label>
        <input type="text" id="skuInput" class="form-control form-control-sm" list="skuList" placeholder="Buscar SKU...">
        <datalist id="skuList">
          {% for p in products %}
          <option value="{{ p.sku }}">{{ p.name }}</option>
          {% endfor %}
        </datalist>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Tienda</label>
        <select id="storeSelect" class="form-select form-select-sm">
          <option value="">Todas las tiendas</option>
          {% for s in stores %}
          <option value="{{ s.name }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Horizonte (sem)</label>
        <select id="horizonSelect" class="form-select form-select-sm">
          <option value="4">4 semanas</option>
          <option value="8" selected>8 semanas</option>
          <option value="12">12 semanas</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Lead time (sem)</label>
        <select id="leadTimeSelect" class="form-select form-select-sm">
          <option value="2">2 semanas</option>
          <option value="4" selected>4 semanas</option>
          <option value="6">6 semanas</option>
          <option value="8">8 semanas</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Safety: <span id="safetyLabel">10%</span></label>
        <input type="range" id="safetySlider" class="form-range" min="0" max="30" value="10" step="1">
      </div>

      <div class="col-md-1">
        <button type="button" id="btnRunForecast" class="btn btn-primary btn-sm w-100">
          <i class="bi bi-play-fill"></i> Run
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3" id="kpiCards">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Promedio 4 semanas</div>
        <div class="fs-4 fw-bold text-primary" id="kpiAvgLast4">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Forecast Total (horizonte)</div>
        <div class="fs-4 fw-bold text-info" id="kpiForecastTotal">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Stock CD</div>
        <div class="fs-4 fw-bold text-success" id="kpiStockCD">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body py-3">
        <div class="text-muted small">Compra Sugerida</div>
        <div class="fs-4 fw-bold text-warning" id="kpiSuggested">-</div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-7">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong>Historial de Ventas + Forecast</strong>
      </div>
      <div class="card-body">
        <div id="salesChart" style="height: 320px;"></div>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong>Demanda vs Stock vs Compra</strong>
      </div>
      <div class="card-body">
        <div id="purchaseChart" style="height: 320px;"></div>
      </div>
    </div>
  </div>
</div>

<div id="emptyState" class="alert alert-info d-none">
  <i class="bi bi-info-circle"></i> Selecciona un SKU y haz clic en "Run" para ver el forecast.
</div>

<div id="noDataState" class="alert alert-warning d-none">
  <i class="bi bi-exclamation-triangle"></i> No se encontro historial de ventas para este SKU / filtro.
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuInput');
  const storeSelect = document.getElementById('storeSelect');
  const horizonSelect = document.getElementById('horizonSelect');
  const leadTimeSelect = document.getElementById('leadTimeSelect');
  const safetySlider = document.getElementById('safetySlider');
  const safetyLabel = document.getElementById('safetyLabel');
  const btnRun = document.getElementById('btnRunForecast');

  const kpiAvgLast4 = document.getElementById('kpiAvgLast4');
  const kpiForecastTotal = document.getElementById('kpiForecastTotal');
  const kpiStockCD = document.getElementById('kpiStockCD');
  const kpiSuggested = document.getElementById('kpiSuggested');

  const salesChartEl = document.getElementById('salesChart');
  const purchaseChartEl = document.getElementById('purchaseChart');
  const emptyState = document.getElementById('emptyState');
  const noDataState = document.getElementById('noDataState');

  safetySlider.addEventListener('input', function() {
    safetyLabel.textContent = this.value + '%';
  });

  function clearCharts() {
    Plotly.purge(salesChartEl);
    Plotly.purge(purchaseChartEl);
    salesChartEl.innerHTML = '';
    purchaseChartEl.innerHTML = '';
  }

  function resetKPIs() {
    kpiAvgLast4.textContent = '-';
    kpiForecastTotal.textContent = '-';
    kpiStockCD.textContent = '-';
    kpiSuggested.textContent = '-';
  }

  function showEmptyState() {
    emptyState.classList.remove('d-none');
    noDataState.classList.add('d-none');
  }

  function showNoDataState() {
    emptyState.classList.add('d-none');
    noDataState.classList.remove('d-none');
  }

  function hideStates() {
    emptyState.classList.add('d-none');
    noDataState.classList.add('d-none');
  }

  function runForecast() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      showEmptyState();
      clearCharts();
      resetKPIs();
      return;
    }

    hideStates();

    const params = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });

    fetch('/api/forecast_v2?' + params.toString())
      .then(res => {
        if (!res.ok) {
          if (res.status === 404) {
            showNoDataState();
            clearCharts();
            resetKPIs();
            return null;
          }
          throw new Error('API error');
        }
        return res.json();
      })
      .then(data => {
        if (!data) return;

        if (data.history.length === 0 && data.forecast.length === 0) {
          showNoDataState();
          clearCharts();
          resetKPIs();
          return;
        }

        hideStates();
        updateKPIs(data.kpis);
        renderSalesChart(data);
        renderPurchaseChart(data);
      })
      .catch(err => {
        console.error('Forecast error:', err);
        showNoDataState();
        clearCharts();
        resetKPIs();
      });
  }

  function updateKPIs(kpis) {
    kpiAvgLast4.textContent = kpis.avg_last4.toLocaleString();
    kpiForecastTotal.textContent = kpis.forecast_total.toLocaleString();
    kpiStockCD.textContent = kpis.stock_cd.toLocaleString();
    kpiSuggested.textContent = kpis.suggested_purchase.toLocaleString();
  }

  function renderSalesChart(data) {
    const historyWeeks = data.history.map(h => h.week);
    const historyUnits = data.history.map(h => h.units);
    const forecastWeeks = data.forecast.map(f => f.week);
    const forecastUnits = data.forecast.map(f => f.units);

    const traces = [];

    traces.push({
      x: historyWeeks,
      y: historyUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Historial',
      line: { color: '#0d6efd', width: 2 },
      marker: { size: 6 }
    });

    traces.push({
      x: forecastWeeks,
      y: forecastUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Forecast',
      line: { color: '#fd7e14', width: 2, dash: 'dash' },
      marker: { size: 6 }
    });

    if (data.bands && data.bands.upper && data.bands.lower) {
      traces.push({
        x: forecastWeeks.concat(forecastWeeks.slice().reverse()),
        y: data.bands.upper.concat(data.bands.lower.slice().reverse()),
        fill: 'toself',
        fillcolor: 'rgba(253, 126, 20, 0.15)',
        line: { color: 'transparent' },
        name: 'Banda confianza',
        showlegend: true,
        type: 'scatter'
      });
    }

    const layout = {
      margin: { t: 20, b: 50, l: 50, r: 20 },
      xaxis: { title: 'Semana', tickangle: -45 },
      yaxis: { title: 'Unidades' },
      legend: { orientation: 'h', y: -0.25 },
      hovermode: 'x unified'
    };

    Plotly.newPlot(salesChartEl, traces, layout, { responsive: true });
  }

  function renderPurchaseChart(data) {
    const kpis = data.kpis;
    const leadTime = parseInt(leadTimeSelect.value);
    const demandLeadTime = Math.round(kpis.avg_last4 * leadTime);

    const trace = {
      x: ['Demanda Lead Time', 'Stock CD', 'Compra Sugerida'],
      y: [demandLeadTime, kpis.stock_cd, kpis.suggested_purchase],
      type: 'bar',
      marker: {
        color: ['#17a2b8', '#28a745', '#fd7e14']
      },
      text: [demandLeadTime.toLocaleString(), kpis.stock_cd.toLocaleString(), kpis.suggested_purchase.toLocaleString()],
      textposition: 'outside'
    };

    const layout = {
      margin: { t: 30, b: 60, l: 50, r: 20 },
      yaxis: { title: 'Unidades' },
      showlegend: false,
      hovermode: 'closest'
    };

    Plotly.newPlot(purchaseChartEl, [trace], layout, { responsive: true });
  }

  btnRun.addEventListener('click', runForecast);

  skuInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      runForecast();
    }
  });

  showEmptyState();
});
</script>

{% endblock %}
