{% extends 'base.html' %}
{% block title %}Forecast Compra V2{% endblock %}
{% block page_title %}Forecast de Compra (V2){% endblock %}
{% block content %}

<div class="fcv2-container">
  <div class="fcv2-header">
    <div class="fcv2-header-left">
      <h1 class="fcv2-title">Forecast de Compra (V2)</h1>
      <p class="fcv2-subtitle">Proyección basada en ventas macro, lead time y stock de seguridad</p>
    </div>
    <div class="fcv2-header-right">
      <div class="fcv2-status-badge fcv2-status-neutral" id="statusBadge">
        <i class="bi bi-dash-circle me-1"></i><span id="statusText">—</span>
      </div>
    </div>
  </div>

  <div class="fcv2-tabs">
    <button class="fcv2-tab active" data-tab="single" id="tabSingle">
      <i class="bi bi-box me-1"></i>Forecast (SKU)
    </button>
    <button class="fcv2-tab" data-tab="batch" id="tabBatch">
      <i class="bi bi-boxes me-1"></i>Forecast Masivo
    </button>
  </div>

  <div id="singleMode">
    <div class="fcv2-params-card">
      <div class="fcv2-params-header">
        <i class="bi bi-sliders2 me-2"></i>Parámetros del Forecast
      </div>
      <div class="fcv2-params-body">
        <div class="fcv2-params-grid">
          <div class="fcv2-field fcv2-field-lg">
            <label class="fcv2-label">SKU</label>
            <input type="text" id="skuInput" class="form-control fcv2-input" list="skuList" placeholder="Buscar SKU...">
            <datalist id="skuList">
              {% for p in products %}
              <option value="{{ p.sku }}">{{ p.name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Tienda</label>
            <select id="storeSelect" class="form-select fcv2-input">
              <option value="">Todas las tiendas</option>
              {% for s in stores %}
              <option value="{{ s.name }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Horizonte (semanas)</label>
            <select id="horizonSelect" class="form-select fcv2-input">
              <option value="4">4 semanas</option>
              <option value="8" selected>8 semanas</option>
              <option value="12">12 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Lead time (semanas)</label>
            <select id="leadTimeSelect" class="form-select fcv2-input">
              <option value="2">2 semanas</option>
              <option value="4" selected>4 semanas</option>
              <option value="6">6 semanas</option>
              <option value="8">8 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Stock de seguridad: <span id="safetyLabel" class="fcv2-safety-val">10%</span></label>
            <input type="range" id="safetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
          </div>
          <div class="fcv2-field fcv2-field-btn">
            <button type="button" id="btnRunForecast" class="btn fcv2-btn-run">
              <i class="bi bi-play-fill me-1"></i>Ejecutar Forecast
            </button>
          </div>
        </div>
        <div class="fcv2-helper-strip" id="helperStrip">
          <i class="bi bi-database me-1"></i>Fuente: <strong>Ventas Macro (SalesWeeklyAgg)</strong>
        </div>
      </div>
    </div>

    <div class="fcv2-warning-banner d-none" id="warningBanner">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <span id="warningText">SKU con riesgo alto: revisar compra / liquidación</span>
    </div>

    <div class="fcv2-kpi-row fcv2-hidden" id="kpiCards">
      <div class="fcv2-kpi fcv2-kpi-blue">
        <div class="fcv2-kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiAvgLast4">—</div>
          <div class="fcv2-kpi-label">Demanda semanal</div>
          <div class="fcv2-kpi-hint">Promedio últimas 4 sem</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-cyan">
        <div class="fcv2-kpi-icon"><i class="bi bi-calendar-week"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiForecastTotal">—</div>
          <div class="fcv2-kpi-label">Demanda horizonte</div>
          <div class="fcv2-kpi-hint">Unidades proyectadas</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-green">
        <div class="fcv2-kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiStockCD">—</div>
          <div class="fcv2-kpi-label">Stock total</div>
          <div class="fcv2-kpi-hint">CD + Tiendas</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-amber">
        <div class="fcv2-kpi-icon"><i class="bi bi-cart-plus-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="kpiSuggested">—</div>
          <div class="fcv2-kpi-label">Compra sugerida</div>
          <div class="fcv2-kpi-hint" id="purchaseHint">—</div>
        </div>
      </div>
    </div>

    <div class="fcv2-charts-row fcv2-hidden" id="chartsRow">
      <div class="fcv2-chart-card fcv2-chart-main">
        <div class="fcv2-chart-header">
          <i class="bi bi-activity me-2"></i>Historial + Forecast
        </div>
        <div class="fcv2-chart-body">
          <div id="salesChart" class="fcv2-chart-canvas"></div>
        </div>
      </div>
      <div class="fcv2-chart-card fcv2-chart-side">
        <div class="fcv2-chart-header">
          <i class="bi bi-bar-chart-fill me-2"></i>Demanda vs Stock vs Compra
        </div>
        <div class="fcv2-chart-body">
          <div id="purchaseChart" class="fcv2-chart-canvas"></div>
        </div>
      </div>
    </div>

    <div class="fcv2-explain-card fcv2-hidden" id="explainCard">
      <div class="fcv2-explain-header">
        <i class="bi bi-lightbulb-fill me-2"></i>¿Por qué esta recomendación?
      </div>
      <div class="fcv2-explain-body" id="explainBody">
        <ul class="fcv2-explain-list" id="explainList"></ul>
      </div>
    </div>

    <div class="fcv2-actions-bar fcv2-hidden" id="actionsBar">
      <a href="#" class="btn fcv2-btn-outline" id="btnExport">
        <i class="bi bi-file-earmark-excel me-1"></i>Exportar Forecast
      </a>
      <a href="/alerts" class="btn fcv2-btn-outline" id="btnAlerts">
        <i class="bi bi-bell me-1"></i>Ver en Alertas
      </a>
      <a href="/slow_stock" class="btn fcv2-btn-outline" id="btnSlowStock">
        <i class="bi bi-clock-history me-1"></i>Ver Stock Lento
      </a>
      <a href="/rebalancing" class="btn fcv2-btn-warning d-none" id="btnRebalance">
        <i class="bi bi-arrow-left-right me-1"></i>Redistribuir SKU
      </a>
    </div>

    <div id="emptyState" class="fcv2-empty-state">
      <div class="fcv2-empty-icon">
        <i class="bi bi-search"></i>
      </div>
      <div class="fcv2-empty-title">Selecciona un SKU para calcular forecast</div>
      <div class="fcv2-empty-hint">Ingresa un SKU y haz clic en "Ejecutar" para ver proyecciones</div>
    </div>

    <div id="noDataState" class="fcv2-empty-state fcv2-empty-warning d-none">
      <div class="fcv2-empty-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <div class="fcv2-empty-title">Sin historial de ventas</div>
      <div class="fcv2-empty-hint">No se encontró historial de ventas para este SKU / filtro</div>
    </div>
  </div>

  <div id="batchMode" class="d-none">
    <div class="fcv2-params-card">
      <div class="fcv2-params-header">
        <i class="bi bi-boxes me-2"></i>Forecast Masivo
      </div>
      <div class="fcv2-params-body">
        <div class="fcv2-batch-intro">
          <p>Carga un archivo CSV/XLSX con una columna <strong>SKU</strong> o pega SKUs directamente.</p>
        </div>
        <div class="fcv2-batch-grid">
          <div class="fcv2-field">
            <label class="fcv2-label">Archivo (CSV/XLSX)</label>
            <input type="file" id="batchFile" class="form-control fcv2-input" accept=".csv,.xlsx,.xls">
          </div>
          <div class="fcv2-field fcv2-field-lg">
            <label class="fcv2-label">O pegar SKUs (uno por línea)</label>
            <textarea id="batchSkuText" class="form-control fcv2-input" rows="3" placeholder="SKU001&#10;SKU002&#10;SKU003"></textarea>
          </div>
        </div>
        <div class="fcv2-params-grid mt-3">
          <div class="fcv2-field">
            <label class="fcv2-label">Horizonte (semanas)</label>
            <select id="batchHorizon" class="form-select fcv2-input">
              <option value="4">4 semanas</option>
              <option value="8" selected>8 semanas</option>
              <option value="12">12 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Lead time (semanas)</label>
            <select id="batchLeadTime" class="form-select fcv2-input">
              <option value="2">2 semanas</option>
              <option value="4" selected>4 semanas</option>
              <option value="6">6 semanas</option>
              <option value="8">8 semanas</option>
            </select>
          </div>
          <div class="fcv2-field">
            <label class="fcv2-label">Safety %: <span id="batchSafetyLabel">10%</span></label>
            <input type="range" id="batchSafetySlider" class="form-range fcv2-slider" min="0" max="30" value="10" step="1">
          </div>
          <div class="fcv2-field fcv2-field-btn">
            <button type="button" id="btnRunBatch" class="btn fcv2-btn-run">
              <i class="bi bi-play-fill me-1"></i>Generar Batch Forecast
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="fcv2-kpi-row fcv2-hidden" id="batchKpiCards">
      <div class="fcv2-kpi fcv2-kpi-blue">
        <div class="fcv2-kpi-icon"><i class="bi bi-boxes"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiTotal">—</div>
          <div class="fcv2-kpi-label">SKUs Procesados</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-red">
        <div class="fcv2-kpi-icon"><i class="bi bi-cart-check-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiBuyNow">—</div>
          <div class="fcv2-kpi-label">Comprar Ahora</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-amber">
        <div class="fcv2-kpi-icon"><i class="bi bi-exclamation-circle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiReview">—</div>
          <div class="fcv2-kpi-label">Revisar</div>
        </div>
      </div>
      <div class="fcv2-kpi fcv2-kpi-green">
        <div class="fcv2-kpi-icon"><i class="bi bi-x-circle-fill"></i></div>
        <div class="fcv2-kpi-body">
          <div class="fcv2-kpi-value" id="batchKpiDoNotBuy">—</div>
          <div class="fcv2-kpi-label">No Comprar</div>
        </div>
      </div>
    </div>

    <div class="fcv2-results-card fcv2-hidden" id="batchResultsCard">
      <div class="fcv2-results-header">
        <span><i class="bi bi-table me-2"></i>Resultados del Batch</span>
        <a href="#" class="btn fcv2-btn-outline-sm" id="btnBatchExport">
          <i class="bi bi-download me-1"></i>Exportar
        </a>
      </div>
      <div class="fcv2-results-body">
        <table class="fcv2-table" id="batchTable">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Ciclo</th>
              <th>Dem. Sem.</th>
              <th>Stock</th>
              <th>Compra Sug.</th>
              <th>Decisión</th>
              <th>Razón</th>
            </tr>
          </thead>
          <tbody id="batchTableBody"></tbody>
        </table>
        <div class="fcv2-pagination" id="batchPagination"></div>
      </div>
    </div>

    <div id="batchEmptyState" class="fcv2-empty-state">
      <div class="fcv2-empty-icon">
        <i class="bi bi-file-earmark-arrow-up"></i>
      </div>
      <div class="fcv2-empty-title">Carga SKUs para generar forecast masivo</div>
      <div class="fcv2-empty-hint">Sube un archivo o pega los SKUs en el campo de texto</div>
    </div>
  </div>
</div>

<div class="modal fade" id="explainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header fcv2-modal-header">
        <h5 class="modal-title"><i class="bi bi-lightbulb me-2"></i>Detalle de Recomendación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <div class="fcv2-modal-sku" id="modalSku"></div>
        <div class="fcv2-modal-product" id="modalProduct"></div>
        <ul class="fcv2-explain-list" id="modalExplainList"></ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="brokenStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Quiebres detectados en tiendas</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <p>Este SKU tiene tiendas quebradas con demanda reciente. Se recomienda redistribuir antes de comprar.</p>
        <p class="text-muted small">Puedes generar redistribución desde este panel para balancear el stock antes de realizar una nueva compra.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="#" class="btn btn-warning" id="brokenStockModalBtn">
          <i class="bi bi-arrow-left-right me-1"></i>Generar redistribución
        </a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="batchBrokenStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content fcv2-modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>SKUs con quiebres detectados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body fcv2-modal-body">
        <p>Se detectaron <strong id="batchBrokenCount">0</strong> SKUs con tiendas quebradas y demanda reciente.</p>
        <p class="text-muted small">Recomendación: revisar redistribución antes de compra.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-warning" id="filterBrokenBtn">
          <i class="bi bi-funnel me-1"></i>Ver solo SKUs con quiebre
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuInput');
  const storeSelect = document.getElementById('storeSelect');
  const horizonSelect = document.getElementById('horizonSelect');
  const leadTimeSelect = document.getElementById('leadTimeSelect');
  const safetySlider = document.getElementById('safetySlider');
  const safetyLabel = document.getElementById('safetyLabel');
  const btnRun = document.getElementById('btnRunForecast');

  const kpiAvgLast4 = document.getElementById('kpiAvgLast4');
  const kpiForecastTotal = document.getElementById('kpiForecastTotal');
  const kpiStockCD = document.getElementById('kpiStockCD');
  const kpiSuggested = document.getElementById('kpiSuggested');
  const purchaseHint = document.getElementById('purchaseHint');

  const salesChartEl = document.getElementById('salesChart');
  const purchaseChartEl = document.getElementById('purchaseChart');
  const emptyState = document.getElementById('emptyState');
  const noDataState = document.getElementById('noDataState');
  const kpiCards = document.getElementById('kpiCards');
  const chartsRow = document.getElementById('chartsRow');
  const explainCard = document.getElementById('explainCard');
  const actionsBar = document.getElementById('actionsBar');
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  const warningBanner = document.getElementById('warningBanner');
  const warningText = document.getElementById('warningText');
  const explainList = document.getElementById('explainList');

  const tabSingle = document.getElementById('tabSingle');
  const tabBatch = document.getElementById('tabBatch');
  const singleMode = document.getElementById('singleMode');
  const batchMode = document.getElementById('batchMode');

  let currentSku = '';
  let currentBatchId = '';

  tabSingle.addEventListener('click', () => switchTab('single'));
  tabBatch.addEventListener('click', () => switchTab('batch'));

  function switchTab(tab) {
    if (tab === 'single') {
      tabSingle.classList.add('active');
      tabBatch.classList.remove('active');
      singleMode.classList.remove('d-none');
      batchMode.classList.add('d-none');
    } else {
      tabSingle.classList.remove('active');
      tabBatch.classList.add('active');
      singleMode.classList.add('d-none');
      batchMode.classList.remove('d-none');
    }
  }

  safetySlider.addEventListener('input', function() {
    safetyLabel.textContent = this.value + '%';
  });

  function clearCharts() {
    Plotly.purge(salesChartEl);
    Plotly.purge(purchaseChartEl);
    salesChartEl.innerHTML = '';
    purchaseChartEl.innerHTML = '';
  }

  function resetKPIs() {
    kpiAvgLast4.textContent = '—';
    kpiForecastTotal.textContent = '—';
    kpiStockCD.textContent = '—';
    kpiSuggested.textContent = '—';
    purchaseHint.textContent = '—';
  }

  function updateStatus(type, text) {
    statusBadge.className = 'fcv2-status-badge fcv2-status-' + type;
    const icons = {
      'buy': 'bi-cart-check-fill',
      'review': 'bi-exclamation-circle-fill',
      'nobuy': 'bi-check-circle-fill',
      'neutral': 'bi-dash-circle'
    };
    statusBadge.querySelector('i').className = 'bi ' + (icons[type] || icons.neutral) + ' me-1';
    statusText.textContent = text;
  }

  function showEmptyState() {
    emptyState.classList.remove('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function showNoDataState() {
    emptyState.classList.add('d-none');
    noDataState.classList.remove('d-none');
    kpiCards.classList.add('fcv2-hidden');
    chartsRow.classList.add('fcv2-hidden');
    explainCard.classList.add('fcv2-hidden');
    actionsBar.classList.add('fcv2-hidden');
    warningBanner.classList.add('d-none');
    updateStatus('neutral', '—');
  }

  function hideStates() {
    emptyState.classList.add('d-none');
    noDataState.classList.add('d-none');
    kpiCards.classList.remove('fcv2-hidden');
    chartsRow.classList.remove('fcv2-hidden');
    explainCard.classList.remove('fcv2-hidden');
    actionsBar.classList.remove('fcv2-hidden');
  }

  function runForecast() {
    const sku = String(skuInput.value).trim();
    if (!sku) {
      showEmptyState();
      clearCharts();
      resetKPIs();
      return;
    }
    currentSku = sku;

    hideStates();
    btnRun.disabled = true;
    btnRun.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Calculando...';

    const params = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });

    fetch('/api/forecast_v2?' + params.toString())
      .then(res => {
        if (!res.ok) {
          if (res.status === 404) {
            showNoDataState();
            clearCharts();
            resetKPIs();
            return null;
          }
          throw new Error('API error');
        }
        return res.json();
      })
      .then(data => {
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';

        if (!data) return;

        if (data.history.length === 0 && data.forecast.length === 0) {
          showNoDataState();
          clearCharts();
          resetKPIs();
          return;
        }

        hideStates();
        updateKPIs(data.kpis, data);
        renderSalesChart(data);
        renderPurchaseChart(data);
        updateExplainability(data);
        updateWarnings(data);
        updateActionButtons(sku, data);
        
        checkBrokenStockPopup(data);
      })
      .catch(err => {
        console.error('Forecast error:', err);
        showNoDataState();
        clearCharts();
        resetKPIs();
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="bi bi-play-fill me-1"></i>Ejecutar Forecast';
      });
  }

  function updateKPIs(kpis, data) {
    kpiAvgLast4.textContent = kpis.avg_last4.toLocaleString();
    kpiForecastTotal.textContent = kpis.forecast_total.toLocaleString();
    kpiStockCD.textContent = kpis.stock_cd.toLocaleString();
    kpiSuggested.textContent = kpis.suggested_purchase.toLocaleString();
    
    const decision = data.decision || 'REVIEW';
    
    if (decision === 'BUY_NOW') {
      purchaseHint.textContent = 'Comprar ahora';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-urgent';
      updateStatus('buy', 'Comprar ahora');
    } else if (decision === 'REVIEW') {
      purchaseHint.textContent = 'Revisar compra';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-review';
      updateStatus('review', 'Revisar');
    } else {
      purchaseHint.textContent = 'No comprar';
      purchaseHint.className = 'fcv2-kpi-hint fcv2-hint-ok';
      updateStatus('nobuy', 'No comprar');
    }
  }

  function updateExplainability(data) {
    const bullets = data.explain_bullets || [];
    if (bullets.length > 0) {
      explainList.innerHTML = bullets.map(b => '<li>' + b + '</li>').join('');
    } else {
      explainList.innerHTML = '<li class="fcv2-explain-empty"><i class="bi bi-info-circle me-2"></i>Sin información adicional</li>';
    }
  }

  function updateWarnings(data) {
    const lifecycle = data.lifecycle_status || '';
    const reasonCode = data.reason_code || '';
    
    if (lifecycle === 'DEAD' || lifecycle === 'SLOW' || reasonCode.includes('SLOW_STOCK')) {
      warningBanner.classList.remove('d-none');
      if (lifecycle === 'DEAD') {
        warningText.textContent = 'SKU muerto: considerar liquidación antes de nueva compra';
      } else if (reasonCode.includes('SLOW_STOCK')) {
        warningText.textContent = 'SKU con stock lento flaggeado: revisar antes de comprar';
      } else {
        warningText.textContent = 'SKU con riesgo alto: revisar compra / liquidación';
      }
    } else {
      warningBanner.classList.add('d-none');
    }
  }

  function updateActionButtons(sku, data) {
    const encodedSku = encodeURIComponent(sku);
    const exportParams = new URLSearchParams({
      sku: sku,
      store: storeSelect.value,
      horizon_weeks: horizonSelect.value,
      lead_time_weeks: leadTimeSelect.value,
      safety_pct: (parseInt(safetySlider.value) / 100).toFixed(2)
    });
    
    document.getElementById('btnExport').href = '/forecast/export?' + exportParams.toString();
    document.getElementById('btnAlerts').href = '/alerts?sku=' + encodedSku;
    document.getElementById('btnSlowStock').href = '/slow_stock?sku_search=' + encodedSku;
    
    const btnRebalance = document.getElementById('btnRebalance');
    const brokenStockFlag = data && data.broken_stock_flag;
    const reasonCode = data && data.reason_code || '';
    
    if (brokenStockFlag || reasonCode.includes('BROKEN_STOCK')) {
      btnRebalance.classList.remove('d-none');
      btnRebalance.href = '/rebalancing?sku=' + encodedSku;
    } else {
      btnRebalance.classList.add('d-none');
    }
  }

  function checkBrokenStockPopup(data) {
    const brokenStockFlag = data && data.broken_stock_flag;
    const reasonCode = data && data.reason_code || '';
    const decision = data && data.decision || '';
    
    if ((brokenStockFlag || reasonCode.includes('BROKEN_STOCK') || reasonCode.includes('BROKEN_STOCK_REBALANCE')) && decision === 'REVIEW') {
      const encodedSku = encodeURIComponent(data.sku);
      document.getElementById('brokenStockModalBtn').href = '/rebalancing?sku=' + encodedSku;
      const modal = new bootstrap.Modal(document.getElementById('brokenStockModal'));
      modal.show();
    }
  }

  let allBatchResults = [];
  let showOnlyBroken = false;

  function checkBatchBrokenStockPopup(results, brokenCount) {
    if (brokenCount > 0) {
      document.getElementById('batchBrokenCount').textContent = brokenCount;
      const modal = new bootstrap.Modal(document.getElementById('batchBrokenStockModal'));
      modal.show();
    }
  }

  document.getElementById('filterBrokenBtn').addEventListener('click', function() {
    showOnlyBroken = !showOnlyBroken;
    const filteredResults = showOnlyBroken ? allBatchResults.filter(r => r.broken_stock_flag) : allBatchResults;
    renderBatchTable(filteredResults);
    bootstrap.Modal.getInstance(document.getElementById('batchBrokenStockModal')).hide();
    this.innerHTML = showOnlyBroken ? '<i class="bi bi-list me-1"></i>Ver todos' : '<i class="bi bi-funnel me-1"></i>Ver solo SKUs con quiebre';
  });

  function renderSalesChart(data) {
    const historyWeeks = data.history.map(h => h.week);
    const historyUnits = data.history.map(h => h.units);
    const forecastWeeks = data.forecast.map(f => f.week);
    const forecastUnits = data.forecast.map(f => f.units);

    const traces = [];
    traces.push({
      x: historyWeeks,
      y: historyUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Histórico',
      line: { color: '#3b82f6', width: 2.5 },
      marker: { size: 7, color: '#3b82f6' }
    });
    traces.push({
      x: forecastWeeks,
      y: forecastUnits,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Forecast',
      line: { color: '#f59e0b', width: 2.5, dash: 'dash' },
      marker: { size: 7, color: '#f59e0b' }
    });

    if (data.bands && data.bands.upper && data.bands.lower) {
      traces.push({
        x: forecastWeeks.concat(forecastWeeks.slice().reverse()),
        y: data.bands.upper.concat(data.bands.lower.slice().reverse()),
        fill: 'toself',
        fillcolor: 'rgba(245, 158, 11, 0.1)',
        line: { color: 'transparent' },
        name: 'Banda de confianza',
        showlegend: true,
        type: 'scatter'
      });
    }

    const layout = {
      margin: { t: 20, b: 50, l: 55, r: 20 },
      xaxis: { title: 'Semana', tickangle: -45, gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      legend: { orientation: 'h', y: -0.28, x: 0.5, xanchor: 'center' },
      hovermode: 'x unified',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 }
    };

    Plotly.newPlot(salesChartEl, traces, layout, { responsive: true, displayModeBar: false });
  }

  function renderPurchaseChart(data) {
    const kpis = data.kpis;
    const leadTime = parseInt(leadTimeSelect.value);
    const demandLeadTime = Math.round(kpis.avg_last4 * leadTime);

    const trace = {
      x: ['Demanda Lead Time', 'Stock Total', 'Compra Sugerida'],
      y: [demandLeadTime, kpis.stock_cd, kpis.suggested_purchase],
      type: 'bar',
      marker: { color: ['#06b6d4', '#22c55e', '#f59e0b'], line: { width: 0 } },
      text: [demandLeadTime.toLocaleString(), kpis.stock_cd.toLocaleString(), kpis.suggested_purchase.toLocaleString()],
      textposition: 'outside',
      textfont: { size: 13, weight: 600 }
    };

    const layout = {
      margin: { t: 30, b: 80, l: 55, r: 20 },
      yaxis: { title: 'Unidades', gridcolor: '#e2e8f0', linecolor: '#e2e8f0' },
      xaxis: { tickangle: -15, linecolor: '#e2e8f0' },
      showlegend: false,
      hovermode: 'closest',
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { family: 'Inter, system-ui, sans-serif', size: 12 },
      bargap: 0.4
    };

    Plotly.newPlot(purchaseChartEl, [trace], layout, { responsive: true, displayModeBar: false });
  }

  btnRun.addEventListener('click', runForecast);
  skuInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') runForecast();
  });

  const batchSafetySlider = document.getElementById('batchSafetySlider');
  const batchSafetyLabel = document.getElementById('batchSafetyLabel');
  const btnRunBatch = document.getElementById('btnRunBatch');
  const batchKpiCards = document.getElementById('batchKpiCards');
  const batchResultsCard = document.getElementById('batchResultsCard');
  const batchEmptyState = document.getElementById('batchEmptyState');
  const batchTableBody = document.getElementById('batchTableBody');
  const batchPagination = document.getElementById('batchPagination');

  batchSafetySlider.addEventListener('input', function() {
    batchSafetyLabel.textContent = this.value + '%';
  });

  btnRunBatch.addEventListener('click', runBatchForecast);

  function runBatchForecast() {
    const formData = new FormData();
    const fileInput = document.getElementById('batchFile');
    const skuText = document.getElementById('batchSkuText').value.trim();
    
    if (fileInput.files.length > 0) {
      formData.append('file', fileInput.files[0]);
    } else if (skuText) {
      formData.append('sku_list', skuText);
    } else {
      alert('Por favor carga un archivo o ingresa SKUs');
      return;
    }
    
    formData.append('horizon_weeks', document.getElementById('batchHorizon').value);
    formData.append('lead_time_weeks', document.getElementById('batchLeadTime').value);
    formData.append('safety_pct', (parseInt(batchSafetySlider.value) / 100).toFixed(2));

    btnRunBatch.disabled = true;
    btnRunBatch.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando...';

    fetch('/api/forecast/batch', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      btnRunBatch.disabled = false;
      btnRunBatch.innerHTML = '<i class="bi bi-play-fill me-1"></i>Generar Batch Forecast';

      if (data.error) {
        alert(data.error);
        return;
      }

      currentBatchId = data.batch_id;
      batchEmptyState.classList.add('d-none');
      batchKpiCards.classList.remove('fcv2-hidden');
      batchResultsCard.classList.remove('fcv2-hidden');

      document.getElementById('batchKpiTotal').textContent = data.total_skus;
      document.getElementById('batchKpiBuyNow').textContent = data.buy_now_count;
      document.getElementById('batchKpiReview').textContent = data.review_count;
      document.getElementById('batchKpiDoNotBuy').textContent = data.do_not_buy_count;

      document.getElementById('btnBatchExport').href = '/forecast/batch/export/' + data.batch_id;

      allBatchResults = data.results;
      showOnlyBroken = false;

      if (data.total_skus > 10) {
        loadBatchPage(data.batch_id, 1);
      } else {
        renderBatchTable(data.results);
        batchPagination.innerHTML = '';
      }

      const brokenCount = data.broken_stock_count || 0;
      if (brokenCount > 0) {
        checkBatchBrokenStockPopup(data.results, brokenCount);
      }
    })
    .catch(err => {
      console.error('Batch error:', err);
      btnRunBatch.disabled = false;
      btnRunBatch.innerHTML = '<i class="bi bi-play-fill me-1"></i>Generar Batch Forecast';
      alert('Error al procesar batch');
    });
  }

  function renderBatchTable(results) {
    batchTableBody.innerHTML = '';
    results.forEach(r => {
      const decisionClass = r.decision === 'BUY_NOW' ? 'fcv2-badge-buy' : 
                            r.decision === 'REVIEW' ? 'fcv2-badge-review' : 'fcv2-badge-nobuy';
      const decisionLabel = r.decision === 'BUY_NOW' ? 'Comprar' : 
                            r.decision === 'REVIEW' ? 'Revisar' : 'No Comprar';
      
      const brokenBadge = r.broken_stock_flag ? 
        '<span class="badge bg-warning text-dark ms-1" title="Tiendas con quiebre"><i class="bi bi-exclamation-triangle-fill"></i></span>' : '';
      
      const redistributeLink = r.broken_stock_flag ? 
        '<a href="/rebalancing?sku=' + encodeURIComponent(r.sku) + '" class="btn btn-sm btn-outline-warning ms-1" title="Redistribuir" onclick="event.stopPropagation();"><i class="bi bi-arrow-left-right"></i></a>' : '';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><code>${r.sku}</code>${brokenBadge}</td>
        <td>${r.product_name}</td>
        <td>${r.category}</td>
        <td><span class="fcv2-lifecycle-badge">${r.lifecycle_status}</span></td>
        <td>${r.weekly_demand.toLocaleString()}</td>
        <td>${r.total_stock.toLocaleString()}</td>
        <td><strong>${r.suggested_purchase.toLocaleString()}</strong></td>
        <td><span class="fcv2-decision-badge ${decisionClass}">${decisionLabel}</span></td>
        <td><span class="fcv2-reason-text">${r.reason_summary}</span>${redistributeLink}</td>
      `;
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => showExplainModal(r));
      batchTableBody.appendChild(row);
    });
  }

  function showExplainModal(item) {
    document.getElementById('modalSku').textContent = 'SKU: ' + item.sku;
    document.getElementById('modalProduct').textContent = item.product_name;
    const bullets = item.explain_bullets || [];
    document.getElementById('modalExplainList').innerHTML = bullets.map(b => '<li>' + b + '</li>').join('');
    
    const modal = new bootstrap.Modal(document.getElementById('explainModal'));
    modal.show();
  }

  function loadBatchPage(batchId, page) {
    fetch('/api/forecast/batch/' + batchId + '?page=' + page)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          console.error(data.error);
          return;
        }
        renderBatchTable(data.results);
        renderPagination(batchId, data.page, data.total_pages);
      })
      .catch(err => console.error('Pagination error:', err));
  }

  function renderPagination(batchId, currentPage, totalPages) {
    if (totalPages <= 1) {
      batchPagination.innerHTML = '';
      return;
    }
    let html = '';
    
    if (currentPage > 1) {
      html += '<button class="fcv2-page-btn" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + (currentPage-1) + ')">&laquo;</button>';
    }
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
      const active = i === currentPage ? ' active' : '';
      html += '<button class="fcv2-page-btn' + active + '" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + i + ')">' + i + '</button>';
    }
    
    if (currentPage < totalPages) {
      html += '<button class="fcv2-page-btn" onclick="loadBatchPageGlobal(\'' + batchId + '\',' + (currentPage+1) + ')">&raquo;</button>';
    }
    
    batchPagination.innerHTML = html;
  }

  window.loadBatchPageGlobal = function(batchId, page) {
    loadBatchPage(batchId, page);
  };

  showEmptyState();
});
</script>

{% endblock %}