{% extends 'base.html' %}
{% block content %}

<div class="query-wrap">
  <div class="query-header">
    <h1 class="query-title">Generador de distribución</h1>
    <p class="query-subtitle">Sube un archivo de SKUs objetivo y selecciona el modelo para generar distribución sugerida.</p>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="query-card">
        <form method="post" enctype="multipart/form-data"
              data-loader="true"
              data-ajax="true"
              data-loader-title="Generando Distribución"
              data-loader-msg="Procesando solicitud y calculando distribución sugerida..."
              data-loader-icon="truck">

          {% if require_stock_confirm %}
          <div class="upload-alert-wrap">
            <div class="alert alert-warning mb-2">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Atención:</strong>
              No se detecta stock de tienda cargado previamente.
              Si el producto es nuevo o deseas continuar sin stock, marca la casilla para confirmar.
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="confirm_no_stock" name="confirm_no_stock">
              <label class="form-check-label" for="confirm_no_stock">
                No hay registro de stock de tienda previo, quiero continuar igualmente.
              </label>
            </div>
          </div>
          {% endif %}

          <div class="upload-row">
            <div class="upload-field upload-field-half">
              <label class="query-label">Archivo de solicitud de distribución</label>
              <input type="file" class="form-control" name="file"
                     accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
                     required>
              <small class="text-muted">Acepta <code>.csv</code> y <code>.xlsx</code> con lista de SKUs</small>
            </div>

            <div class="upload-field upload-field-half">
              <label class="query-label">Modo de análisis</label>
              <select class="form-select" name="analysis_mode">
                <option value="sma3_min3">Promedio 3 semanas (requiere 3, ajustado por stock)</option>
                <option value="sma2_min2">Promedio 2 semanas (requiere 2, ajustado por stock)</option>
                <option value="sma1_no_min">Última semana (mínimo 1 semana, ajustado por stock)</option>
                <option value="sma3_ignore_stock">Promedio 3 semanas (ignorar stock de tienda)</option>
              </select>
            </div>
          </div>

          <hr class="upload-divider">

          <div class="upload-row upload-row-4">
            <div class="upload-field">
              <label class="query-label">N° de folio</label>
              <input type="text" class="form-control form-control-sm" name="folio" placeholder="Documento asignado">
            </div>

            <div class="upload-field">
              <label class="query-label">Responsable</label>
              <input type="text" class="form-control form-control-sm" name="responsable" placeholder="Nombre">
            </div>

            <div class="upload-field">
              <label class="query-label">Categoría / campaña</label>
              <input type="text" class="form-control form-control-sm" name="categoria" placeholder="Ej: Navidad">
            </div>

            <div class="upload-field">
              <label class="query-label">Fecha documento</label>
              <input type="date" class="form-control form-control-sm" name="fecha_doc">
            </div>
          </div>

          {% if current_user.role == 'Admin' %}
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="include_held" name="include_held" value="1">
            <label class="form-check-label text-muted" for="include_held">
              <i class="bi bi-unlock me-1"></i>Incluir SKUs en HOLD (solo admin)
            </label>
          </div>
          {% endif %}

          <div class="upload-actions d-flex gap-2 flex-wrap align-items-center">
            <button type="submit" class="btn btn-primary query-btn">
              <i class="bi bi-arrow-up-circle me-2"></i>Generar distribución sugerida
            </button>
            {% if ai_enabled %}
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnAiPrefill" onclick="aiPrefillParams()" title="Prellenar parámetros con sugerencia AI">
              <i class="bi bi-stars me-1"></i>Usar parámetros AI
            </button>
            {% else %}
            <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="AI está deshabilitado">
              <i class="bi bi-stars me-1"></i>AI deshabilitado
            </button>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="upload-collapse-wrap">
        <button class="btn btn-link upload-collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#fileReqCollapse">
          <i class="bi bi-info-circle me-1"></i>Requisitos del archivo
        </button>
        <div class="collapse" id="fileReqCollapse">
          <div class="upload-collapse-body">
            <p class="mb-2"><strong>Formato de solicitud de distribución:</strong></p>
            <ul class="upload-req-list">
              <li><code>sku</code> — Código del producto <strong>(requerido)</strong></li>
              <li><code>product_name</code> — Nombre del producto (opcional)</li>
              <li><code>category</code> — Categoría del producto (opcional, habilita cold start para SKUs nuevos)</li>
            </ul>
            <p class="mb-1"><strong>Formatos aceptados:</strong> <code>.csv</code>, <code>.xlsx</code></p>
            <p class="text-muted mb-0">El SKU debe ser texto para preservar ceros a la izquierda.</p>
            <div class="alert alert-info mt-3 mb-0 py-2">
              <i class="bi bi-info-circle me-1"></i>
              <strong>Nota:</strong> Este módulo no ingesta ventas. Para cargar historial de ventas, usa "Ventas macro".
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      {% if pending_skus and pending_skus|length > 0 %}
      <div class="upload-sidecard border-warning">
        <div class="upload-sidecard-title text-warning"><i class="bi bi-box-arrow-right me-2"></i>SKUs listos para generar</div>
        <p class="small text-muted mb-2">{{ pending_skus|length }} SKU(s) cargados. Modelo: <strong>{{ pending_mode or 'sma3_min3' }}</strong></p>
        {% if pending_meta and pending_meta.get('folio') %}
        <p class="small text-muted mb-2">Folio: {{ pending_meta.get('folio') }}</p>
        {% endif %}
        <form method="POST" action="{{ url_for('generate_from_pending') }}" id="pendingGenForm">
          <button type="submit" class="btn btn-warning btn-sm w-100 fw-bold" id="btnGeneratePending">
            <i class="bi bi-play-fill me-1"></i>Generar distribución ahora ({{ pending_skus|length }} SKUs)
          </button>
        </form>
        <p class="small text-muted mt-2 mb-0">SKUs nuevos sin historial usarán cold start por categoría.</p>
      </div>
      {% endif %}

      <div class="upload-sidecard">
        <div class="upload-sidecard-title"><i class="bi bi-list-check me-2"></i>Guía rápida</div>
        <ol class="upload-guide-list">
          <li>Sube archivo con lista de SKUs</li>
          <li>Selecciona modelo de análisis</li>
          <li>Completa folio, responsable y campaña</li>
          <li>Genera distribución sugerida</li>
          <li>Exporta resultados desde Dashboard</li>
        </ol>
      </div>

      <div class="upload-sidecard">
        <div class="upload-sidecard-title"><i class="bi bi-table me-2"></i>Ejemplo de archivo</div>
        <div class="upload-example-table-wrap">
          <table class="upload-example-table">
            <thead>
              <tr>
                <th>sku</th>
                <th>product_name</th>
                <th>category</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>000123</td>
                <td>Producto A</td>
                <td>Navidad</td>
              </tr>
              <tr>
                <td>000456</td>
                <td>Producto B</td>
                <td>Navidad</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="small text-muted mt-2 mb-0">Solo <code>sku</code> es requerido</p>
      </div>

      <div class="upload-sidecard">
        <div class="upload-sidecard-title"><i class="bi bi-lightbulb me-2"></i>Tips</div>
        <ul class="upload-tips-list">
          <li>Carga primero Stock CD, Stock Tiendas y Ventas macro</li>
          <li>Evita cargas duplicadas salvo que sea necesario</li>
          <li>Usa Categoría/campaña para trazabilidad</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1090;">
  <div id="aiToast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="aiToastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
<script>
function showAiToast(msg, type) {
  var t = document.getElementById('aiToast');
  var b = document.getElementById('aiToastBody');
  t.className = 'toast align-items-center border-0 text-bg-' + (type || 'info');
  b.innerHTML = msg;
  var toast = new bootstrap.Toast(t, {delay: 6000});
  toast.show();
}
function aiPrefillParams() {
  var btn = document.getElementById('btnAiPrefill');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cargando...';
  fetch('/ai/run/latest_params')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-stars me-1"></i>Usar parámetros AI';
      if (!d.found) {
        showAiToast('<i class="bi bi-info-circle me-1"></i>No hay parámetros AI disponibles. Abra el detalle de una corrida y genere el análisis AI.', 'warning');
        return;
      }
      var p = d.suggested_params;
      if (p.analysis_mode_suggestion) {
        var sel = document.querySelector('select[name="analysis_mode"]');
        if (sel) {
          for (var i = 0; i < sel.options.length; i++) {
            if (sel.options[i].value === p.analysis_mode_suggestion) {
              sel.selectedIndex = i;
              break;
            }
          }
        }
      }
      var details = [];
      if (p.horizon_weeks) details.push('Horizonte: ' + p.horizon_weeks + ' sem');
      if (p.target_woc) details.push('WOC objetivo: ' + p.target_woc);
      if (p.min_fill_units) details.push('Min fill: ' + p.min_fill_units);
      if (p.topN_new_sku) details.push('Top N nuevos: ' + p.topN_new_sku);
      if (p.caps) {
        if (p.caps.max_units_per_row) details.push('Max/fila: ' + p.caps.max_units_per_row);
        if (p.caps.max_total_units) details.push('Max total: ' + p.caps.max_total_units);
      }
      var msg = '<strong><i class="bi bi-stars me-1"></i>Parámetros AI aplicados</strong> (corrida ' + (d.run_id || '').substring(0, 8) + '...)';
      if (details.length) msg += '<br><small>' + details.join(' · ') + '</small>';
      if (p.notes) msg += '<br><small class="text-white-50">' + p.notes + '</small>';
      showAiToast(msg, 'success');
    })
    .catch(function() {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-stars me-1"></i>Usar parámetros AI';
      showAiToast('<i class="bi bi-exclamation-triangle me-1"></i>Error al cargar parámetros AI.', 'danger');
    });
}
</script>
{% endblock %}
