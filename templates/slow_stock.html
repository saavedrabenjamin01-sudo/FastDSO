{% extends "base.html" %}

{% block title %}Stock Lento & Reasignación{% endblock %}
{% block page_title %}Stock Lento & Reasignación Inteligente{% endblock %}

{# Pagination controls macro (matches Dashboard style, no size dropdown) #}
{% macro pagination_controls(pag, page_param) %}
<div class="slow-pagination">
  <small class="text-muted">{{ pag.total }} registros</small>
  {% if pag.pages > 1 %}
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if not pag.has_prev %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.prev_num or 1 }})">Ant</a>
        </li>
        {% for p in pag.iter_pages() %}
          {% if p %}
            <li class="page-item {% if p == pag.page %}active{% endif %}">
              <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ p }})">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pag.has_next %}disabled{% endif %}">
          <a class="page-link" href="javascript:void(0)" onclick="updateParam('{{ page_param }}', {{ pag.next_num or pag.pages }})">Sig</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endmacro %}

{# Status badge macro #}
{% macro status_badge(status) %}
{% if status == 'DEAD_STORE' or status == 'DEAD' or status == 'DEAD_CD' %}
<span class="slow-badge slow-badge-red">MUERTO</span>
{% elif status == 'SLOW_STORE' or status == 'SLOW' %}
<span class="slow-badge slow-badge-amber">LENTO</span>
{% elif status == 'HEALTHY' %}
<span class="slow-badge slow-badge-green">SALUDABLE</span>
{% else %}
<span class="slow-badge slow-badge-gray">{{ status }}</span>
{% endif %}
{% endmacro %}

{% block content %}
<div class="slow-wrap">
  <div class="slow-header">
    <h1 class="slow-title">Stock Lento & Reasignación Inteligente</h1>
    <p class="slow-subtitle">Identifica inventario muerto, lento o saludable y genera transferencias óptimas</p>
  </div>

  {% if run_info %}
  <div class="slow-alert slow-alert-info">
    <div class="slow-alert-icon"><i class="bi bi-check-circle-fill"></i></div>
    <div class="slow-alert-content">
      <strong>Último análisis:</strong> {{ run_info.created_at.strftime('%Y-%m-%d %H:%M') if run_info.created_at else 'N/A' }}
      <span class="slow-alert-meta">ID: {{ run_info.run_id[:8] }}...</span>
    </div>
  </div>
  {% endif %}

  <div class="slow-card slow-params-card">
    <div class="slow-card-header">
      <i class="bi bi-sliders me-2"></i>Parámetros de Análisis
    </div>
    <div class="slow-card-body">
      <form method="POST" action="{{ url_for('slow_stock') }}" id="slowStockForm"
            data-loader="true"
            data-loader-title="Analizando Stock Lento"
            data-loader-msg="Evaluando ciclo de vida de productos y generando sugerencias..."
            data-loader-icon="store-transfer">
        
        <div class="slow-params-grid">
          <div class="slow-field">
            <label class="slow-label">Días muerto (tienda)</label>
            <input type="number" name="dead_days_store" class="form-control" value="{{ default_params.DEAD_DAYS_STORE }}">
            <small class="text-muted">Sin venta = muerto</small>
          </div>
          <div class="slow-field">
            <label class="slow-label">Días mín lento (tienda)</label>
            <input type="number" name="slow_min_days_store" class="form-control" value="{{ default_params.SLOW_MIN_DAYS_STORE }}">
            <small class="text-muted">Para calificar lento</small>
          </div>
          <div class="slow-field">
            <label class="slow-label">Días muerto (global)</label>
            <input type="number" name="dead_days_global" class="form-control" value="{{ default_params.DEAD_DAYS_GLOBAL }}">
            <small class="text-muted">Sin venta global = muerto</small>
          </div>
          <div class="slow-field">
            <label class="slow-label">Cobertura mín (semanas)</label>
            <input type="number" step="0.5" name="min_woc" class="form-control" value="{{ default_params.MIN_WOC }}">
            <small class="text-muted">WOC mínimo saludable</small>
          </div>
          <div class="slow-field">
            <label class="slow-label">Cobertura máx (semanas)</label>
            <input type="number" step="0.5" name="max_woc" class="form-control" value="{{ default_params.MAX_WOC }}">
            <small class="text-muted">WOC máximo saludable</small>
          </div>
        </div>

        <div class="slow-params-grid slow-params-grid-row2">
          <div class="slow-field">
            <label class="slow-label">Tasa mín receptor</label>
            <input type="number" step="0.1" name="receiver_min_rate" class="form-control" value="{{ default_params.RECEIVER_MIN_RATE }}">
            <small class="text-muted">Ventas/sem para recibir</small>
          </div>
          <div class="slow-field">
            <label class="slow-label">WOC objetivo receptor</label>
            <input type="number" step="0.1" name="target_receiver_woc" class="form-control" value="{{ default_params.TARGET_RECEIVER_WOC }}">
            <small class="text-muted">Semanas cobertura meta</small>
          </div>
        </div>

        <div class="slow-actions">
          {% if current_user.has_permission('slow_stock:run') %}
          <button type="submit" class="btn slow-btn-primary">
            <i class="bi bi-play-circle me-1"></i>Ejecutar Análisis
          </button>
          {% endif %}
          
          {% if results %}
          <a href="{{ url_for('export_slow_stock', export_type='store') }}" class="btn slow-btn-secondary">
            <i class="bi bi-download me-1"></i>Exportar Tiendas
          </a>
          <a href="{{ url_for('export_slow_stock', export_type='transfers') }}" class="btn slow-btn-secondary">
            <i class="bi bi-download me-1"></i>Exportar Transferencias
          </a>
          <a href="{{ url_for('export_slow_stock', export_type='cd') }}" class="btn slow-btn-secondary">
            <i class="bi bi-download me-1"></i>Exportar CD
          </a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="slow-params-hint">
      <i class="bi bi-info-circle me-1"></i>Los parámetros determinan qué SKUs califican como muertos, lentos o saludables según días sin venta y cobertura.
    </div>
  </div>

  {% if results %}
  <div class="slow-kpi-row">
    <div class="slow-kpi-card slow-kpi-red">
      <div class="slow-kpi-badge">
        <i class="bi bi-x-octagon"></i>
      </div>
      <div class="slow-kpi-content">
        <div class="slow-kpi-value">{{ results.store_analysis|selectattr('status', 'equalto', 'DEAD_STORE')|list|length }}</div>
        <div class="slow-kpi-label">SKU-Tienda Muertos</div>
      </div>
      <div class="slow-kpi-deco"></div>
    </div>
    <div class="slow-kpi-card slow-kpi-amber">
      <div class="slow-kpi-badge">
        <i class="bi bi-hourglass-split"></i>
      </div>
      <div class="slow-kpi-content">
        <div class="slow-kpi-value">{{ results.store_analysis|selectattr('status', 'equalto', 'SLOW_STORE')|list|length }}</div>
        <div class="slow-kpi-label">SKU-Tienda Lentos</div>
      </div>
      <div class="slow-kpi-deco"></div>
    </div>
    <div class="slow-kpi-card slow-kpi-green">
      <div class="slow-kpi-badge">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="slow-kpi-content">
        <div class="slow-kpi-value">{{ results.store_analysis|selectattr('status', 'equalto', 'HEALTHY')|list|length }}</div>
        <div class="slow-kpi-label">SKU-Tienda Saludables</div>
      </div>
      <div class="slow-kpi-deco"></div>
    </div>
    <div class="slow-kpi-card slow-kpi-purple">
      <div class="slow-kpi-badge">
        <i class="bi bi-arrow-left-right"></i>
      </div>
      <div class="slow-kpi-content">
        <div class="slow-kpi-value">{{ results.transfers|length }}</div>
        <div class="slow-kpi-label">Transferencias Sugeridas</div>
      </div>
      <div class="slow-kpi-deco"></div>
    </div>
  </div>

  <div class="slow-filter-card">
    <div class="slow-filter-row">
      <div class="slow-filter-field">
        <label class="slow-filter-label">Buscar SKU/Producto</label>
        <input type="text" class="form-control form-control-sm" id="skuSearch" placeholder="Buscar..." value="{{ sku_search }}">
      </div>
      <div class="slow-filter-field">
        <label class="slow-filter-label">Tienda</label>
        <select class="form-select form-select-sm" id="storeFilter">
          <option value="">Todas</option>
          {% for store in stores %}
          <option value="{{ store.name }}" {% if store_filter == store.name %}selected{% endif %}>{{ store.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="slow-filter-field">
        <label class="slow-filter-label">Clasificación</label>
        <select class="form-select form-select-sm" id="statusFilter">
          <option value="">Todas</option>
          <option value="DEAD_STORE" {% if status_filter == 'DEAD_STORE' %}selected{% endif %}>Muerto</option>
          <option value="SLOW_STORE" {% if status_filter == 'SLOW_STORE' %}selected{% endif %}>Lento</option>
          <option value="HEALTHY" {% if status_filter == 'HEALTHY' %}selected{% endif %}>Saludable</option>
        </select>
      </div>
      <div class="slow-filter-actions">
        <button type="button" class="btn btn-sm slow-btn-primary" onclick="applyFilters()">
          <i class="bi bi-funnel me-1"></i>Filtrar
        </button>
        <button type="button" class="btn btn-sm slow-btn-secondary" onclick="clearFilters()">
          <i class="bi bi-x-circle me-1"></i>Limpiar
        </button>
      </div>
    </div>
  </div>

  <div class="slow-tabs">
    <button class="slow-tab active" data-tab="stores">
      <i class="bi bi-shop me-1"></i>Tiendas ({{ results.store_analysis|length }})
    </button>
    <button class="slow-tab" data-tab="global">
      <i class="bi bi-globe me-1"></i>Global ({{ results.global_analysis|length if results.global_analysis else 0 }})
    </button>
    <button class="slow-tab" data-tab="transfers">
      <i class="bi bi-arrow-left-right me-1"></i>Transferencias ({{ results.transfers|length }})
    </button>
    <button class="slow-tab" data-tab="cd">
      <i class="bi bi-box-seam me-1"></i>CD ({{ results.cd_analysis|length }})
    </button>
  </div>

  <div class="slow-tab-content" id="tab-stores">
    <div class="slow-card slow-table-card">
      <div class="slow-table-header">
        <div class="slow-table-title-wrap">
          <div class="slow-table-title">
            <i class="bi bi-shop me-2"></i>Análisis por Tienda
          </div>
        </div>
        <a href="{{ url_for('export_slow_stock', export_type='store') }}" class="btn btn-sm slow-btn-export">
          <i class="bi bi-download me-1"></i>Exportar
        </a>
      </div>
      <div class="slow-table-wrap">
        <table class="slow-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Tienda</th>
              <th class="text-end">Stock</th>
              <th class="text-end">Días sin venta</th>
              <th class="text-end">Venta/sem</th>
              <th class="text-end">Cobertura (sem)</th>
              <th class="text-center">Estado</th>
            </tr>
          </thead>
          <tbody>
            {% if slow_pag and slow_pag.items %}
            {% for row in slow_pag.items %}
            <tr>
              <td class="text-mono">{{ row.sku }}</td>
              <td>{{ row.product_name[:30] }}{% if row.product_name|length > 30 %}...{% endif %}</td>
              <td>{{ row.store }}</td>
              <td class="text-end">{{ row.stock }}</td>
              <td class="text-end">{{ row.days_since_last_sale if row.days_since_last_sale < 9999 else '—' }}</td>
              <td class="text-end">{{ row.sales_rate }}</td>
              <td class="text-end">{{ row.coverage_weeks if row.coverage_weeks else '—' }}</td>
              <td class="text-center">{{ status_badge(row.status) }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="8">
                <div class="slow-empty-table">
                  <i class="bi bi-inbox"></i>
                  <div class="slow-empty-table-title">Sin resultados</div>
                  <div class="slow-empty-table-hint">No hay SKUs que coincidan con los filtros aplicados</div>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if slow_pag and slow_pag.total > 0 %}
      <div class="slow-table-footer">
        {{ pagination_controls(slow_pag, 'slow_page') }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="slow-tab-content" id="tab-global" style="display:none;">
    <div class="slow-card slow-table-card">
      <div class="slow-table-header">
        <div class="slow-table-title-wrap">
          <div class="slow-table-title">
            <i class="bi bi-globe me-2"></i>Análisis Global por SKU
          </div>
          <div class="slow-table-hint">
            <i class="bi bi-info-circle me-1"></i>Agregado de todas las tiendas + CD
          </div>
        </div>
      </div>
      <div class="slow-table-wrap">
        <table class="slow-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th class="text-end">Stock Total</th>
              <th class="text-end">Stock CD</th>
              <th class="text-end">Stock Tiendas</th>
              <th class="text-end">Días sin venta</th>
              <th class="text-end">Venta/sem</th>
              <th class="text-end">Cobertura (sem)</th>
              <th class="text-center">Estado</th>
            </tr>
          </thead>
          <tbody>
            {% if global_pag and global_pag.items %}
            {% for row in global_pag.items %}
            <tr>
              <td class="text-mono">{{ row.sku }}</td>
              <td>{{ row.product_name[:30] }}{% if row.product_name|length > 30 %}...{% endif %}</td>
              <td class="text-end fw-bold">{{ row.stock }}</td>
              <td class="text-end">{{ row.stock_cd }}</td>
              <td class="text-end">{{ row.stock_stores }}</td>
              <td class="text-end">{{ row.days_since_last_sale if row.days_since_last_sale else '—' }}</td>
              <td class="text-end">{{ row.sales_rate }}</td>
              <td class="text-end">{{ row.coverage_weeks if row.coverage_weeks else '—' }}</td>
              <td class="text-center">{{ status_badge(row.status) }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="9">
                <div class="slow-empty-table">
                  <i class="bi bi-globe"></i>
                  <div class="slow-empty-table-title">Sin resultados</div>
                  <div class="slow-empty-table-hint">No hay SKUs que coincidan con los filtros aplicados</div>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if global_pag and global_pag.total > 0 %}
      <div class="slow-table-footer">
        {{ pagination_controls(global_pag, 'global_page') }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="slow-tab-content" id="tab-transfers" style="display:none;">
    <div class="slow-card slow-table-card">
      <div class="slow-table-header">
        <div class="slow-table-title-wrap">
          <div class="slow-table-title">
            <i class="bi bi-arrow-left-right me-2"></i>Sugerencias de Transferencia
          </div>
          <div class="slow-table-hint">
            <i class="bi bi-arrow-right me-1"></i>De tiendas con stock muerto/lento → a tiendas con demanda activa
          </div>
        </div>
        <a href="{{ url_for('export_slow_stock', export_type='transfers') }}" class="btn btn-sm slow-btn-export">
          <i class="bi bi-download me-1"></i>Exportar
        </a>
      </div>
      <div class="slow-table-wrap">
        <table class="slow-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>De Tienda</th>
              <th>A Tienda</th>
              <th class="text-end">Cantidad</th>
              <th class="text-center">Estado Origen</th>
              <th class="text-end">Venta/sem Destino</th>
              <th class="text-end">WOC Destino</th>
            </tr>
          </thead>
          <tbody>
            {% if sug_pag and sug_pag.items %}
            {% for row in sug_pag.items %}
            <tr>
              <td class="text-mono">{{ row.sku }}</td>
              <td>{{ row.product_name[:25] }}{% if row.product_name|length > 25 %}...{% endif %}</td>
              <td>{{ row.from_store }}</td>
              <td>{{ row.to_store }}</td>
              <td class="text-end fw-bold">{{ row.qty }}</td>
              <td class="text-center">{{ status_badge(row.donor_status) }}</td>
              <td class="text-end">{{ row.receiver_sales_rate }}</td>
              <td class="text-end">{{ row.receiver_woc }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="8">
                <div class="slow-empty-table">
                  <i class="bi bi-arrow-left-right"></i>
                  <div class="slow-empty-table-title">Sin transferencias</div>
                  <div class="slow-empty-table-hint">No hay transferencias sugeridas en este análisis</div>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if sug_pag and sug_pag.total > 0 %}
      <div class="slow-table-footer">
        {{ pagination_controls(sug_pag, 'sug_page') }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="slow-tab-content" id="tab-cd" style="display:none;">
    <div class="slow-card slow-table-card">
      <div class="slow-table-header">
        <div class="slow-table-title-wrap">
          <div class="slow-table-title">
            <i class="bi bi-box-seam me-2"></i>Stock Muerto en Centro de Distribución
          </div>
        </div>
        <a href="{{ url_for('export_slow_stock', export_type='cd') }}" class="btn btn-sm slow-btn-export">
          <i class="bi bi-download me-1"></i>Exportar
        </a>
      </div>
      <div class="slow-table-wrap">
        <table class="slow-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th class="text-end">Stock CD</th>
              <th class="text-end">Días sin venta global</th>
              <th class="text-end">Días sin compra</th>
              <th class="text-center">Estado</th>
              <th>Recomendación</th>
            </tr>
          </thead>
          <tbody>
            {% if cd_pag and cd_pag.items %}
            {% for row in cd_pag.items %}
            <tr>
              <td class="text-mono">{{ row.sku }}</td>
              <td>{{ row.product_name[:30] }}{% if row.product_name|length > 30 %}...{% endif %}</td>
              <td class="text-end">{{ row.stock_cd }}</td>
              <td class="text-end">{{ row.days_since_last_sale_global if row.days_since_last_sale_global else '—' }}</td>
              <td class="text-end">{{ row.days_since_last_purchase if row.days_since_last_purchase else '—' }}</td>
              <td class="text-center">{{ status_badge(row.status) }}</td>
              <td>{{ row.recommendation }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="7">
                <div class="slow-empty-table">
                  <i class="bi bi-box-seam"></i>
                  <div class="slow-empty-table-title">Sin SKUs muertos en CD</div>
                  <div class="slow-empty-table-hint">No hay productos clasificados como muertos en el centro de distribución</div>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if cd_pag and cd_pag.total > 0 %}
      <div class="slow-table-footer">
        {{ pagination_controls(cd_pag, 'cd_page') }}
      </div>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="slow-empty-state">
    <div class="slow-empty-icon"><i class="bi bi-hourglass"></i></div>
    <div class="slow-empty-title">Sin datos de análisis</div>
    <div class="slow-empty-text">Haz clic en "Ejecutar Análisis" para identificar stock muerto, lento y saludable.</div>
  </div>
  {% endif %}

  <div class="slow-card slow-upload-card">
    <div class="slow-card-header">
      <i class="bi bi-upload me-2"></i>Cargar Datos de Ciclo de Vida (Opcional)
    </div>
    <div class="slow-card-body">
      <p class="slow-upload-hint">
        Sube un archivo Excel/CSV con fechas de última compra o última venta para mejorar la precisión del análisis.
      </p>
      <form method="POST" action="{{ url_for('upload_lifecycle') }}" enctype="multipart/form-data" class="slow-upload-form">
        <div class="slow-upload-row">
          <select name="upload_type" class="form-select slow-upload-select">
            <option value="global">Global (última compra/venta por SKU)</option>
            <option value="store">Por tienda (última venta por SKU-tienda)</option>
          </select>
          <input type="file" name="file" accept=".csv,.xlsx,.xls" class="form-control slow-upload-file">
          <button type="submit" class="btn slow-btn-secondary">
            <i class="bi bi-upload me-1"></i>Subir
          </button>
        </div>
      </form>
      <div class="slow-upload-formats">
        <strong>Formato Global:</strong> sku, last_purchase_date, last_sale_date_global<br>
        <strong>Formato Por tienda:</strong> sku, store, last_sale_date_store
      </div>
    </div>
  </div>
</div>

<script>
function updateParam(param, value) {
  const url = new URL(window.location.href);
  url.searchParams.set(param, value);
  window.location.href = url.toString();
}

function applyFilters() {
  const url = new URL(window.location.href);
  url.searchParams.set('sku_search', document.getElementById('skuSearch').value);
  url.searchParams.set('store_filter', document.getElementById('storeFilter').value);
  url.searchParams.set('status_filter', document.getElementById('statusFilter').value);
  url.searchParams.set('slow_page', 1);
  url.searchParams.set('global_page', 1);
  window.location.href = url.toString();
}

function clearFilters() {
  const url = new URL(window.location.href);
  url.searchParams.delete('sku_search');
  url.searchParams.delete('store_filter');
  url.searchParams.delete('status_filter');
  url.searchParams.set('slow_page', 1);
  url.searchParams.set('global_page', 1);
  window.location.href = url.toString();
}

function switchTab(tabId) {
  document.querySelectorAll('.slow-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.slow-tab-content').forEach(c => c.style.display = 'none');
  document.querySelector('.slow-tab[data-tab="' + tabId + '"]').classList.add('active');
  document.getElementById('tab-' + tabId).style.display = 'block';
  const url = new URL(window.location.href);
  url.searchParams.set('tab', tabId);
  history.replaceState(null, '', url.toString());
}

document.querySelectorAll('.slow-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    switchTab(this.getAttribute('data-tab'));
  });
});

document.getElementById('skuSearch')?.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    applyFilters();
  }
});

(function() {
  const params = new URLSearchParams(window.location.search);
  const tab = params.get('tab');
  if (tab && document.getElementById('tab-' + tab)) {
    switchTab(tab);
  }
})();
</script>
{% endblock %}
